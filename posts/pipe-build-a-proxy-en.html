
<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8" />
<title>abcdlsj</title>
<meta name="description" content="Enjoy Focus!" />
<meta name="author" content="Author" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="stylesheet" href="/static/style.css" />

  </head>
  <body class="container">
    <div class="navbar">
<nav class="navbar">
  
  <ul>
    <li>
      <a href="/" class="menu">#Home</a>
    </li>
  </ul>
  
  <ul>
    <li>
      <a href="/about" class="menu">#About</a>
    </li>
  </ul>
  
</nav>
</div>
    <hr class="divider" />
    <h1 class="post-title">Pipe - Build a tunnel tool like `frp` or `ngrok`</h1>
    <div class="post-meta">
      <div class="post-date">Date: 2023-11-04T22:47:37+08:00</div>
      <nav class="post-tags">
        
        <a href="/tags/Network.html" class="tag">#Network</a>
        
        <a href="/tags/Weekly.html" class="tag">#Weekly</a>
        
        <a href="/tags/Tunnel.html" class="tag">#Tunnel</a>
        
      </nav>
    </div>
    <hr class="divider" />
    <main class="post-content">
      <article><h1>Table of Contents</h1>
<ul>
<li>
<ul>
<li>
<a href="#background">Background</a></li>
<li>
<a href="#how-it-works">How it works</a></li>
<li>
<a href="#codes">Codes</a><ul>
<li>
<a href="#structure">Structure</a></li>
<li>
<a href="#auth">Auth</a></li>
<li>
<a href="#send-is-used-here-and-the-implementation-of-message-is-described-next">Send' is used here, and the implementation of message is described next.</a><ul>
<li>
<a href="#format">format</a></li>
<li>
<a href="#packunpack">pack/unpack</a></li>
<li>
<a href="#sendrecv">send/recv</a></li>
</ul>
</li>
<li>
<a href="#forward">Forward</a></li>
<li>
<a href="#exchange">Exchange</a></li>
<li>
<a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li>
<a href="#feat">Feat</a></li>
<li>
<a href="#auto-subdomain-https">Auto subdomain https</a><ul>
<li>
<a href="#deploy-at-flyio">Deploy at fly.io</a></li>
<li>
<a href="#udp">UDP</a></li>
<li>
<a href="#speed-limit">Speed limit</a></li>
</ul>
</li>
<li>
<a href="#done">Done</a></li>
<li>
<a href="#refs">refs</a></li>
</ul>
</li>
</ul>
<h2 id="background">Background</h2>
<p><strong>A simple forwarding tool</strong><br>
The communication between services in the company's internal service framework is realized by connecting the <code>UNIX domain</code> on which each machine's <code>Agent</code> listens, and in the company's container cluster environment, the <code>Agent</code> is started.<br>
But as a local environment, there is no <code>Agent</code> condition, so the local startup service is to use <code>socat</code> to forward the local <code>UNIX domain</code> traffic to the remote <code>TCP agent</code> to start the service (there is nothing special about the remote <code>TCP agent</code>, the traffic is also forwarded to the machine <code>Agent</code>).<br>
We usually use <code>socat -d -d -d UNIX-LISTEN:/tmp/xxx.sock,reuseaddr,fork TCP:agent-tcp.xxxx.io:9299</code>.</p>
<blockquote>
<p><code>socat</code> is a swiss army knife type tool, very powerful.</p>
</blockquote>
<p>Then I thought that since the principle is so simple, it should be very simple to implement a forwarding tool with similar functionality. With the help of <code>io.Copy()</code> and the <code>net</code> package, I implemented the code in a short time, the total amount of code is less than 50 lines, but it's very practical and very fast to start up (even slightly faster than <code>socat</code> in real life).</p>
<p><strong>Remote Port Forwarding</strong><br>
Later, I thought I could implement a tool similar to <code>frp</code> and <code>ngrok</code>, and the core code is not too far from a simple forwarding tool, so I started to write it.<br>
The realization of the process did not draw too much code from other projects, many places are encountered problems and then go to check, so it is worthwhile to write a blog to record, there has been no idea to write, here to record the ideas and core code.<br>
Code is the beginning of the year or the end of last year to write the first version, after changing some, now and the initial version compared to some complexity.</p>
<blockquote>
<p>The first version only realized <code>TCP</code> forwarding, and contained <code>Caddy</code> to do <code>Auto Subdomain https</code>, less than <code>1000</code> lines of code. It was optimized to support <code>TCP/UDP</code> protocols, so this article only covers <code>TCP/UDP</code> implementation (but most other protocols are similar).<br>
Incidentally, <code>GitHub</code> has many similar implementations, such as <a href="https://github.com/ekzhang/bore">ekzhang/bore</a> and <a href="https://github.com/rapiz1/rathole/">rapiz1/rathole</a> (<code>Tokio</code> is very powerful). Tokio<code>is so powerful that I couldn't resist rewriting it in</code>Rust` :P.</p>
</blockquote>
<p>All the code is in <a href="https://github.com/abcdlsj/pipe/tree/484084da8b9edb99fb39e5d7561cc94d16d7031c">abcdlsj/pipe</a> (version at the time of writing)</p>
<h2 id="how-it-works">How it works</h2>
<p>Implementing <strong>Remote Port Forwarding</strong></p>
<p>Suppose you have a Server and a Client. The IP of the Server can be accessed directly from the public network, while the IP of the Client cannot, and the Client can access the Server.</p>
<p>We would like to have a way to establish an association between the Server port and the Client port, and forward access to the Server port to the corresponding port on the Client, so that accessing the Server's port through the public network is equivalent to accessing the Client's port.</p>
<p><strong>How to implement this forwarding?</strong><br>
First of all, the Server side should communicate with the Client side, for the inbound request from the Server side, the request and the Client side will be <strong>binding</strong>, and the Client will be <strong>binding</strong> to the target port and the communication connection of the Server side. <strong>Bind</strong> means <code>io.Copy()</code> for both connections.</p>
<p>Let's assume that our Server communication port is 8910, and we want to penetrate the Client's port 3000 to the Server's port 9000.<br>
That's pretty much the final structure:</p>
<div class="d2"><?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" d2Version="v0.5.0-HEAD" preserveAspectRatio="xMinYMin meet" viewBox="0 0 1024 941"><svg id="d2-svg" class="d2-2119188561" width="1024" height="941" viewBox="-101 -100 1024 941"><rect x="-101.000000" y="-100.000000" width="1024.000000" height="941.000000" rx="0.000000" class=" fill-N7" stroke-width="0" /><style type="text/css"><![CDATA[
.d2-2119188561 .text {
	font-family: "d2-2119188561-font-regular";
}
@font-face {
	font-family: d2-2119188561-font-regular;
	src: url("data:application/font-woff;base64,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");
}
.d2-2119188561 .text-bold {
	font-family: "d2-2119188561-font-bold";
}
@font-face {
	font-family: d2-2119188561-font-bold;
	src: url("data:application/font-woff;base64,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");
}
.d2-2119188561 .text-italic {
	font-family: "d2-2119188561-font-italic";
}
@font-face {
	font-family: d2-2119188561-font-italic;
	src: url("data:application/font-woff;base64,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");
}]]></style><style type="text/css"><![CDATA[.shape {
  shape-rendering: geometricPrecision;
  stroke-linejoin: round;
}
.connection {
  stroke-linecap: round;
  stroke-linejoin: round;
}
.blend {
  mix-blend-mode: multiply;
  opacity: 0.5;
}

		.d2-2119188561 .fill-N1{fill:#0A0F25;}
		.d2-2119188561 .fill-N2{fill:#676C7E;}
		.d2-2119188561 .fill-N3{fill:#9499AB;}
		.d2-2119188561 .fill-N4{fill:#CFD2DD;}
		.d2-2119188561 .fill-N5{fill:#DEE1EB;}
		.d2-2119188561 .fill-N6{fill:#EEF1F8;}
		.d2-2119188561 .fill-N7{fill:#FFFFFF;}
		.d2-2119188561 .fill-B1{fill:#0D32B2;}
		.d2-2119188561 .fill-B2{fill:#0D32B2;}
		.d2-2119188561 .fill-B3{fill:#E3E9FD;}
		.d2-2119188561 .fill-B4{fill:#E3E9FD;}
		.d2-2119188561 .fill-B5{fill:#EDF0FD;}
		.d2-2119188561 .fill-B6{fill:#F7F8FE;}
		.d2-2119188561 .fill-AA2{fill:#4A6FF3;}
		.d2-2119188561 .fill-AA4{fill:#EDF0FD;}
		.d2-2119188561 .fill-AA5{fill:#F7F8FE;}
		.d2-2119188561 .fill-AB4{fill:#EDF0FD;}
		.d2-2119188561 .fill-AB5{fill:#F7F8FE;}
		.d2-2119188561 .stroke-N1{stroke:#0A0F25;}
		.d2-2119188561 .stroke-N2{stroke:#676C7E;}
		.d2-2119188561 .stroke-N3{stroke:#9499AB;}
		.d2-2119188561 .stroke-N4{stroke:#CFD2DD;}
		.d2-2119188561 .stroke-N5{stroke:#DEE1EB;}
		.d2-2119188561 .stroke-N6{stroke:#EEF1F8;}
		.d2-2119188561 .stroke-N7{stroke:#FFFFFF;}
		.d2-2119188561 .stroke-B1{stroke:#0D32B2;}
		.d2-2119188561 .stroke-B2{stroke:#0D32B2;}
		.d2-2119188561 .stroke-B3{stroke:#E3E9FD;}
		.d2-2119188561 .stroke-B4{stroke:#E3E9FD;}
		.d2-2119188561 .stroke-B5{stroke:#EDF0FD;}
		.d2-2119188561 .stroke-B6{stroke:#F7F8FE;}
		.d2-2119188561 .stroke-AA2{stroke:#4A6FF3;}
		.d2-2119188561 .stroke-AA4{stroke:#EDF0FD;}
		.d2-2119188561 .stroke-AA5{stroke:#F7F8FE;}
		.d2-2119188561 .stroke-AB4{stroke:#EDF0FD;}
		.d2-2119188561 .stroke-AB5{stroke:#F7F8FE;}
		.d2-2119188561 .background-color-N1{background-color:#0A0F25;}
		.d2-2119188561 .background-color-N2{background-color:#676C7E;}
		.d2-2119188561 .background-color-N3{background-color:#9499AB;}
		.d2-2119188561 .background-color-N4{background-color:#CFD2DD;}
		.d2-2119188561 .background-color-N5{background-color:#DEE1EB;}
		.d2-2119188561 .background-color-N6{background-color:#EEF1F8;}
		.d2-2119188561 .background-color-N7{background-color:#FFFFFF;}
		.d2-2119188561 .background-color-B1{background-color:#0D32B2;}
		.d2-2119188561 .background-color-B2{background-color:#0D32B2;}
		.d2-2119188561 .background-color-B3{background-color:#E3E9FD;}
		.d2-2119188561 .background-color-B4{background-color:#E3E9FD;}
		.d2-2119188561 .background-color-B5{background-color:#EDF0FD;}
		.d2-2119188561 .background-color-B6{background-color:#F7F8FE;}
		.d2-2119188561 .background-color-AA2{background-color:#4A6FF3;}
		.d2-2119188561 .background-color-AA4{background-color:#EDF0FD;}
		.d2-2119188561 .background-color-AA5{background-color:#F7F8FE;}
		.d2-2119188561 .background-color-AB4{background-color:#EDF0FD;}
		.d2-2119188561 .background-color-AB5{background-color:#F7F8FE;}
		.d2-2119188561 .color-N1{color:#0A0F25;}
		.d2-2119188561 .color-N2{color:#676C7E;}
		.d2-2119188561 .color-N3{color:#9499AB;}
		.d2-2119188561 .color-N4{color:#CFD2DD;}
		.d2-2119188561 .color-N5{color:#DEE1EB;}
		.d2-2119188561 .color-N6{color:#EEF1F8;}
		.d2-2119188561 .color-N7{color:#FFFFFF;}
		.d2-2119188561 .color-B1{color:#0D32B2;}
		.d2-2119188561 .color-B2{color:#0D32B2;}
		.d2-2119188561 .color-B3{color:#E3E9FD;}
		.d2-2119188561 .color-B4{color:#E3E9FD;}
		.d2-2119188561 .color-B5{color:#EDF0FD;}
		.d2-2119188561 .color-B6{color:#F7F8FE;}
		.d2-2119188561 .color-AA2{color:#4A6FF3;}
		.d2-2119188561 .color-AA4{color:#EDF0FD;}
		.d2-2119188561 .color-AA5{color:#F7F8FE;}
		.d2-2119188561 .color-AB4{color:#EDF0FD;}
		.d2-2119188561 .color-AB5{color:#F7F8FE;}.appendix text.text{fill:#0A0F25}.md{--color-fg-default:#0A0F25;--color-fg-muted:#676C7E;--color-fg-subtle:#9499AB;--color-canvas-default:#FFFFFF;--color-canvas-subtle:#EEF1F8;--color-border-default:#0D32B2;--color-border-muted:#0D32B2;--color-neutral-muted:#EEF1F8;--color-accent-fg:#0D32B2;--color-accent-emphasis:#0D32B2;--color-attention-subtle:#676C7E;--color-danger-fg:red;}.sketch-overlay-B1{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-B2{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-B3{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B6{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AA2{fill:url(#streaks-dark);mix-blend-mode:overlay}.sketch-overlay-AA4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AA5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AB4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AB5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N1{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-N2{fill:url(#streaks-dark);mix-blend-mode:overlay}.sketch-overlay-N3{fill:url(#streaks-normal);mix-blend-mode:color-burn}.sketch-overlay-N4{fill:url(#streaks-normal);mix-blend-mode:color-burn}.sketch-overlay-N5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N6{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N7{fill:url(#streaks-bright);mix-blend-mode:darken}.light-code{display: block}.dark-code{display: none}]]></style><defs><pattern id="streaks-bright" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.1)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-normal" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.16)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-dark" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.32)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-darker" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(255, 255, 255, 0.24)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern></defs><g id="Flow"><g class="shape" ><path d="M-0.640124 -0.231351 L822.418220 0.724412 L822.101479 698.293629 L0.370222 699.612993" transform="translate(0.000000 41.000000)" class="shape stroke-B1 fill-B4" style="stroke-width:2;" /><path d="M0.342905 0.385553 C164.275793 -0.867400, 328.583341 -2.024734, 821.682562 0.156934 M-0.259466 0.105839 C182.127036 -2.513483, 363.937067 -2.741352, 821.767850 0.301126 M822.614681 -0.699773 C819.857613 152.526215, 820.134228 303.411907, 822.556219 698.652258 M822.119071 -0.319709 C823.857139 187.264585, 823.466552 375.228190, 822.162750 699.140897 M822.421120 698.914623 C645.129395 705.428156, 466.761011 705.210746, 0.734582 698.838590 M821.622629 698.942507 C512.964707 699.858210, 204.318082 699.749624, 0.375579 699.016737 M-0.288241 698.887412 C-3.554001 497.908934, -4.246974 298.112572, 0.236720 -0.482432 M0.087182 699.399289 C-3.750618 444.465803, -3.548196 190.094561, 0.176296 0.395212" transform="translate(0.000000 41.000000)" class="shape stroke-B1 fill-B4" style="stroke-width:2;" /><rect width="822.000000" height="699.000000" transform="translate(0.000000 41.000000)" class=" sketch-overlay-B4" /></g><text x="411.000000" y="28.000000" class="text fill-N1" style="text-anchor:middle;font-size:28px">Flow</text></g><g id="Flow.server"><g class="shape" ><path d="M-1.600310 -0.578379 L751.045551 1.811030 L750.253697 128.234072 L0.925556 131.532483" transform="translate(49.000000 293.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.342905 0.385553 C149.875470 -0.750670, 299.782693 -1.908004, 749.682562 0.156934 M-0.259466 0.105839 C166.189699 -2.264814, 332.062394 -2.492683, 749.767850 0.301126 M751.536704 -1.749433 C749.898428 29.505557, 750.589964 54.909808, 751.390547 129.130645 M750.297677 -0.799274 C751.060496 34.031330, 750.084027 69.810208, 750.406876 130.352243 M750.421120 129.914623 C588.657813 135.858343, 425.817847 135.640933, 0.734582 129.838590 M749.622629 129.942507 C468.030413 130.792282, 186.449494 130.683696, 0.375579 130.016737 M-0.720604 129.718532 C-0.626143 91.186407, -2.358576 55.609573, 0.591800 -1.206080 M0.217956 130.998223 C-2.375333 82.056446, -1.869278 34.520280, 0.440740 0.988030" transform="translate(49.000000 293.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="750.000000" height="130.000000" transform="translate(49.000000 293.000000)" class=" sketch-overlay-B5" /></g><text x="424.000000" y="281.000000" class="text fill-N1" style="text-anchor:middle;font-size:24px">server</text></g><g id="Flow.client"><g class="shape" ><path d="M-1.600310 -0.578379 L740.045551 1.811030 L739.253697 128.234072 L0.925556 131.532483" transform="translate(53.000000 580.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.342905 0.385553 C147.675420 -0.732836, 295.382595 -1.890170, 738.682562 0.156934 M-0.259466 0.105839 C163.754829 -2.226823, 327.192653 -2.454692, 738.767850 0.301126 M740.536704 -1.749433 C738.898428 29.505557, 739.589964 54.909808, 740.390547 129.130645 M739.297677 -0.799274 C740.060496 34.031330, 739.084027 69.810208, 739.406876 130.352243 M739.421120 129.914623 C580.030211 135.771288, 419.562642 135.553878, 0.734582 129.838590 M738.622629 129.942507 C461.165451 130.782209, 183.719571 130.673624, 0.375579 130.016737 M-0.720604 129.718532 C-0.626143 91.186407, -2.358576 55.609573, 0.591800 -1.206080 M0.217956 130.998223 C-2.375333 82.056446, -1.869278 34.520280, 0.440740 0.988030" transform="translate(53.000000 580.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="739.000000" height="130.000000" transform="translate(53.000000 580.000000)" class=" sketch-overlay-B5" /></g><text x="422.500000" y="568.000000" class="text fill-N1" style="text-anchor:middle;font-size:24px">client</text></g><g id="Flow.user"><g class="shape" ><path d="M-1.600310 -0.578379 L78.045551 1.811030 L77.253697 64.234072 L0.925556 67.532483" transform="translate(250.000000 70.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.857263 0.963884 C15.080592 0.851080, 30.240568 -2.042255, 76.206405 0.392335 M-0.648665 0.264598 C17.483548 0.148857, 34.174583 -0.420815, 76.419625 0.752815 M78.536704 -1.749433 C77.489431 15.585410, 78.180967 27.069513, 78.390547 65.130645 M77.297677 -0.799274 C77.657560 16.854002, 76.681091 35.455552, 77.406876 66.352243 M78.052801 65.786559 C61.423647 67.330430, 42.102845 66.786905, 1.836456 65.596476 M76.056573 65.856267 C47.966857 66.440085, 19.905385 66.168621, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(250.000000 70.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="77.000000" height="66.000000" transform="translate(250.000000 70.000000)" class=" sketch-overlay-B5" /></g><text x="288.500000" y="108.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">user</text></g><g id="Flow.server.remoteport 9000"><g class="shape" ><path d="M-1.600310 -0.578379 L164.045551 1.811030 L163.253697 64.234072 L0.925556 67.532483" transform="translate(207.000000 325.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><path d="M0.857263 0.963884 C32.280978 0.502511, 64.641341 -2.390824, 162.206405 0.392335 M-0.648665 0.264598 C36.519810 -0.593693, 72.247109 -1.163366, 162.419625 0.752815 M164.536704 -1.749433 C163.489431 15.585410, 164.180967 27.069513, 164.390547 65.130645 M163.297677 -0.799274 C163.657560 16.854002, 162.681091 35.455552, 163.406876 66.352243 M164.052801 65.786559 C128.875814 69.031956, 91.007179 68.488431, 1.836456 65.596476 M162.056573 65.856267 C101.638375 66.636955, 41.248420 66.365491, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(207.000000 325.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><rect width="163.000000" height="66.000000" transform="translate(207.000000 325.000000)" class=" sketch-overlay-B6" /></g><text x="288.500000" y="363.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">remoteport 9000</text></g><g id="Flow.client.localport 3000"><g class="shape" ><path d="M-1.600310 -0.578379 L147.045551 1.811030 L146.253697 64.234072 L0.925556 67.532483" transform="translate(215.000000 612.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><path d="M0.857263 0.963884 C28.880902 0.571414, 57.841189 -2.321921, 145.206405 0.392335 M-0.648665 0.264598 C32.756828 -0.446910, 64.721144 -1.016583, 145.419625 0.752815 M147.536704 -1.749433 C146.489431 15.585410, 147.180967 27.069513, 147.390547 65.130645 M146.297677 -0.799274 C146.657560 16.854002, 145.681091 35.455552, 146.406876 66.352243 M147.052801 65.786559 C115.542246 68.695607, 81.340043 68.152083, 1.836456 65.596476 M145.056573 65.856267 C91.028889 66.598039, 37.029448 66.326575, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(215.000000 612.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><rect width="146.000000" height="66.000000" transform="translate(215.000000 612.000000)" class=" sketch-overlay-B6" /></g><text x="288.000000" y="650.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">localport 3000</text></g><g id="Flow.(client &lt;-&gt; server)[0]"><marker id="mk-2451250203" markerWidth="10.000000" markerHeight="12.000000" refX="3.000000" refY="6.000000" viewBox="0.000000 0.000000 10.000000 12.000000" orient="auto" markerUnits="userSpaceOnUse"> <polygon points="10.000000,0.000000 0.000000,6.000000 10.000000,12.000000" class="connection fill-B1" stroke-width="2" /> </marker><marker id="mk-3488378134" markerWidth="10.000000" markerHeight="12.000000" refX="7.000000" refY="6.000000" viewBox="0.000000 0.000000 10.000000 12.000000" orient="auto" markerUnits="userSpaceOnUse"> <polygon points="0.000000,0.000000 10.000000,6.000000 0.000000,12.000000" class="connection fill-B1" stroke-width="2" /> </marker><path d="M445.500044 540.170064 M445.500044 540.170064 C446.981942 496.040135, 447.081585 471.519926, 446.702656 427.428631 M444.634962 539.773267 C446.214643 496.739656, 445.689168 472.130736, 446.745209 426.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(446.500000 541.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(446.500000 541.000000) rotate(90.00000250447816)" /> <path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(446.500000 427.000000) rotate(-90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(446.500000 427.000000) rotate(-90.00000250447816)" /><text x="446.500000" y="490.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">1. Create control connection, auth, send request forward...</text></g><g id="Flow.(user -&gt; server)[0]"><path d="M287.000044 137.670064 M287.000044 137.670064 C288.481942 184.740117, 288.581585 216.119932, 288.202656 290.428631 M286.134962 137.273267 C287.714643 185.439638, 287.189168 216.730742, 288.245209 289.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(288.000000 290.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(288.000000 290.000000) rotate(90.00000250447816)" /><text x="288.000000" y="221.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">2. View remote port 9000</text></g><g id="Flow.(server -&gt; server)[0]"><path d="M370.479972 363.752418 M370.479972 363.752418 C489.714944 347.613133, 527.231609 343.219938, 538.077656 343.928631 M369.614890 363.355621 C488.947645 348.312654, 525.839192 343.830748, 538.120209 342.516898 M538.120209 342.516898 C549.186368 343.744026, 563.485604 350.852821, 575.730468 360.813699 M537.295232 342.055176 C548.006580 344.186815, 564.834890 351.219031, 575.576144 360.960440 M575.576144 360.960440 C586.081313 369.583951, 586.830784 382.509098, 574.470620 393.695273 M575.873822 360.161166 C585.597945 369.934134, 587.024587 383.540310, 575.593556 391.924853 M575.593556 391.924853 C565.055238 403.426394, 489.126281 405.741227, 372.616581 388.960405 M575.497042 391.083056 C563.813776 403.848901, 488.936657 405.369086, 372.999511 389.847061" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(373.459857 388.699276) rotate(-171.875850161063)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(373.459857 388.699276) rotate(-171.875850161063)" /><text x="586.500000" y="381.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">3. io.Copy() control connection 8910 and user connection</text></g><g id="Flow.(server -&gt; client)[0]"><path d="M128.500044 424.670064 M128.500044 424.670064 C129.981942 471.740117, 130.081585 503.119932, 129.702656 577.428631 M127.634962 424.273267 C129.214643 472.439638, 128.689168 503.730742, 129.745209 576.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(129.500000 577.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(129.500000 577.000000) rotate(90.00000250447816)" /><text x="129.500000" y="508.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">4. Send start proxy request</text></g><g id="Flow.(client -&gt; client)[0]"><path d="M361.978561 651.590723 M361.978561 651.590723 C481.747933 634.782140, 519.431561 630.219938, 530.327656 630.928631 M361.113479 651.193926 C480.980634 635.481661, 518.039144 630.830748, 530.370209 629.516898 M530.370209 629.516898 C541.486416 630.744026, 555.852608 637.852791, 568.147460 647.813699 M529.545232 629.055176 C540.306628 631.186815, 557.201894 638.219001, 567.993136 647.960440 M567.993136 647.960440 C578.548293 656.583981, 579.297764 669.509068, 566.887612 680.695273 M568.290814 647.161166 C578.064925 656.934164, 579.491567 670.540280, 568.010548 678.924853 M568.010548 678.924853 C557.422242 690.426424, 481.159270 692.572221, 364.113758 675.131847 M567.914034 678.083056 C556.180780 690.848931, 480.969646 692.200080, 364.496688 676.018503" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(364.957034 674.870718) rotate(-171.59456931066353)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(364.957034 674.870718) rotate(-171.59456931066353)" /><text x="578.500000" y="668.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">5. io.Copy() control connection 8910 and local connection</text></g><mask id="d2-2119188561" maskUnits="userSpaceOnUse" x="-101" y="-100" width="1024" height="941">
<rect x="-101" y="-100" width="1024" height="941" fill="white"></rect>
<rect x="383.500000" y="0.000000" width="55" height="36" fill="rgba(0,0,0,0.75)"></rect>
<rect x="392.500000" y="257.000000" width="63" height="31" fill="rgba(0,0,0,0.75)"></rect>
<rect x="395.000000" y="544.000000" width="55" height="31" fill="rgba(0,0,0,0.75)"></rect>
<rect x="272.500000" y="92.500000" width="32" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="229.500000" y="347.500000" width="118" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="237.500000" y="634.500000" width="101" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="257.000000" y="474.000000" width="379" height="21" fill="black"></rect>
<rect x="207.000000" y="205.000000" width="162" height="21" fill="black"></rect>
<rect x="402.000000" y="365.000000" width="369" height="21" fill="black"></rect>
<rect x="42.000000" y="492.000000" width="175" height="21" fill="black"></rect>
<rect x="393.000000" y="652.000000" width="371" height="21" fill="black"></rect>
</mask></svg></svg></div><p>Some things to think about are omitted here, such as:</p>
<ol>
<li>how is the <code>Auth/Handshake</code> part of the connection established between Client and Server &quot;authenticated&quot;?</li>
<li>is the message length in the <code>Control</code> connection fixed? If not, how to deal with the &quot;boundary&quot; problem?</li>
<li>when the Client receives a <code>Proxy</code> request, which connection does <code>io.Copy()</code> and how does the Server handle it?</li>
</ol>
<blockquote>
<p>For 1 and 2, you can see the detailed implementation below.<br>
For 3, if you haven't implemented a similar tool, you may not know why this problem exists, but you can see the detailed flow below (ignore the &quot;Authentication&quot; part).</p>
</blockquote>
<ol>
<li>first start the Server, &quot;listening&quot; on port 8910</li>
<li>start Client, Client and Server establish <code>Control</code> connection, and then send a <code>Forward</code> interface to tell Server to forward to port 9000. 3.</li>
<li>Server receives the <code>Forward</code> message from the <code>Control</code> connection and starts listening on port 9000, ready to receive requests from the client.</li>
</ol>
<blockquote>
<p>Does Server want to <code>Copy' the user connection and the </code>Control' connection at this point?<br>
The answer is no, because the <code>Control</code> connection will also have &quot;other&quot; traffic from the Server or Client, such as <code>Close</code>, <code>Heartbeat</code> messages, etc., which can cause problems if it is <code>Copied</code> directly to the user connection. 4.</p>
</blockquote>
<ol start="4">
<li>when a new user request arrives, the Server sends an <code>Exchange</code> message over the <code>Control</code> connection to tell the Client that there is a new user connection, and that it is ready to <code>Copy</code> the traffic. 5. the Client receives a <code>Copy</code> message over the <code>Control</code> connection, and the Client receives a <code>Close</code> message.</li>
<li>the Client receives the <code>Exchange</code> message, establishes a connection to port <code>Local 3000</code> and prepares to <code>Copy</code> the traffic.</li>
</ol>
<blockquote>
<p>The Client can't directly <code>Copy</code> the <code>Control</code> connection and the <code>Local 3000</code> connection either, as in 3.</p>
</blockquote>
<p>So we have the &quot;connection multiplexing&quot; problem, which is very common when dealing with multiple flows, and because of the direct <code>io.Copy</code> there is no way to differentiate between the flows.<br>
There are many ways to solve this problem:</p>
<ol>
<li>you can use connection multiplexing libraries such as <a href="https://github.com/hashicorp/yamux">hashicorp/yamux</a>, <code>frp</code> uses <code>yamux</code> by default.</li>
<li>differentiate messages at the application level, and process the <code>Copy</code> part as well (ps. <code>yamux</code> does the processing)</li>
<li>the simplest method, and the one used by most intranet forwarding tools, is to create a new connection if a <code>Copy</code> is needed, simple and effective.</li>
</ol>
<blockquote>
<p>The problem with method 3 is that the total number of connections to a port is limited, but normally it is enough (as long as the connection is properly <code>Close</code>, it is not a problem if there are not too many clients).</p>
</blockquote>
<p>Method 1 and method 3 are the most suitable, and <code>yamux</code> access is not complicated, I choose method 3 to realize (will take time to add <code>yamux</code> support later)</p>
<p>After choosing method 3, because the Server side can't create a new communication connection, it needs to tell the Client to create a new connection, because the Client will <code>Copy</code> <code>Local 3000</code> traffic to this new connection, so for the Server in the <code>Main Branch</code>, it needs to determine whether it is a <code>Forward</code> or <code>Exchange</code> message, and then if it is an <code>Exchange</code> message, it needs to determine if it is a <code>Exchange</code> message. Then if it is an <code>Exchange</code>, it needs to <strong>take out</strong> the user connection <code>Copy</code> to this <code>Exchange</code> message connection.</p>
<p>So in step 3, Server needs to save the user request, create the corresponding <code>Connection UUID</code>, and then send the <code>Exchange</code> message to Client with it.<br>
Step 5. Client receives the <code>Exchange</code> message, creates a new Server connection, and then first sends the <code>Exchange</code> message with the same <code>UUID</code> to Server, and then <code>Copy</code> the <code>Local 3000</code> traffic to this new Server connection.<br>
Server receives the <code>Exchange</code> message, fetches the corresponding user connection by <code>UUID</code>, and then <code>Copy</code>s the user connection traffic to this connection.</p>
<p>At this point, the process of accessing the user's &quot;one connection&quot; on port 9000 on the Server side is complete.<br>
The process is very simple, so next, I will write the code implementation of each flow</p>
<h2 id="codes">Codes</h2>
<h3 id="structure">Structure</h3>
<p>The structure is roughly like this</p>
<pre><code>.
├── client
│   ├── cfg.toml
│   ├── cmd.go
│   ├── config.go
│   └── serve.go
├── cmd
│   └── cmd.go
├── logger
│   └── log.go
├── main.go
├── pio
│   ├── encrypt.go
│   └── limit.go
├── proto
│   ├── error.go
│   ├── msg.go
│   └── packet.go
├── proxy
│   ├── buf.go
│   ├── proxy.go
│   └── udp.go
└── server
    ├── cfg.toml
    ├── cmd.go
    ├── config.go
    ├── conn
    │   ├── constant.go
    │   ├── tcp.go
    │   └── udp.go
    └── serve.go
</code></pre>
<p>A brief description:</p>
<ul>
<li>cmd: <code>cmd</code> entry, <code>cobra</code>.</li>
<li>proxy: the part that <code>Copy</code>s the two connections</li>
<li>proto: the message structure sent by <code>Control</code>, and the serialization wrapper.</li>
<li>client: Client process</li>
<li>server: Server process</li>
<li>pio: Wrapper for <code>io.Reader</code> and <code>io.Writer</code> that implements the <code>Speed limit</code> functionality.</li>
</ul>
<h3 id="auth">Auth</h3>
<p>Since we're going to bring up the main body of the code through <code>Message</code> sending, we won't write separate structures for <code>Client</code> and <code>Server</code>.</p>
<p><code>Auth</code> uses a simple token validation, the message has a <code>Token</code> and a <code>Timestamp</code> field, and the received message will be verified by <code>md5(Token + Timestamp)</code>. (At first, my implementation of <code>Client</code> and <code>Server</code> would carry the validation field in every message sent and received, which has the advantage of reducing the time of sending the Auth once, but then I saw a lot of implementations that just set up the <code>Message</code> to bring out the main code. Later, I saw that many implementations only check when the connection is established, so I changed it to check when the connection is created.)</p>
<p><code>MsgLogin</code> structure<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/msg.go#L56">proto/msg.go#L56</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> MsgLogin <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	Token     <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;token&#34;`</span>
</span></span><span style="display:flex;"><span>	Version   <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;client_version&#34;`</span>
</span></span><span style="display:flex;"><span>	Timestamp <span style="color:#458;font-weight:bold">int64</span>  <span style="color:#d14">`json:&#34;timestamp&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><strong>Client</strong> The <code>Dial</code> creation and <code>Auth</code> part is more or less like this<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L75">client/serve.go#L75</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(svraddr <span style="color:#458;font-weight:bold">string</span>, token <span style="color:#458;font-weight:bold">string</span>) (net.Conn, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	conn, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Dial</span>(<span style="color:#d14">&#34;tcp&#34;</span>, svraddr)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(conn, proto.<span style="color:#900;font-weight:bold">NewMsgLogin</span>(token)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> conn, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>There are other interesting implementations of the <code>Auth</code> part, such as <code>OpenID Connect (OIDC)</code>, which allows you to do things like <code>Sweep' authentication. **Server part** Server will </code>Listen<code>to port</code>8910<code> and wait for the Client connection to arrive (</code>8910` is used by default).<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L38-L62">server/serve.go#L38-L62</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">Run</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  listener, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Listen</span>(<span style="color:#d14">&#34;tcp&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, s.cfg.Port))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Error listening: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> listener.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		conn, err <span style="color:#000;font-weight:bold">:=</span> listener.<span style="color:#900;font-weight:bold">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Error accepting: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> s.<span style="color:#900;font-weight:bold">handle</span>(conn)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Server handle part checks <code>MsgLogin</code> and disconnects if it fails.<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L64-L79">server/serve.go#L64-L79</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handle</span>(conn net.Conn) {
</span></span><span style="display:flex;"><span>	loginMsg <span style="color:#000;font-weight:bold">:=</span> proto.MsgLogin{}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(conn, <span style="color:#000;font-weight:bold">&amp;</span>loginMsg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading from connection: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		conn.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	hash <span style="color:#000;font-weight:bold">:=</span> md5.<span style="color:#900;font-weight:bold">New</span>()
</span></span><span style="display:flex;"><span>	hash.<span style="color:#900;font-weight:bold">Write</span>([]<span style="color:#0086b3">byte</span>(s.cfg.Token <span style="color:#000;font-weight:bold">+</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%d&#34;</span>, loginMsg.Timestamp)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%x&#34;</span>, hash.<span style="color:#900;font-weight:bold">Sum</span>(<span style="color:#000;font-weight:bold">nil</span>)) <span style="color:#000;font-weight:bold">!=</span> loginMsg.Token {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Invalid token, client addr: %s&#34;</span>, conn.<span style="color:#900;font-weight:bold">RemoteAddr</span>().<span style="color:#900;font-weight:bold">String</span>())
</span></span><span style="display:flex;"><span>		conn.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><blockquote>
<p>At first, this was intended to return <code>MsgLoginResp</code>, but it turns out that there's no need to do that, and it's fine to just disconnect it.</p>
</blockquote>
<p>Send<code>is used here, and the implementation of</code>message` is described next.</p>
<h3 id="send-is-used-here-and-the-implementation-of-message-is-described-next">Send' is used here, and the implementation of <code>message</code> is described next.</h3>
<p><code>TCP</code> is a <code>Stream</code> protocol, we don't know how many bytes we need to read, and the length of each message is variable, so we need to implement our own serialization rules.</p>
<h4 id="format">format</h4>
<p>The <code>format</code> of <code>Message</code> is specified as follows:</p>
<pre><code>|&lt;1 byte&gt;|&lt;2 byte&gt;|&lt;length byte&gt;|
|PacketType|Length| Json Message|
</code></pre>
<h4 id="packunpack">pack/unpack</h4>
<p><a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/packet.go#L42">proto/packet.go#L42</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">packet</span>(typ PacketType, msg <span style="color:#000;font-weight:bold">interface</span>{}) ([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	buf, err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Marshal</span>(msg)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">packet0</span>(typ, buf)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">packet0</span>(typ PacketType, buf []<span style="color:#458;font-weight:bold">byte</span>) ([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(buf) &gt; <span style="color:#099">65535</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, ErrMsgLength
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ret <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">3</span><span style="color:#000;font-weight:bold">+</span><span style="color:#0086b3">len</span>(buf))
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">0</span>] = <span style="color:#0086b3">byte</span>(typ)
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">1</span>] = <span style="color:#0086b3">byte</span>(<span style="color:#0086b3">len</span>(buf) <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#099">8</span>)
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">2</span>] = <span style="color:#0086b3">byte</span>(<span style="color:#0086b3">len</span>(buf))
</span></span><span style="display:flex;"><span>	<span style="color:#0086b3">copy</span>(ret[<span style="color:#099">3</span>:], buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> ret, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">read</span>(r io.Reader) (PacketType, []<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	typ, buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">read0</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> PacketUnknown, <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">PacketType</span>(typ), buf, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">read0</span>(r io.Reader) (typ <span style="color:#458;font-weight:bold">byte</span>, buf []<span style="color:#458;font-weight:bold">byte</span>, err <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	_, err = r.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	typ = buf[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>	_, err = r.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		err = ErrMsgRead
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	l <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">int</span>(buf[<span style="color:#099">0</span>])<span style="color:#000;font-weight:bold">&lt;&lt;</span><span style="color:#099">8</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#0086b3">int</span>(buf[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, l)
</span></span><span style="display:flex;"><span>	n, err <span style="color:#000;font-weight:bold">:=</span> io.<span style="color:#900;font-weight:bold">ReadFull</span>(r, buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> n <span style="color:#000;font-weight:bold">!=</span> l {
</span></span><span style="display:flex;"><span>		err = ErrMsgLength
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h4 id="sendrecv">send/recv</h4>
<p><a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/msg.go#L16">proto/msg.go#L16</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Send</span>(w io.Writer, msg Msg) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">packet</span>(msg.<span style="color:#900;font-weight:bold">Type</span>(), msg)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	_, err = w.<span style="color:#900;font-weight:bold">Write</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Recv</span>(r io.Reader, msg Msg) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	p, buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">read</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> p <span style="color:#000;font-weight:bold">!=</span> msg.<span style="color:#900;font-weight:bold">Type</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> ErrInvalidMsg
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Now that the serialization and parsing of <code>Message</code> is complete, you don't need to worry about using <code>Msg</code> or adding new <code>Msg</code>s.</p>
<h3 id="forward">Forward</h3>
<p>The client part sends the <code>Forward</code> message and receives the returned <code>ForwardResp</code>.<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L88">client/serve.go#L88</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (f <span style="color:#000;font-weight:bold">*</span>Forwarder) <span style="color:#900;font-weight:bold">Run</span>() {
</span></span><span style="display:flex;"><span>	rConn, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(f.svraddr, f.token)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(rConn, proto.<span style="color:#900;font-weight:bold">NewMsgForward</span>(f.proxyName, f.subdomain,
</span></span><span style="display:flex;"><span>		f.proxyType, f.remotePort)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Error send forward msg to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	frdResp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgForwardResp{}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Recv</span>(rConn, frdResp); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatal</span>(<span style="color:#d14">&#34;Error reading forward resp msg from remote, please check your config&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> frdResp.Status <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#34;success&#34;</span> {
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Forward failed, status: %s, remote port: %d&#34;</span>, frdResp.Status, f.remotePort)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>After sending, if the check is successful, the Client receives the message from the Server in a <code>for</code> loop.</p>
<p><strong>Server-side processing of <code>Forward</code> messages</strong><br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L83-L107">server/serve.go#L83-L107</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>	pt, buf, err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Read</span>(conn)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading from connection: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> pt {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">case</span> proto.PacketForwardReq:
</span></span><span style="display:flex;"><span>		failChan <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>(<span style="color:#000;font-weight:bold">chan</span> <span style="color:#000;font-weight:bold">struct</span>{})
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> <span style="color:#0086b3">close</span>(failChan)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">&lt;-</span>failChan
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Send</span>(conn, proto.<span style="color:#900;font-weight:bold">NewMsgForwardResp</span>(<span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;failed&#34;</span>)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error sending forward failed resp message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		msg <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgForwardReq{}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error unmarshalling message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		s.<span style="color:#900;font-weight:bold">handleForward</span>(conn, msg, failChan)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p><code>handleForward</code> function<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L133">server/serve.go#L133</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handleForward</span>(cConn net.Conn, msg <span style="color:#000;font-weight:bold">*</span>proto.MsgForwardReq, failChan <span style="color:#000;font-weight:bold">chan</span> <span style="color:#000;font-weight:bold">struct</span>{}) {
</span></span><span style="display:flex;"><span>	uPort <span style="color:#000;font-weight:bold">:=</span> msg.RemotePort
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !s.<span style="color:#900;font-weight:bold">availablePort</span>(uPort) {
</span></span><span style="display:flex;"><span>		failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	from <span style="color:#000;font-weight:bold">:=</span> cConn.<span style="color:#900;font-weight:bold">RemoteAddr</span>().<span style="color:#900;font-weight:bold">String</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>		uListener, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Listen</span>(<span style="color:#d14">&#34;tcp&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, uPort))
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> uListener.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(cConn, proto.<span style="color:#900;font-weight:bold">NewMsgForwardResp</span>(domain, <span style="color:#d14">&#34;success&#34;</span>)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			userConn, err <span style="color:#000;font-weight:bold">:=</span> uListener.<span style="color:#900;font-weight:bold">Accept</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>				uid <span style="color:#000;font-weight:bold">:=</span> conn.<span style="color:#900;font-weight:bold">NewUuid</span>()
</span></span><span style="display:flex;"><span>				s.tcpConnMap.<span style="color:#900;font-weight:bold">Add</span>(uid, userConn)
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Send</span>(cConn, proto.<span style="color:#900;font-weight:bold">NewMsgExchange</span>(uid, msg.ProxyType)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error sending exchange message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The approximate process is:</p>
<ol>
<li>check port available</li>
<li>send <code>ForwardResp</code> message</li>
<li>create <code>uListener</code> and wait for user connection</li>
<li>receive user connection, create <code>uuid</code>, send <code>Exchange</code> message</li>
</ol>
<h3 id="exchange">Exchange</h3>
<p>The Client keeps getting messages from the <code>for</code> after sending a <code>Forward</code> message, and then if it's an <code>Exchange</code> message, the Client gets the message from the <code>Forward</code> message.<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L124">client/serve.go#L124</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		p, buf, err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Read</span>(rConn)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			f.logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading msg from remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		nlogger <span style="color:#000;font-weight:bold">:=</span> f.logger.<span style="color:#900;font-weight:bold">CloneAdd</span>(p.<span style="color:#900;font-weight:bold">String</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">switch</span> p {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">case</span> proto.PacketExchange:
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgExchange{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">cancelForward</span>(f.token, f.svraddr, f.proxyName, f.localPort, f.remotePort)
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>					nRconn, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(f.svraddr, f.token)
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						nlogger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error connecting to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>						<span style="color:#900;font-weight:bold">cancelForward</span>(f.token, f.svraddr, f.proxyName, f.localPort, f.remotePort)
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(nRconn, proto.<span style="color:#900;font-weight:bold">NewMsgExchange</span>(msg.ConnId, f.proxyType)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						nlogger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Error sending exchange msg to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					lConn, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Dial</span>(msg.ProxyType, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, f.localPort))
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						nlogger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error connecting to local: %v, will close forward, %s:%d&#34;</span>, err, f.proxyType, f.localPort)
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					proxy.<span style="color:#900;font-weight:bold">Stream</span>(lConn, nRconn)
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Here you can see that the logic is simple</p>
<ol>
<li>after receiving the <code>Exchange</code> message</li>
<li>create a new Server connection</li>
<li>create a <code>Local</code> connection based on the <code>ProxyType</code>. 4. call <code>proxy.Stream</code> to <code>Copy</code> the traffic.</li>
<li>call <code>proxy.Stream</code> to <code>Copy</code> the traffic.</li>
</ol>
<p>The Server side receives the <code>Exchange</code> message and it's a simple matter of pulling the corresponding connection out of the <code>tcpConnMap</code> and then doing the same <code>proxy.Stream</code> for the traffic <code>Copy</code>.</p>
<p><a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L254">server/serve.go#L254</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handleExchange</span>(conn net.Conn, msg <span style="color:#000;font-weight:bold">*</span>proto.MsgExchange) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>		uConn, ok <span style="color:#000;font-weight:bold">:=</span> s.tcpConnMap.<span style="color:#900;font-weight:bold">Get</span>(msg.ConnId)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> !ok {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> s.tcpConnMap.<span style="color:#900;font-weight:bold">Del</span>(msg.ConnId)
</span></span><span style="display:flex;"><span>		proxy.<span style="color:#900;font-weight:bold">Stream</span>(conn, uConn)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="conclusion">Conclusion</h3>
<p>At this point, the implementation of <code>Pipe</code> is almost complete, and basically lists the complete process, next will write the <code>Feature</code> implemented by <code>Pipe</code>.</p>
<h2 id="feat">Feat</h2>
<h2 id="auto-subdomain-https">Auto subdomain https</h2>
<p>The goal is to implement an automatic <code>Subdomain</code> assignment with <code>Https</code> support.<br>
That is, add Server running on the <code>example.com</code> machine, and Client enables forwarding of <code>Local 3000</code> to <code>Server 9000</code> port.<br>
Server generates a <code>Subdomain</code> of <code>xxx.example.com</code>, which can access Client <code>Local 3000</code> via <code>https://xxx.example.com</code>.<br>
Since I don't want to go through the trouble of implementing <code>Https</code>, I'll use <code>Caddy</code> to do the <code>Https</code> part.<br>
The code is in [server/caddy_service.go#L22](<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/caddy">https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/caddy</a>_ service.go#L22)</p>
<p>Adding an <code>https</code> <code>route</code> with <code>Caddy</code>'s <code>API</code>.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">addCaddyRouter</span>(host <span style="color:#458;font-weight:bold">string</span>, port <span style="color:#458;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>	tunnelId <span style="color:#000;font-weight:bold">:=</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%s.%d&#34;</span>, host, port)
</span></span><span style="display:flex;"><span>	resp, err <span style="color:#000;font-weight:bold">:=</span> http.<span style="color:#900;font-weight:bold">Post</span>(caddyAddRouteUrl, <span style="color:#d14">&#34;application/json&#34;</span>, bytes.<span style="color:#900;font-weight:bold">NewBuffer</span>([]<span style="color:#0086b3">byte</span>(fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(caddyAddRouteF, tunnelId, host, port))))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Tunnel creation failed, err: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> resp.Body.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	resp, err = http.<span style="color:#900;font-weight:bold">Post</span>(caddyAddTlsSubjectsUrl, <span style="color:#d14">&#34;application/json&#34;</span>, bytes.<span style="color:#900;font-weight:bold">NewBuffer</span>([]<span style="color:#0086b3">byte</span>(fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;\&#34;%s\&#34;&#34;</span>, host))))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Tunnel creation failed, err: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> resp.Body.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>	logger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Tunnel created successfully, id: %s, host: %s&#34;</span>, tunnelId, cr.<span style="color:#900;font-weight:bold">PWhiteUnderline</span>(host))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Preparation:</p>
<ol>
<li>To set up DNS resolution, set up two records, <code>A *.example.com &lt;your server ip&gt;</code> and <code>A example.com &lt;your server ip&gt;</code>.</li>
<li>Run <code>Caddy</code> (for <code>Cloudflare DNS</code>, you also need to compile your own version of <code>Caddy</code> that supports <code>Cloudflare DNS plugin</code>, and fill in <code>Cloudflare KEY</code> in the configuration, the specific procedure should be available if you need to look for it on the Internet).</li>
<li>Server side with parameters that support <code>Subdomain</code>, you can see the project <code>README.md</code>.</li>
</ol>
<h3 id="deploy-at-flyio">Deploy at <code>fly.io</code></h3>
<p><strong>The important thing here is that only 1 Service can be deployed.</strong></p>
<blockquote>
<p>Can't I deploy more than one?<br>
No, because if you deploy more than one, <code>fly</code> will do <code>Load Balancing</code>, so some user requests can't be <code>Copied</code> because they're not in the <code>tcpConnMap</code> (<code>yamux</code> may be able to solve this problem).</p>
</blockquote>
<p>Since <code>fly.io</code> supports <code>Dockerfile</code>, you can simply write a <code>Dockerfile</code>.<br>
The key is <code>fly.toml</code>.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>app = <span style="color:#d14">&#34;pipefly&#34;</span>
</span></span><span style="display:flex;"><span>primary_region = <span style="color:#d14">&#34;hkg&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[build]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Control</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">8910</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">8910</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Admin</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">8911</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;tls&#34;</span>, <span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">443</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Forward TCP</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">9000</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;tls&#34;</span>, <span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">9000</span>
</span></span></code></pre><p><code>Control</code> and <code>Admin</code> have a <code>tcp</code> <code>protocol</code> since they are both <code>TCP</code>, and then <code>Admin</code> wants to access it directly from <a href="https://pipefly.fly.dev/">https://pipefly.fly.dev/</a>, so they need to add <code>handlers = [&quot;http&quot;]</code> as well as <code>https</code> <code>handlers = [&quot;tls&quot;, &quot;http&quot;]</code>. handlers = [&quot;tls&quot;, &quot;http&quot;]`</p>
<p>Then you need to specify the port for <code>Forward</code> in the configuration so that when you run Server and Client<br>
After running Server and Client, you can access <a href="https://pipefly.fly.dev:9000">https://pipefly.fly.dev:9000</a> to access Client <code>Local 3000</code>.</p>
<blockquote>
<p>The <code>UDP</code> configuration is also supported by <code>fly.io</code>, see the <code>fly</code> documentation, or see this example <a href="https://github.com/AnimMouse/frp-flyapp">AnimMouse/frp-flyapp</a></p>
</blockquote>
<h3 id="udp"><code>UDP</code></h3>
<p>UDP<code>support, since</code>UDP<code>does not have the concept of connection, only</code>Packet<code>, we can &quot;encapsulate&quot; the </code>UDP<code>traffic as</code>MsgUDPDatagram<code>, and then do a </code>Copy` of the traffic.<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proxy/udp.go#L1-L77">proxy/udp.go#L1-L77</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">UDPClientStream</span>(token <span style="color:#458;font-weight:bold">string</span>, tcp, udp io.ReadWriteCloser) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> proto.MsgUDPDatagram{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(tcp, <span style="color:#000;font-weight:bold">&amp;</span>msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			n, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">Write</span>(msg.Payload)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> n <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">len</span>(msg.Payload) {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		buf <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">4096</span>)
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(tcp, proto.<span style="color:#900;font-weight:bold">NewMsgUDPDatagram</span>(<span style="color:#000;font-weight:bold">nil</span>, buf[:n])); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">UDPDatagram</span>(token <span style="color:#458;font-weight:bold">string</span>, tcp io.ReadWriteCloser, udp <span style="color:#000;font-weight:bold">*</span>net.UDPConn) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		buf <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">4096</span>)
</span></span><span style="display:flex;"><span>		n, addr, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">ReadFromUDP</span>(buf)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(tcp, proto.<span style="color:#900;font-weight:bold">NewMsgUDPDatagram</span>(addr, buf[:n])); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> proto.MsgUDPDatagram{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(tcp, <span style="color:#000;font-weight:bold">&amp;</span>msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			_, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">WriteTo</span>(msg.Payload, addr)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Equivalent to <code>proxy.Stream</code> in <code>TCP</code> forwarding instead.</p>
<h3 id="speed-limit">Speed limit</h3>
<p>Thanks to the <code>io.Reader</code> and <code>io.Writer</code> interfaces, as well as the <code>rate</code> package, it's really easy to implement speed limits.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> LimitStream <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	rw       io.ReadWriteCloser
</span></span><span style="display:flex;"><span>	ctx      context.Context
</span></span><span style="display:flex;"><span>	wlimiter <span style="color:#000;font-weight:bold">*</span>rate.Limiter
</span></span><span style="display:flex;"><span>	rlimiter <span style="color:#000;font-weight:bold">*</span>rate.Limiter
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">NewLimitStream</span>(rw io.ReadWriteCloser, limit <span style="color:#458;font-weight:bold">int</span>) <span style="color:#000;font-weight:bold">*</span>LimitStream {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">&amp;</span>LimitStream{
</span></span><span style="display:flex;"><span>		rw:       rw,
</span></span><span style="display:flex;"><span>		ctx:      context.<span style="color:#900;font-weight:bold">Background</span>(),
</span></span><span style="display:flex;"><span>		wlimiter: rate.<span style="color:#900;font-weight:bold">NewLimiter</span>(rate.<span style="color:#900;font-weight:bold">Limit</span>(limit), limit), <span style="color:#998;font-style:italic">// set burst = limit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		rlimiter: rate.<span style="color:#900;font-weight:bold">NewLimiter</span>(rate.<span style="color:#900;font-weight:bold">Limit</span>(limit), limit), <span style="color:#998;font-style:italic">// set burst = limit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>LimitStream) <span style="color:#900;font-weight:bold">Read</span>(p []<span style="color:#458;font-weight:bold">byte</span>) (<span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> s.rlimiter <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> s.rw.<span style="color:#900;font-weight:bold">Read</span>(p)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	do <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">func</span>(r <span style="color:#000;font-weight:bold">*</span>LimitStream, p []<span style="color:#458;font-weight:bold">byte</span>) (<span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> r.rw.<span style="color:#900;font-weight:bold">Read</span>(p)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> n, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> r.rlimiter.<span style="color:#900;font-weight:bold">WaitN</span>(r.ctx, n); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> n, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> n, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(p) &lt; s.rlimiter.<span style="color:#900;font-weight:bold">Burst</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">do</span>(s, p)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	burst <span style="color:#000;font-weight:bold">:=</span> s.rlimiter.<span style="color:#900;font-weight:bold">Burst</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> read <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#099">0</span>; i &lt; <span style="color:#0086b3">len</span>(p); i <span style="color:#000;font-weight:bold">+=</span> burst {
</span></span><span style="display:flex;"><span>		end <span style="color:#000;font-weight:bold">:=</span> i <span style="color:#000;font-weight:bold">+</span> burst
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> end &gt; <span style="color:#0086b3">len</span>(p) {
</span></span><span style="display:flex;"><span>			end = <span style="color:#0086b3">len</span>(p)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">do</span>(s, p[i:end])
</span></span><span style="display:flex;"><span>		read <span style="color:#000;font-weight:bold">+=</span> n
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> read, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> read, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The principle is that if we want to limit the speed to <code>10k/s</code>, then initialize <code>rate.Limiter</code> with <code>burst=10k</code>.<br>
When <code>Read</code>, call <code>WaitN</code>, since the capacity is <code>10k</code>, <code>WaitN</code> waits <code>1s</code> for every <code>10k byte</code> read.<br>
This achieves the <code>10k/s</code> speed limit and is very simple to use, just initialize a <code>LimitStream</code> and you're done!</p>
<h2 id="done">Done</h2>
<p>After writing about how to implement an intranet forwarding widget, there are still a lot of things that can be optimized in the code itself, such as</p>
<ol>
<li>improve the &quot;error handling&quot; and &quot;retry&quot;, for which errors need to retry, and for which errors to exit directly</li>
<li>support more forwarding protocols, such as <code>HTTP/Quic/WebSocket</code>, <code>Control</code> protocol can also support more, currently <code>TCP</code>, can support <code>UDP/KCP</code> and so on.</li>
<li>Improve the monitoring collection, this part can use <code>Prometheus</code>, but for small projects is too much trouble.</li>
<li><code>Load Balancing</code> This part has been thinking about how to do, from the deployment of <code>fly.io</code> above, we can see that the <code>Server</code> side can only be accessed by a single machine.</li>
</ol>
<p>After writing this small project, I realized that it is hard to maintain the project, and because of my personal limitations, it is hard to make a reasonable abstraction of the code at the beginning, which makes it difficult to make subsequent changes to the code. Before I wrote some small projects with hundreds of lines, I didn't feel it, but now after the amount of code in this project has increased, I feel that the code &quot;structure&quot; and &quot;interface&quot; are still not &quot;clear&quot; enough.</p>
<p>Thanks for reading!</p>
<h2 id="refs">refs</h2>
<p><a href="https://pandaychen.github.io/2020/01/01/MAGIC-GO-IO-PACKAGE/">https://pandaychen.github.io/2020/01/01/MAGIC-GO-IO-PACKAGE/</a><br>
<a href="https://github.com/ekzhang/bore">https://github.com/ekzhang/bore</a><br>
<a href="https://github.com/rapiz1/rathole">https://github.com/rapiz1/rathole</a><br>
<a href="https://github.com/AnimMouse/frp-flyapp">https://github.com/AnimMouse/frp-flyapp</a></p>
</article>
    </main>
    <hr class="divider" />
    
<footer class="footer">
  <p class="footer-author">
    Author <a href="https://github.com/abcdlsj">abcdlsj</a>
  </p>
  <p class="footer-proj">
    Source
    <a href="https://github.com/abcdlsj/abcdlsj.github.io">abcdlsj.github.io</a>
  </p>
</footer>

  </body>
</html>

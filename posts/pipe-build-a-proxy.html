
<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8" />
<title>abcdlsj</title>
<meta name="description" content="Enjoy Focus!" />
<meta name="author" content="Author" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="stylesheet" href="/static/style.css" />

  </head>
  <body class="container">
    <div class="navbar">
<nav class="navbar">
  
  <ul>
    <li>
      <a href="/" class="menu">#Home</a>
    </li>
  </ul>
  
  <ul>
    <li>
      <a href="/about" class="menu">#About</a>
    </li>
  </ul>
  
</nav>
</div>
    <hr class="divider" />
    <h1 class="post-title">Pipe - Build a tunnel tool like `frp` or `ngrok`</h1>
    <div class="post-meta">
      <div class="post-date">Date: 2023-11-04T22:47:37+08:00</div>
      <nav class="post-tags">
        
        <a href="/tags/Network.html" class="tag">#Network</a>
        
        <a href="/tags/Weekly.html" class="tag">#Weekly</a>
        
        <a href="/tags/Tunnel.html" class="tag">#Tunnel</a>
        
      </nav>
    </div>
    <hr class="divider" />
    <main class="post-content">
      <article><h1>Table of Contents</h1>
<ul>
<li>
<ul>
<li>
<a href="#background">Background</a></li>
<li>
<a href="#how-it-works">How it works</a></li>
<li>
<a href="#codes">Codes</a><ul>
<li>
<a href="#structure">Structure</a></li>
<li>
<a href="#auth">Auth</a></li>
<li>
<a href="#message">Message</a><ul>
<li>
<a href="#format">format</a></li>
<li>
<a href="#packunpack">pack/unpack</a></li>
<li>
<a href="#sendrecv">send/recv</a></li>
</ul>
</li>
<li>
<a href="#forward">Forward</a></li>
<li>
<a href="#exchange">Exchange</a></li>
<li>
<a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li>
<a href="#feat">Feat</a><ul>
<li>
<a href="#auto-subdomain-https">Auto subdomain https</a></li>
<li>
<a href="#deploy-at-flyio">Deploy at fly.io</a></li>
<li>
<a href="#udp">UDP</a></li>
<li>
<a href="#speed-limit">Speed limit</a></li>
</ul>
</li>
<li>
<a href="#done">Done</a></li>
<li>
<a href="#refs">refs</a></li>
</ul>
</li>
</ul>
<h2 id="background">Background</h2>
<p><strong>简单的转发工具</strong><br>
公司内部的服务框架通信是通过 <code>UNIX domain</code> 连接机器本地的 <code>Agent</code> 实现，在公司容器集群环境，都是会启动 <code>Agent</code>，但是作为本地环境，没有 <code>Agent</code> 的条件，所以本地启动服务都是使用 <code>socat</code> 将本地 <code>UNIX domain</code> 流量转发到远程的一个 <code>TCP agent</code> 来启动服务的<br>
所以我们是使用 <code>socat</code>：<code>socat unix:/xxx.sock,fork tcp:agent.xxx.io:5443</code></p>
<blockquote>
<p><code>socat</code> 是一个瑞士军刀类的工具，非常强大</p>
</blockquote>
<p>之前借助 <code>io.Copy()</code> 以及 <code>net</code> 包，动手实现了符合需求的转发工具，代码量很少，加上 <code>flag</code> 代码不超过 50 行，但是却非常实用，启动速度很快（实测因为 <code>socat</code> 会对流量做加解密，所以直接 <code>copy</code> 会快一点点）</p>
<p><strong>远程端口转发</strong><br>
<code>frp</code> 很适用于内网转发，不过功能很多用不上，<code>ngrok</code> 则适用于做一些临时暴露本地服务之类的。<br>
因为之前的尝试，所以准备实现一个类似工具，实现过程中没有借鉴太多其它项目的代码，很多地方都是遇到问题再去查，所以写一篇博客记录下是很值得的，这里写一下思路以及核心代码。</p>
<blockquote>
<p>开始的版本只实现 <code>TCP</code> 转发，含有 <code>Caddy</code> 来做 <code>Auto Subdomain https</code>，代码不到 <code>1000</code> 行。后边优化了下，现在支持 <code>TCP/UDP</code> 协议，所以本文只涉及 <code>TCP/UDP</code> 实现（不过其它协议也大都类似<br>
另外顺带一提，<code>GitHub</code> 有非常多类似的实现，比如 <a href="https://github.com/ekzhang/bore">ekzhang/bore</a> 和 <a href="https://github.com/rapiz1/rathole/">rapiz1/rathole</a>（<code>Tokio</code> 的功能太强大了，忍不住想用 <code>Rust</code> 重写 :P）</p>
</blockquote>
<p>所有的代码都在 <a href="https://github.com/abcdlsj/pipe/tree/484084da8b9edb99fb39e5d7561cc94d16d7031c">abcdlsj/pipe</a> 里（本文纂写时的版本）</p>
<h2 id="how-it-works">How it works</h2>
<p>实现<strong>远程端口转发</strong></p>
<p>假设有一个服务器（Server）和一个客户端（Client）。其中，服务器的 IP 可以直接从公网访问，而客户端的 IP 则不行，并且客户端可以访问服务器。</p>
<p>我们希望有一种方法来建立服务器端口和客户端端口之间的关联，将对服务器端口的访问转发到客户端的对应端口，通过公网访问服务器的端口就相当于访问客户端的端口。</p>
<p><strong>如何实现这个转发？</strong><br>
首先 Server 端应该和 Client 端进行通信，对于 Server 端的入站请求，将请求和 Client 端进行<strong>绑定</strong>，Client 则对目标端口和 Server 端通信连接进行<strong>绑定</strong>。<strong>绑定</strong> 的意思是对两个连接进行 <code>io.Copy()</code>。</p>
<p>假设我们 Server 通信端口是 8910，要将 Client 的 3000 端口穿透到 Server 的 9000 端口。<br>
最后结构差不多就是这样：</p>
<div class="d2"><?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" d2Version="v0.5.0-HEAD" preserveAspectRatio="xMinYMin meet" viewBox="0 0 1024 941"><svg id="d2-svg" class="d2-2119188561" width="1024" height="941" viewBox="-101 -100 1024 941"><rect x="-101.000000" y="-100.000000" width="1024.000000" height="941.000000" rx="0.000000" class=" fill-N7" stroke-width="0" /><style type="text/css"><![CDATA[
.d2-2119188561 .text {
	font-family: "d2-2119188561-font-regular";
}
@font-face {
	font-family: d2-2119188561-font-regular;
	src: url("data:application/font-woff;base64,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");
}
.d2-2119188561 .text-bold {
	font-family: "d2-2119188561-font-bold";
}
@font-face {
	font-family: d2-2119188561-font-bold;
	src: url("data:application/font-woff;base64,d09GRgABAAAAABAQAAoAAAAAGGAAAguFAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAAA9AAAAGAAAABgXxHXrmNtYXAAAAFUAAAAqgAAAOIEHQTCZ2x5ZgAAAgAAAAlXAAAMsOK8NSNoZWFkAAALWAAAADYAAAA2G38e1GhoZWEAAAuQAAAAJAAAACQKfwXoaG10eAAAC7QAAACdAAAApE0BBiZsb2NhAAAMVAAAAFQAAABUQQhErG1heHAAAAyoAAAAIAAAACAAQQD3bmFtZQAADMgAAAMoAAAIKgjwVkFwb3N0AAAP8AAAAB0AAAAg/9EAMgADAioCvAAFAAACigJYAAAASwKKAlgAAAFeADIBKQAAAgsHAwMEAwICBGAAAvcAAAADAAAAAAAAAABBREJPACAAIP//Au7/BgAAA9gBESAAAZ8AAAAAAfAClAAAACAAA3icfM1LKkUBAIfx33Gu93Vd7/dxPKMkE8VY2YAylxJlA5YjjGUBsgtzQxkrE/3VGRndb/obfCiUCrS1vKPSVeqo7dqz79CxE6fOnLtw5cZdgtpO4weO/vmla7dJPvKbn3znK595y2te8pynPOYh982tV4Ut2zZtWLJsRWVVbc26PqWWfgMGDRk2YlTbmI5xXRMmTZk2Y9aceQsW+QMAAP//AQAA//8lISjHAAB4nFxWW2zb5tl+P1oSY5mxLVEUJVlniqQO1pEi6bMsR5YPsXxKYieNbKdGmpMTO0ic2m2T9gf+oN2yBN3mrHW3oRuCFeuK9qLLLroC6YBi61a0FwPaLsCAtV1XBF2HbdombB1gSwNJ2bFzIfPG3/s+7/M+z/N9oIdxAGweuwl1UA9NYAYKQDD5TKzA8wwuC7LM0HUyj0z4OGauvPQjPqQLhXRh77rn8bk5VJjFbm6ePVqYn//3XGdn5cWfv1m5gS6+CYAgVi1jCWwdWgD0fo4T05IkpKw0znGM32CgLFYhJcm0Ac1MXjtw6MZk5rhv1C4zrUORqcFgxjY6SYx859zZFyYE/yztSs32HT8fsBePAYICAPoCuw71Kk7KRwkUQxXQ9ypfffYZdv3y85c3AZT+TLWMGbF1CKv9edmqNBTTHM/HsN1gKIuVpq1WymIwIEvvU6mDzFQwFhUih3xdXOfpXNv58H5vL89F28MHO/Mdi0Qi9oib87s8LnOgMZ6PS4fTreEZe4vH6Xab/LaD/VKxDVD1vwCYgF2HvQBCnUBarbQgSTIp1L31q++PNtFNukZbY+G5X2LXK78VT0jSCRElNpcBg3C1jD5EG2AHBoD2K8TJKkycV0FTJoZnDAY5JcmiyuNbufGraxgT8vQGxPhCx9yJVaPOM7DHzpKjXR5iOjN6uMnH26iHXYHFC5XPBSdzgSanjRGXjVZ5ClTL6A7aAMeDe9KY0bZkQPb+pezgo7nYgLOf8YqZTMIWIzvYKaL70uSB5W43PecayfYWqKZj3haFfwz4ahltYHeABO/WHGphXhR2TLC1gH8Wlzrn0qE2u2Ft1ahz5DEbbyYjFkaKE994bOJSj9M28pPNfUkHs2qxv2du3Dcw1A+Yiv2PaANs4NmFXtkl7lM2rmCvE9JKF+QZuNC372znwExch1XuGvNJUUpys9+9zbf6JaJneXJiOZNZyJFsvST4jjjcqCMkxjUt2QDQMvau8hVMjCg/oB9FgqaH+voC4/s86eaWvQ6ixX3kCLpyTt8iTqUJw1m93se5L1b+X6mVVcjB7oBFqSVQ+NZSTSpI3JRdw537UxNDay6vM2jD7rx6xB5ZmKm8j3xS0E5XXodqFWQA+AP2AcYBDwA4BOGaijNbLSMzdgeaNMZNgml7gb8Z6Vwz1etxg5lgiaP7MWbzLm1G6Jwe1zDVudAG+FRMilCV6XYhw7e/WUVf+aSYJX3DyfH9ay4vm1D+xFGp1xONBP3JLbiJyuu1z9bcaKM2d63HzrlXjTpvYXtwVMq4o7vm1vaN4WgDmh5IFdW7vGpvTU7ImlnK5ZYymcVcbjETjcWisWi0ptXu5QOTl7pXCr3ZEUWySt1sdRCzog0gwQ1A30dnMRgYP8fTFKnUZvw4ZbUqOF1D/EOnuuYkb5dDP8ZJU5GwJfgG9nLSwXz94qHVTIt97FsokB95OvqeuVHzwiDaUOt7AfSirJbdEpEgC6a6nV5Apw32Pr9miB6Xjrj4+bYZ3nh+xOZRDeHyJjcPo8B9N9S0hZ5FG2DetUdNpRrDLSMc5TTa9tqbnd0WVJpOJfX6p3S6UKryKSCgqmX0A7ShqIremZmclpnbxZTEdGOUxfBB8iTX5894fG5XzOHuDJ4+1D7t6XOkHe3tnLc7dIrgPEV7C02arKSRCLSH+qd422GLlbfZGxuY9ti+Gc1fpmoZLWLLQKtbFUVGlGVBDfb7AQTFsdyI6fGVFcZF2I00KRNnpt49Z7h69eKvw6xBt2AgtFpd1TL6CpUUne3ygKkWO7+bGFpze52cdW21oc4zTCzMoHTlEzHkcKHBSnM/2woICABURaVadtO17JaFuts/vtlrJI26etKYvXELlb5kCzxfYL+sNG/lBFZCJdVHO8/tqMDwHKfAwPGbl7+dMBgNOnxvvfxUW30TrsPr8fjXVl6N4ntxHd6At6LSPXaQ44aZe+p3kL1XaX6HyQeDeeYdtV8jACqjEtgBBJLf0Qan7/dpXH/2xVaj1ajbY97jX//mCy8mCJrQ1VvqeYT9bZyKUFSEGq/+Y5JqpaiIdVKpS1R70CYqKS67rwNZ3kVFI7Zq9TU5cPMeNmjEf3FzoMFs1O0x1XfdeJVuG3vboDuP9AGXA/3pI3+eZQaYjyoNPYfC2t3AVsvoL9gz0FDzsaYtyqJ4WNVb7YlgRXtOXLlyQvnZgzQdtNuCNluQeOXWrZdeunXrlQvs7PR00e8vTk/PsgruPAD6PfaEsj9BuWZESZKVkM1fW0kP+s+urKClo0anZXNjRdOKGwB9jj0DTuX/ezAtPmr3rOp+JZ0Fip24kk+G/LJtPD6fy8yKncW0rcv6fwcLV05H40neMZYSUke7xaUlqU5/WalrrZbRJ9gzEHrQR4y4FVJbt7nFoISK0utfhXNMzpUPxtucw/1TvUHOL7uHW+c75h+TBXkgu0CkgjPOAB9whqyn4pyPdTse4iJHDyTzVl1zoafzQETjlgRAX2FPQL3iAFJQng+KDEjRJ5IKFwz1w6f1SEc4GlOVv37xs6EhtOekZ8LtkFoqi+uPoCcrN86vKzPQ1TL6FHtCuVl3zaBiJ30Ug2+z9J/Rs1yfKxdMdrS1OllXnxmd+nODj5OPtmXPEGl2xsGmkolUozmMspdXmsLTufzxNADUqW+dL1T+eUhvJ7qShLVw3EFP3f10J2uhpGoE4ZnjHZkom0gXO6fPpHyx3rZHnHwo4Ap3EWzC3xWknB1E65jQMWzTOQdT0lh4biw2YNXZRzOp8Rh6MppgowGWb618xAedrMtEiq5wHDDwV8vonqrREACpZYgqTHKbDUkL8l230MuJgF0gjbLfm+jOzLhHmyVnoD2A2Ydc0qFUx7H2nsX+oUvop6mwy7+/PVkhYu7D5hZ2etgTCE/v6zsmZK+df/SFIUDQXS3D3+E1aNh6PWl0PMcJAscJAiHyQVEM8qL21u5BAK8puU/zksT7/cyOIyPutg6E6TBGkrhUuvj2qCXLRoJcbDg7uar5YLBaQEHsEyXvaG0FtMot/X6mvz9TlFMp+fbJj69e/fgk9/DdhTN35wFBolpAzbUzvOpahRXKYrhebEul2oqZ/v7b3PzdMwt3H+bUs9r9BB+iEtSp95Mpu4ZKlWZA1dewdjiAfaDMatoBnI3FWDYWw9rDDBNWfvA/AAAA//8BAAD//z+wnxwAAAEAAAACC4WfrmxjXw889QABA+gAAAAA2F2ghAAAAADdZi82/jf+xAhtA/EAAQADAAIAAAAAAAAAAQAAA9j+7wAACJj+N/43CG0AAQAAAAAAAAAAAAAAAAAAACl4nBzKMWrCYBjG8f/7BEpLQ/uWpm2mDDUixI/gpmAyfEtwEVyEeBpv4E1cXL2Au6dxiuj+04kNF1BHrZS1AiOF4aZPKrtSqmWiF0rbkmtJtIy5FcRkR1RD1PRp4sPZgWhnfmzPlxY0eidNXsklPvRGKmcsp5NTyPmV8y3nT04l598CrQVq61lZz8wyIgzHOwAAAP//AQAA///e2RNoAAAAAAAALAAsAFgAbACsAMgBAAEsAV4BkgG4AdoB5gICAjQCVgKCArIC5gMGA0IDaAOKA6YD3gQKBDoEZgR+BKoE6AUMBT4FjAXMBeIGAgYcBjYGQgZYAAEAAAApAJAADABjAAcAAQAAAAAAAAAAAAAAAAAEAAN4nJyUz24bVRTGf05s0wrBAkVVuonugkWR6NhUSdU2K4fUikUUB48LQkJIE8/4jzKeGXkmDuEJWPMWvEVXPATPgVij+Xzs2AXRJoqSfHfu+fOdc75zgR3+ZptK9SHwRz0xXGGvfm54iwf1E8PbtOtbhqs8qf1puEZYmxuu83mtZ/gj3lZ/M/yA/epPhh+yW20b/phn1R3Dn2w7/jL8Kfu8XeAKvOBXwxV2yQxvscOPhrd5hMWsVHlE03CNz9gzXGcP6DOhIGZCwgjHkAkjrpgRkeMTMWPCkIgQR4cWMYW+JgRCjtF/fg3wKZgRKOKYAkeMT0xAztgi/iKvlHNlHOo0s7sWBWMCLuRxSUCCI2VESkLEpeIUFGS8okGDnIH4ZhTkeORMiPFImTGiQZc2p/QZMyHH0VakkplPypCCawLld2ZRdmZAREJurK5ICMXTiV8k7w6nOLpksl2PfLoR4Usc38m75JbK9is8/bo1Zpt5l2wC5upnrK7EurnWBMe6LfO2+Fa44BXuXv3ZZPL+HoX6XyjyBVeaf6hJJWKS4NwuLXwpyHePcRzp3MFXR76nQ58Turyhr3OLHj1anNGnw2v5dunh+JouZxzLoyO8uGtLMWf8gOMbOrIpY0fWn8XEIn4mM3Xn4jhTHVMy9bxk7qnWSBXefcLlDqUb6sjlM9AelZZO80u0ZwEjU0UmhlP1cqmN3PoXmiKmqqWc7e19uQ1z273lFt+QaodLtS44lZNbMHrfVL13NHOtH4+AkJQLWQxImdKg4Ea8zwm4IsZxrO6daEsKWiufMs+NVBIxFYMOieLMyPQ3MN34xn2woXtnb0ko/5Lp5aqq+2Rx6tXtjN6oe8s737ocrU2gYVNN19Q0ENfEtB9pp9b5+/LN9bqlPOWIlJjwXy/AMzya7HPAIWNlGOhmbq9DUy9Ek5ccqvpLIlkNpefIIhzg8ZwDDnjJ83f6uGTijItbcVnP3eKYI7ocflAVC/suR7xeffv/rL+LaVO1OJ6uTi/uPcUnd1DrF9qz2/eyp4mVk5hbtNutOCNgWnJxu+s1ucd4/wAAAP//AQAA///0t09ReJxiYGYAg//nGIwYsAAAAAAA//8BAAD//y8BAgMAAAA=");
}
.d2-2119188561 .text-italic {
	font-family: "d2-2119188561-font-italic";
}
@font-face {
	font-family: d2-2119188561-font-italic;
	src: url("data:application/font-woff;base64,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");
}]]></style><style type="text/css"><![CDATA[.shape {
  shape-rendering: geometricPrecision;
  stroke-linejoin: round;
}
.connection {
  stroke-linecap: round;
  stroke-linejoin: round;
}
.blend {
  mix-blend-mode: multiply;
  opacity: 0.5;
}

		.d2-2119188561 .fill-N1{fill:#0A0F25;}
		.d2-2119188561 .fill-N2{fill:#676C7E;}
		.d2-2119188561 .fill-N3{fill:#9499AB;}
		.d2-2119188561 .fill-N4{fill:#CFD2DD;}
		.d2-2119188561 .fill-N5{fill:#DEE1EB;}
		.d2-2119188561 .fill-N6{fill:#EEF1F8;}
		.d2-2119188561 .fill-N7{fill:#FFFFFF;}
		.d2-2119188561 .fill-B1{fill:#0D32B2;}
		.d2-2119188561 .fill-B2{fill:#0D32B2;}
		.d2-2119188561 .fill-B3{fill:#E3E9FD;}
		.d2-2119188561 .fill-B4{fill:#E3E9FD;}
		.d2-2119188561 .fill-B5{fill:#EDF0FD;}
		.d2-2119188561 .fill-B6{fill:#F7F8FE;}
		.d2-2119188561 .fill-AA2{fill:#4A6FF3;}
		.d2-2119188561 .fill-AA4{fill:#EDF0FD;}
		.d2-2119188561 .fill-AA5{fill:#F7F8FE;}
		.d2-2119188561 .fill-AB4{fill:#EDF0FD;}
		.d2-2119188561 .fill-AB5{fill:#F7F8FE;}
		.d2-2119188561 .stroke-N1{stroke:#0A0F25;}
		.d2-2119188561 .stroke-N2{stroke:#676C7E;}
		.d2-2119188561 .stroke-N3{stroke:#9499AB;}
		.d2-2119188561 .stroke-N4{stroke:#CFD2DD;}
		.d2-2119188561 .stroke-N5{stroke:#DEE1EB;}
		.d2-2119188561 .stroke-N6{stroke:#EEF1F8;}
		.d2-2119188561 .stroke-N7{stroke:#FFFFFF;}
		.d2-2119188561 .stroke-B1{stroke:#0D32B2;}
		.d2-2119188561 .stroke-B2{stroke:#0D32B2;}
		.d2-2119188561 .stroke-B3{stroke:#E3E9FD;}
		.d2-2119188561 .stroke-B4{stroke:#E3E9FD;}
		.d2-2119188561 .stroke-B5{stroke:#EDF0FD;}
		.d2-2119188561 .stroke-B6{stroke:#F7F8FE;}
		.d2-2119188561 .stroke-AA2{stroke:#4A6FF3;}
		.d2-2119188561 .stroke-AA4{stroke:#EDF0FD;}
		.d2-2119188561 .stroke-AA5{stroke:#F7F8FE;}
		.d2-2119188561 .stroke-AB4{stroke:#EDF0FD;}
		.d2-2119188561 .stroke-AB5{stroke:#F7F8FE;}
		.d2-2119188561 .background-color-N1{background-color:#0A0F25;}
		.d2-2119188561 .background-color-N2{background-color:#676C7E;}
		.d2-2119188561 .background-color-N3{background-color:#9499AB;}
		.d2-2119188561 .background-color-N4{background-color:#CFD2DD;}
		.d2-2119188561 .background-color-N5{background-color:#DEE1EB;}
		.d2-2119188561 .background-color-N6{background-color:#EEF1F8;}
		.d2-2119188561 .background-color-N7{background-color:#FFFFFF;}
		.d2-2119188561 .background-color-B1{background-color:#0D32B2;}
		.d2-2119188561 .background-color-B2{background-color:#0D32B2;}
		.d2-2119188561 .background-color-B3{background-color:#E3E9FD;}
		.d2-2119188561 .background-color-B4{background-color:#E3E9FD;}
		.d2-2119188561 .background-color-B5{background-color:#EDF0FD;}
		.d2-2119188561 .background-color-B6{background-color:#F7F8FE;}
		.d2-2119188561 .background-color-AA2{background-color:#4A6FF3;}
		.d2-2119188561 .background-color-AA4{background-color:#EDF0FD;}
		.d2-2119188561 .background-color-AA5{background-color:#F7F8FE;}
		.d2-2119188561 .background-color-AB4{background-color:#EDF0FD;}
		.d2-2119188561 .background-color-AB5{background-color:#F7F8FE;}
		.d2-2119188561 .color-N1{color:#0A0F25;}
		.d2-2119188561 .color-N2{color:#676C7E;}
		.d2-2119188561 .color-N3{color:#9499AB;}
		.d2-2119188561 .color-N4{color:#CFD2DD;}
		.d2-2119188561 .color-N5{color:#DEE1EB;}
		.d2-2119188561 .color-N6{color:#EEF1F8;}
		.d2-2119188561 .color-N7{color:#FFFFFF;}
		.d2-2119188561 .color-B1{color:#0D32B2;}
		.d2-2119188561 .color-B2{color:#0D32B2;}
		.d2-2119188561 .color-B3{color:#E3E9FD;}
		.d2-2119188561 .color-B4{color:#E3E9FD;}
		.d2-2119188561 .color-B5{color:#EDF0FD;}
		.d2-2119188561 .color-B6{color:#F7F8FE;}
		.d2-2119188561 .color-AA2{color:#4A6FF3;}
		.d2-2119188561 .color-AA4{color:#EDF0FD;}
		.d2-2119188561 .color-AA5{color:#F7F8FE;}
		.d2-2119188561 .color-AB4{color:#EDF0FD;}
		.d2-2119188561 .color-AB5{color:#F7F8FE;}.appendix text.text{fill:#0A0F25}.md{--color-fg-default:#0A0F25;--color-fg-muted:#676C7E;--color-fg-subtle:#9499AB;--color-canvas-default:#FFFFFF;--color-canvas-subtle:#EEF1F8;--color-border-default:#0D32B2;--color-border-muted:#0D32B2;--color-neutral-muted:#EEF1F8;--color-accent-fg:#0D32B2;--color-accent-emphasis:#0D32B2;--color-attention-subtle:#676C7E;--color-danger-fg:red;}.sketch-overlay-B1{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-B2{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-B3{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B6{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AA2{fill:url(#streaks-dark);mix-blend-mode:overlay}.sketch-overlay-AA4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AA5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AB4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AB5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N1{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-N2{fill:url(#streaks-dark);mix-blend-mode:overlay}.sketch-overlay-N3{fill:url(#streaks-normal);mix-blend-mode:color-burn}.sketch-overlay-N4{fill:url(#streaks-normal);mix-blend-mode:color-burn}.sketch-overlay-N5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N6{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N7{fill:url(#streaks-bright);mix-blend-mode:darken}.light-code{display: block}.dark-code{display: none}]]></style><defs><pattern id="streaks-bright" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.1)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-normal" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.16)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-dark" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.32)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-darker" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(255, 255, 255, 0.24)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern></defs><g id="Flow"><g class="shape" ><path d="M-0.640124 -0.231351 L822.418220 0.724412 L822.101479 698.293629 L0.370222 699.612993" transform="translate(0.000000 41.000000)" class="shape stroke-B1 fill-B4" style="stroke-width:2;" /><path d="M0.342905 0.385553 C164.275793 -0.867400, 328.583341 -2.024734, 821.682562 0.156934 M-0.259466 0.105839 C182.127036 -2.513483, 363.937067 -2.741352, 821.767850 0.301126 M822.614681 -0.699773 C819.857613 152.526215, 820.134228 303.411907, 822.556219 698.652258 M822.119071 -0.319709 C823.857139 187.264585, 823.466552 375.228190, 822.162750 699.140897 M822.421120 698.914623 C645.129395 705.428156, 466.761011 705.210746, 0.734582 698.838590 M821.622629 698.942507 C512.964707 699.858210, 204.318082 699.749624, 0.375579 699.016737 M-0.288241 698.887412 C-3.554001 497.908934, -4.246974 298.112572, 0.236720 -0.482432 M0.087182 699.399289 C-3.750618 444.465803, -3.548196 190.094561, 0.176296 0.395212" transform="translate(0.000000 41.000000)" class="shape stroke-B1 fill-B4" style="stroke-width:2;" /><rect width="822.000000" height="699.000000" transform="translate(0.000000 41.000000)" class=" sketch-overlay-B4" /></g><text x="411.000000" y="28.000000" class="text fill-N1" style="text-anchor:middle;font-size:28px">Flow</text></g><g id="Flow.server"><g class="shape" ><path d="M-1.600310 -0.578379 L751.045551 1.811030 L750.253697 128.234072 L0.925556 131.532483" transform="translate(49.000000 293.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.342905 0.385553 C149.875470 -0.750670, 299.782693 -1.908004, 749.682562 0.156934 M-0.259466 0.105839 C166.189699 -2.264814, 332.062394 -2.492683, 749.767850 0.301126 M751.536704 -1.749433 C749.898428 29.505557, 750.589964 54.909808, 751.390547 129.130645 M750.297677 -0.799274 C751.060496 34.031330, 750.084027 69.810208, 750.406876 130.352243 M750.421120 129.914623 C588.657813 135.858343, 425.817847 135.640933, 0.734582 129.838590 M749.622629 129.942507 C468.030413 130.792282, 186.449494 130.683696, 0.375579 130.016737 M-0.720604 129.718532 C-0.626143 91.186407, -2.358576 55.609573, 0.591800 -1.206080 M0.217956 130.998223 C-2.375333 82.056446, -1.869278 34.520280, 0.440740 0.988030" transform="translate(49.000000 293.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="750.000000" height="130.000000" transform="translate(49.000000 293.000000)" class=" sketch-overlay-B5" /></g><text x="424.000000" y="281.000000" class="text fill-N1" style="text-anchor:middle;font-size:24px">server</text></g><g id="Flow.client"><g class="shape" ><path d="M-1.600310 -0.578379 L740.045551 1.811030 L739.253697 128.234072 L0.925556 131.532483" transform="translate(53.000000 580.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.342905 0.385553 C147.675420 -0.732836, 295.382595 -1.890170, 738.682562 0.156934 M-0.259466 0.105839 C163.754829 -2.226823, 327.192653 -2.454692, 738.767850 0.301126 M740.536704 -1.749433 C738.898428 29.505557, 739.589964 54.909808, 740.390547 129.130645 M739.297677 -0.799274 C740.060496 34.031330, 739.084027 69.810208, 739.406876 130.352243 M739.421120 129.914623 C580.030211 135.771288, 419.562642 135.553878, 0.734582 129.838590 M738.622629 129.942507 C461.165451 130.782209, 183.719571 130.673624, 0.375579 130.016737 M-0.720604 129.718532 C-0.626143 91.186407, -2.358576 55.609573, 0.591800 -1.206080 M0.217956 130.998223 C-2.375333 82.056446, -1.869278 34.520280, 0.440740 0.988030" transform="translate(53.000000 580.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="739.000000" height="130.000000" transform="translate(53.000000 580.000000)" class=" sketch-overlay-B5" /></g><text x="422.500000" y="568.000000" class="text fill-N1" style="text-anchor:middle;font-size:24px">client</text></g><g id="Flow.user"><g class="shape" ><path d="M-1.600310 -0.578379 L78.045551 1.811030 L77.253697 64.234072 L0.925556 67.532483" transform="translate(250.000000 70.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.857263 0.963884 C15.080592 0.851080, 30.240568 -2.042255, 76.206405 0.392335 M-0.648665 0.264598 C17.483548 0.148857, 34.174583 -0.420815, 76.419625 0.752815 M78.536704 -1.749433 C77.489431 15.585410, 78.180967 27.069513, 78.390547 65.130645 M77.297677 -0.799274 C77.657560 16.854002, 76.681091 35.455552, 77.406876 66.352243 M78.052801 65.786559 C61.423647 67.330430, 42.102845 66.786905, 1.836456 65.596476 M76.056573 65.856267 C47.966857 66.440085, 19.905385 66.168621, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(250.000000 70.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="77.000000" height="66.000000" transform="translate(250.000000 70.000000)" class=" sketch-overlay-B5" /></g><text x="288.500000" y="108.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">user</text></g><g id="Flow.server.remoteport 9000"><g class="shape" ><path d="M-1.600310 -0.578379 L164.045551 1.811030 L163.253697 64.234072 L0.925556 67.532483" transform="translate(207.000000 325.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><path d="M0.857263 0.963884 C32.280978 0.502511, 64.641341 -2.390824, 162.206405 0.392335 M-0.648665 0.264598 C36.519810 -0.593693, 72.247109 -1.163366, 162.419625 0.752815 M164.536704 -1.749433 C163.489431 15.585410, 164.180967 27.069513, 164.390547 65.130645 M163.297677 -0.799274 C163.657560 16.854002, 162.681091 35.455552, 163.406876 66.352243 M164.052801 65.786559 C128.875814 69.031956, 91.007179 68.488431, 1.836456 65.596476 M162.056573 65.856267 C101.638375 66.636955, 41.248420 66.365491, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(207.000000 325.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><rect width="163.000000" height="66.000000" transform="translate(207.000000 325.000000)" class=" sketch-overlay-B6" /></g><text x="288.500000" y="363.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">remoteport 9000</text></g><g id="Flow.client.localport 3000"><g class="shape" ><path d="M-1.600310 -0.578379 L147.045551 1.811030 L146.253697 64.234072 L0.925556 67.532483" transform="translate(215.000000 612.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><path d="M0.857263 0.963884 C28.880902 0.571414, 57.841189 -2.321921, 145.206405 0.392335 M-0.648665 0.264598 C32.756828 -0.446910, 64.721144 -1.016583, 145.419625 0.752815 M147.536704 -1.749433 C146.489431 15.585410, 147.180967 27.069513, 147.390547 65.130645 M146.297677 -0.799274 C146.657560 16.854002, 145.681091 35.455552, 146.406876 66.352243 M147.052801 65.786559 C115.542246 68.695607, 81.340043 68.152083, 1.836456 65.596476 M145.056573 65.856267 C91.028889 66.598039, 37.029448 66.326575, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(215.000000 612.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><rect width="146.000000" height="66.000000" transform="translate(215.000000 612.000000)" class=" sketch-overlay-B6" /></g><text x="288.000000" y="650.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">localport 3000</text></g><g id="Flow.(client &lt;-&gt; server)[0]"><marker id="mk-2451250203" markerWidth="10.000000" markerHeight="12.000000" refX="3.000000" refY="6.000000" viewBox="0.000000 0.000000 10.000000 12.000000" orient="auto" markerUnits="userSpaceOnUse"> <polygon points="10.000000,0.000000 0.000000,6.000000 10.000000,12.000000" class="connection fill-B1" stroke-width="2" /> </marker><marker id="mk-3488378134" markerWidth="10.000000" markerHeight="12.000000" refX="7.000000" refY="6.000000" viewBox="0.000000 0.000000 10.000000 12.000000" orient="auto" markerUnits="userSpaceOnUse"> <polygon points="0.000000,0.000000 10.000000,6.000000 0.000000,12.000000" class="connection fill-B1" stroke-width="2" /> </marker><path d="M445.500044 540.170064 M445.500044 540.170064 C446.981942 496.040135, 447.081585 471.519926, 446.702656 427.428631 M444.634962 539.773267 C446.214643 496.739656, 445.689168 472.130736, 446.745209 426.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(446.500000 541.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(446.500000 541.000000) rotate(90.00000250447816)" /> <path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(446.500000 427.000000) rotate(-90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(446.500000 427.000000) rotate(-90.00000250447816)" /><text x="446.500000" y="490.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">1. Create control connection, auth, send request forward...</text></g><g id="Flow.(user -&gt; server)[0]"><path d="M287.000044 137.670064 M287.000044 137.670064 C288.481942 184.740117, 288.581585 216.119932, 288.202656 290.428631 M286.134962 137.273267 C287.714643 185.439638, 287.189168 216.730742, 288.245209 289.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(288.000000 290.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(288.000000 290.000000) rotate(90.00000250447816)" /><text x="288.000000" y="221.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">2. View remote port 9000</text></g><g id="Flow.(server -&gt; server)[0]"><path d="M370.479972 363.752418 M370.479972 363.752418 C489.714944 347.613133, 527.231609 343.219938, 538.077656 343.928631 M369.614890 363.355621 C488.947645 348.312654, 525.839192 343.830748, 538.120209 342.516898 M538.120209 342.516898 C549.186368 343.744026, 563.485604 350.852821, 575.730468 360.813699 M537.295232 342.055176 C548.006580 344.186815, 564.834890 351.219031, 575.576144 360.960440 M575.576144 360.960440 C586.081313 369.583951, 586.830784 382.509098, 574.470620 393.695273 M575.873822 360.161166 C585.597945 369.934134, 587.024587 383.540310, 575.593556 391.924853 M575.593556 391.924853 C565.055238 403.426394, 489.126281 405.741227, 372.616581 388.960405 M575.497042 391.083056 C563.813776 403.848901, 488.936657 405.369086, 372.999511 389.847061" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(373.459857 388.699276) rotate(-171.875850161063)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(373.459857 388.699276) rotate(-171.875850161063)" /><text x="586.500000" y="381.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">3. io.Copy() control connection 8910 and user connection</text></g><g id="Flow.(server -&gt; client)[0]"><path d="M128.500044 424.670064 M128.500044 424.670064 C129.981942 471.740117, 130.081585 503.119932, 129.702656 577.428631 M127.634962 424.273267 C129.214643 472.439638, 128.689168 503.730742, 129.745209 576.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(129.500000 577.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(129.500000 577.000000) rotate(90.00000250447816)" /><text x="129.500000" y="508.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">4. Send start proxy request</text></g><g id="Flow.(client -&gt; client)[0]"><path d="M361.978561 651.590723 M361.978561 651.590723 C481.747933 634.782140, 519.431561 630.219938, 530.327656 630.928631 M361.113479 651.193926 C480.980634 635.481661, 518.039144 630.830748, 530.370209 629.516898 M530.370209 629.516898 C541.486416 630.744026, 555.852608 637.852791, 568.147460 647.813699 M529.545232 629.055176 C540.306628 631.186815, 557.201894 638.219001, 567.993136 647.960440 M567.993136 647.960440 C578.548293 656.583981, 579.297764 669.509068, 566.887612 680.695273 M568.290814 647.161166 C578.064925 656.934164, 579.491567 670.540280, 568.010548 678.924853 M568.010548 678.924853 C557.422242 690.426424, 481.159270 692.572221, 364.113758 675.131847 M567.914034 678.083056 C556.180780 690.848931, 480.969646 692.200080, 364.496688 676.018503" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-2119188561)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(364.957034 674.870718) rotate(-171.59456931066353)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(364.957034 674.870718) rotate(-171.59456931066353)" /><text x="578.500000" y="668.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">5. io.Copy() control connection 8910 and local connection</text></g><mask id="d2-2119188561" maskUnits="userSpaceOnUse" x="-101" y="-100" width="1024" height="941">
<rect x="-101" y="-100" width="1024" height="941" fill="white"></rect>
<rect x="383.500000" y="0.000000" width="55" height="36" fill="rgba(0,0,0,0.75)"></rect>
<rect x="392.500000" y="257.000000" width="63" height="31" fill="rgba(0,0,0,0.75)"></rect>
<rect x="395.000000" y="544.000000" width="55" height="31" fill="rgba(0,0,0,0.75)"></rect>
<rect x="272.500000" y="92.500000" width="32" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="229.500000" y="347.500000" width="118" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="237.500000" y="634.500000" width="101" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="257.000000" y="474.000000" width="379" height="21" fill="black"></rect>
<rect x="207.000000" y="205.000000" width="162" height="21" fill="black"></rect>
<rect x="402.000000" y="365.000000" width="369" height="21" fill="black"></rect>
<rect x="42.000000" y="492.000000" width="175" height="21" fill="black"></rect>
<rect x="393.000000" y="652.000000" width="371" height="21" fill="black"></rect>
</mask></svg></svg></div><p>这里省略了一些值得思考的东西，比如：</p>
<ol>
<li>Client 端和 Server 端建立连接 <code>Auth/Handshake</code> 的部分，如何「鉴权」？</li>
<li><code>Control</code> 连接里的消息是否固定长度？如果不固定，怎么处理「边界」问题？</li>
<li>Client 端接收到 <code>Proxy</code> 请求后，进行 <code>io.Copy()</code> 的是哪个连接，Server 端又怎样处理呢？</li>
</ol>
<blockquote>
<p>对于 1 和 2 可以看下面的详细实现<br>
对于 3，如果没有实现过类似的工具可能不太清楚为什么会有这个问题，看了下面详细的流程大概就清楚了（忽略「鉴权」部分</p>
</blockquote>
<ol>
<li>首先启动 Server 端，「监听」 8910 端口</li>
<li>启动 Client, Client 端和 Server 端建立 <code>Control</code> 连接，然后发送一条 <code>Forward</code> 接口告诉 Server 端将要转发到 9000 端口</li>
<li>Server 端从 <code>Control</code> 连接接收到 <code>Forward</code> 消息，开始对 9000 端口进行「监听」，准备接收来自用户端的请求</li>
</ol>
<blockquote>
<p>此时 Server 是否要 <code>Copy</code> 用户连接和 <code>Control</code> 连接呢？<br>
答案是不应该也不能，因为 <code>Control</code> 连接还会有来自 Server 或者 Client 的「其它」的流量，例如 <code>Close</code>、<code>Heartbeat</code> 消息等，这些流量如果直接 <code>Copy</code> 到用户连接上，那就会产生问题。</p>
</blockquote>
<ol start="4">
<li>当有新的用户请求到来时，Server 端通过 <code>Control</code> 连接发送 <code>Exchange</code> 消息，告诉 Client 端：有新的用户连接，准备开始对流量进行 <code>Copy</code></li>
<li>Client 端接收到 <code>Exchange</code> 消息，建立连接到 <code>Local 3000</code> 端口，准备 <code>Copy</code> 流量</li>
</ol>
<blockquote>
<p>Client 端也不能直接 <code>Copy</code> <code>Control</code> 连接和 <code>Local 3000</code> 连接，和 3 是一样的情况</p>
</blockquote>
<p>那么也就是我们遇到了「连接复用」的问题，这个问题在对多端流量进行处理的时候很常见，而且因为这里是直接 <code>io.Copy</code> 没办法区分流量的不同。<br>
解决这个问题有很多方法：</p>
<ol>
<li>可以使用连接复用库，例如 <a href="https://github.com/hashicorp/yamux">hashicorp/yamux</a>，<code>frp</code> 默认使用 <code>yamux</code></li>
<li>对报文在应用层自行区分，同时 <code>Copy</code> 的部分也要做处理（ps. <code>yamux</code> 就是对报文做了处理）</li>
<li>最简单的方法，也是大多数内网转发工具用的方法，就是如果需要 <code>Copy</code> 就新建一个连接，简单有效</li>
</ol>
<blockquote>
<p>方法 3 可能存在的问题是，端口的连接总数是有限的，但是正常都足够的（只要实现上连接有正常 <code>Close</code>，在 Client 不是很多的情况下是没有太大问题的</p>
</blockquote>
<p>方法 1 和 方法 3 是最适合的，而且 <code>yamux</code> 接入并不复杂，我选择方法 3 来实现（后续会抽空加上 <code>yamux</code> 支持</p>
<p>选择方法 3 后，因为 Server 端并不能新建通信连接，所以需要告诉 Client 新建连接，因为 Client 会 <code>Copy</code> <code>Local 3000</code> 流量到这个新建的连接上，所以对于「主分支」的 Server 来说，它需要判断是 <code>Forward</code> 还是 <code>Exchange</code> 消息，然后如果是 <code>Exchange</code>，需要<strong>拿出</strong>用户连接 <code>Copy</code> 到此 <code>Exchange</code> 消息的连接上。</p>
<p>所以步骤 3，Server 需要保存用户请求，创建对应的 <code>Connection UUID</code>，然后带上发送 <code>Exchange</code> 消息到 Client<br>
步骤 5，Client 需要接收到 <code>Exchange</code> 消息，新建 Server 连接，然后首先发送带上同样 <code>UUID</code> 的 <code>Exchange</code> 消息到 Server，然后 <code>Copy</code> <code>Local 3000</code> 流量到此新建的 Server 连接上<br>
步骤 6. Server 接收到 <code>Exchange</code> 消息，通过 <code>UUID</code> 取出对应的用户连接，然后 <code>Copy</code> 用户连接流量和此连接</p>
<p>至此，用户访问 Server 端 9000 端口的「一个连接」的访问流程已经完成了<br>
流程很简单，那么接下来，我会写一下每个流程的代码实现</p>
<h2 id="codes">Codes</h2>
<h3 id="structure">Structure</h3>
<p>结构大概是这样</p>
<pre><code>.
├── client
│   ├── cfg.toml
│   ├── cmd.go
│   ├── config.go
│   └── serve.go
├── cmd
│   └── cmd.go
├── logger
│   └── log.go
├── main.go
├── pio
│   ├── encrypt.go
│   └── limit.go
├── proto
│   ├── error.go
│   ├── msg.go
│   └── packet.go
├── proxy
│   ├── buf.go
│   ├── proxy.go
│   └── udp.go
└── server
    ├── cfg.toml
    ├── cmd.go
    ├── config.go
    ├── conn
    │   ├── constant.go
    │   ├── tcp.go
    │   └── udp.go
    └── serve.go
</code></pre>
<p>简要描述下：</p>
<ul>
<li>cmd: <code>cmd</code> 入口，<code>cobra</code></li>
<li>proxy：对两个连接进行 <code>Copy</code> 的部分</li>
<li>proto：<code>Control</code> 发送的消息结构体，以及序列化封装</li>
<li>client：Client 处理流程</li>
<li>server：Server 处理流程</li>
<li>pio: <code>io.Reader</code> 和 <code>io.Writer</code> 的封装，实现限速（<code>Speed limit</code>）的功能</li>
</ul>
<h3 id="auth">Auth</h3>
<p>因为打算通过 <code>Message</code> 发送来带出主体代码，所以就不分别写 <code>Client</code> 和 <code>Server</code> 的结构体了</p>
<p><code>Auth</code> 采用简单的 Token 校验，消息里有 <code>Token</code> 以及 <code>Timestamp</code> 字段，收到消息会 <code>md5(Token + Timestamp)</code> 进行校验（最开始我的实现 Client 和 Server 每个收发消息都会带上校验字段，好处是少一次 Auth 的发送时间，后来看到很多实现都只是在建立连接的时候校验，所以也改成连接创建时校验）</p>
<p><code>MsgLogin</code> 结构体<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/msg.go#L56">proto/msg.go#L56</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> MsgLogin <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	Token     <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;token&#34;`</span>
</span></span><span style="display:flex;"><span>	Version   <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;client_version&#34;`</span>
</span></span><span style="display:flex;"><span>	Timestamp <span style="color:#458;font-weight:bold">int64</span>  <span style="color:#d14">`json:&#34;timestamp&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><strong>Client</strong> <code>Dial</code> 创建和 <code>Auth</code> 部分差不多是这样<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L75">client/serve.go#L75</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(svraddr <span style="color:#458;font-weight:bold">string</span>, token <span style="color:#458;font-weight:bold">string</span>) (net.Conn, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	conn, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Dial</span>(<span style="color:#d14">&#34;tcp&#34;</span>, svraddr)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(conn, proto.<span style="color:#900;font-weight:bold">NewMsgLogin</span>(token)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> conn, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><code>Auth</code> 的部分还有其它更有意思的实现，例如 <code>OpenID Connect (OIDC)</code>，可以实现「扫码」认证之类的功能</p>
<p><strong>Server 部分</strong><br>
Server 会 <code>Listen</code> 端口 <code>8910</code>，等待 Client 连接到来（默认都用 <code>8910</code>）<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L38-L62">server/serve.go#L38-L62</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">Run</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  listener, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Listen</span>(<span style="color:#d14">&#34;tcp&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, s.cfg.Port))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Error listening: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> listener.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		conn, err <span style="color:#000;font-weight:bold">:=</span> listener.<span style="color:#900;font-weight:bold">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Error accepting: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> s.<span style="color:#900;font-weight:bold">handle</span>(conn)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Server handle 部分对 <code>MsgLogin</code> 进行校验，校验不通过直接断开连接<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L64-L79">server/serve.go#L64-L79</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handle</span>(conn net.Conn) {
</span></span><span style="display:flex;"><span>	loginMsg <span style="color:#000;font-weight:bold">:=</span> proto.MsgLogin{}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(conn, <span style="color:#000;font-weight:bold">&amp;</span>loginMsg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading from connection: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		conn.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	hash <span style="color:#000;font-weight:bold">:=</span> md5.<span style="color:#900;font-weight:bold">New</span>()
</span></span><span style="display:flex;"><span>	hash.<span style="color:#900;font-weight:bold">Write</span>([]<span style="color:#0086b3">byte</span>(s.cfg.Token <span style="color:#000;font-weight:bold">+</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%d&#34;</span>, loginMsg.Timestamp)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%x&#34;</span>, hash.<span style="color:#900;font-weight:bold">Sum</span>(<span style="color:#000;font-weight:bold">nil</span>)) <span style="color:#000;font-weight:bold">!=</span> loginMsg.Token {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Invalid token, client addr: %s&#34;</span>, conn.<span style="color:#900;font-weight:bold">RemoteAddr</span>().<span style="color:#900;font-weight:bold">String</span>())
</span></span><span style="display:flex;"><span>		conn.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><blockquote>
<p>这里最开始是想的返回 <code>MsgLoginResp</code> 但是发现其实没有必要，直接断开也是可以的</p>
</blockquote>
<p>这里用到 <code>proto.Send</code>，接下来会介绍 <code>message</code> 的实现</p>
<h3 id="message">Message</h3>
<p><code>TCP</code> 是 <code>Stream</code> 协议，我们并不知道需要读取多少字节，每个消息的长度也都是不固定的，所以需要实现自己的序列化规则</p>
<h4 id="format">format</h4>
<p>规定 <code>Message</code> 的 <code>format</code> 如下：</p>
<pre><code>|&lt;1 byte&gt;|&lt;2 byte&gt;|&lt;length byte&gt;|
|PacketType|Length| Json Message|
</code></pre>
<h4 id="packunpack">pack/unpack</h4>
<p><a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/packet.go#L42">proto/packet.go#L42</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">packet</span>(typ PacketType, msg <span style="color:#000;font-weight:bold">interface</span>{}) ([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	buf, err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Marshal</span>(msg)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">packet0</span>(typ, buf)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">packet0</span>(typ PacketType, buf []<span style="color:#458;font-weight:bold">byte</span>) ([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(buf) &gt; <span style="color:#099">65535</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, ErrMsgLength
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ret <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">3</span><span style="color:#000;font-weight:bold">+</span><span style="color:#0086b3">len</span>(buf))
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">0</span>] = <span style="color:#0086b3">byte</span>(typ)
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">1</span>] = <span style="color:#0086b3">byte</span>(<span style="color:#0086b3">len</span>(buf) <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#099">8</span>)
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">2</span>] = <span style="color:#0086b3">byte</span>(<span style="color:#0086b3">len</span>(buf))
</span></span><span style="display:flex;"><span>	<span style="color:#0086b3">copy</span>(ret[<span style="color:#099">3</span>:], buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> ret, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">read</span>(r io.Reader) (PacketType, []<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	typ, buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">read0</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> PacketUnknown, <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">PacketType</span>(typ), buf, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">read0</span>(r io.Reader) (typ <span style="color:#458;font-weight:bold">byte</span>, buf []<span style="color:#458;font-weight:bold">byte</span>, err <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	_, err = r.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	typ = buf[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>	_, err = r.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		err = ErrMsgRead
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	l <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">int</span>(buf[<span style="color:#099">0</span>])<span style="color:#000;font-weight:bold">&lt;&lt;</span><span style="color:#099">8</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#0086b3">int</span>(buf[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, l)
</span></span><span style="display:flex;"><span>	n, err <span style="color:#000;font-weight:bold">:=</span> io.<span style="color:#900;font-weight:bold">ReadFull</span>(r, buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> n <span style="color:#000;font-weight:bold">!=</span> l {
</span></span><span style="display:flex;"><span>		err = ErrMsgLength
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h4 id="sendrecv">send/recv</h4>
<p><a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/msg.go#L16">proto/msg.go#L16</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Send</span>(w io.Writer, msg Msg) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">packet</span>(msg.<span style="color:#900;font-weight:bold">Type</span>(), msg)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	_, err = w.<span style="color:#900;font-weight:bold">Write</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Recv</span>(r io.Reader, msg Msg) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	p, buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">read</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> p <span style="color:#000;font-weight:bold">!=</span> msg.<span style="color:#900;font-weight:bold">Type</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> ErrInvalidMsg
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>到这里 <code>Message</code> 的序列化和解析已经完成了，之后使用 <code>Msg</code> 或者添加新的 <code>Msg</code> 都不用关注这部分</p>
<h3 id="forward">Forward</h3>
<p>client 部分就是发送 <code>Forward</code> 消息，接收返回的 <code>ForwardResp</code><br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L88">client/serve.go#L88</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (f <span style="color:#000;font-weight:bold">*</span>Forwarder) <span style="color:#900;font-weight:bold">Run</span>() {
</span></span><span style="display:flex;"><span>	rConn, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(f.svraddr, f.token)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(rConn, proto.<span style="color:#900;font-weight:bold">NewMsgForward</span>(f.proxyName, f.subdomain,
</span></span><span style="display:flex;"><span>		f.proxyType, f.remotePort)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Error send forward msg to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	frdResp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgForwardResp{}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Recv</span>(rConn, frdResp); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatal</span>(<span style="color:#d14">&#34;Error reading forward resp msg from remote, please check your config&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> frdResp.Status <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#34;success&#34;</span> {
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Forward failed, status: %s, remote port: %d&#34;</span>, frdResp.Status, f.remotePort)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>发送后，如果检验成功，Client 端会在 <code>for</code> 循环里接收来自 Server 端的消息</p>
<p><strong>Server 端处理 <code>Forward</code> 消息</strong><br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L83-L107">server/serve.go#L83-L107</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>	pt, buf, err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Read</span>(conn)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading from connection: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> pt {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">case</span> proto.PacketForwardReq:
</span></span><span style="display:flex;"><span>		failChan <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>(<span style="color:#000;font-weight:bold">chan</span> <span style="color:#000;font-weight:bold">struct</span>{})
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> <span style="color:#0086b3">close</span>(failChan)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">&lt;-</span>failChan
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Send</span>(conn, proto.<span style="color:#900;font-weight:bold">NewMsgForwardResp</span>(<span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;failed&#34;</span>)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error sending forward failed resp message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		msg <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgForwardReq{}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error unmarshalling message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		s.<span style="color:#900;font-weight:bold">handleForward</span>(conn, msg, failChan)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p><code>handleForward</code> 函数<br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L133">server/serve.go#L133</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handleForward</span>(cConn net.Conn, msg <span style="color:#000;font-weight:bold">*</span>proto.MsgForwardReq, failChan <span style="color:#000;font-weight:bold">chan</span> <span style="color:#000;font-weight:bold">struct</span>{}) {
</span></span><span style="display:flex;"><span>	uPort <span style="color:#000;font-weight:bold">:=</span> msg.RemotePort
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !s.<span style="color:#900;font-weight:bold">availablePort</span>(uPort) {
</span></span><span style="display:flex;"><span>		failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	from <span style="color:#000;font-weight:bold">:=</span> cConn.<span style="color:#900;font-weight:bold">RemoteAddr</span>().<span style="color:#900;font-weight:bold">String</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>		uListener, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Listen</span>(<span style="color:#d14">&#34;tcp&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, uPort))
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> uListener.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(cConn, proto.<span style="color:#900;font-weight:bold">NewMsgForwardResp</span>(domain, <span style="color:#d14">&#34;success&#34;</span>)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			userConn, err <span style="color:#000;font-weight:bold">:=</span> uListener.<span style="color:#900;font-weight:bold">Accept</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>				uid <span style="color:#000;font-weight:bold">:=</span> conn.<span style="color:#900;font-weight:bold">NewUuid</span>()
</span></span><span style="display:flex;"><span>				s.tcpConnMap.<span style="color:#900;font-weight:bold">Add</span>(uid, userConn)
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Send</span>(cConn, proto.<span style="color:#900;font-weight:bold">NewMsgExchange</span>(uid, msg.ProxyType)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error sending exchange message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>大概流程就是：</p>
<ol>
<li>check port available</li>
<li>发送 <code>ForwardResp</code> 消息</li>
<li>创建 <code>uListener</code> 并且等待用户连接</li>
<li>收到用户连接，创建 <code>uuid</code>，发送 <code>Exchange</code> 消息</li>
</ol>
<h3 id="exchange">Exchange</h3>
<p><a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L124">client/serve.go#L124</a><br>
Client 端从发送 <code>Forward</code> 消息后的 <code>for</code> 里不断获取消息，然后如果是 <code>Exchange</code> 消息</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		p, buf, err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Read</span>(rConn)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			f.logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading msg from remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		nlogger <span style="color:#000;font-weight:bold">:=</span> f.logger.<span style="color:#900;font-weight:bold">CloneAdd</span>(p.<span style="color:#900;font-weight:bold">String</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">switch</span> p {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">case</span> proto.PacketExchange:
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgExchange{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">cancelForward</span>(f.token, f.svraddr, f.proxyName, f.localPort, f.remotePort)
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>					nRconn, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(f.svraddr, f.token)
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						nlogger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error connecting to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>						<span style="color:#900;font-weight:bold">cancelForward</span>(f.token, f.svraddr, f.proxyName, f.localPort, f.remotePort)
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(nRconn, proto.<span style="color:#900;font-weight:bold">NewMsgExchange</span>(msg.ConnId, f.proxyType)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						nlogger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Error sending exchange msg to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					lConn, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Dial</span>(msg.ProxyType, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, f.localPort))
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						nlogger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error connecting to local: %v, will close forward, %s:%d&#34;</span>, err, f.proxyType, f.localPort)
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					proxy.<span style="color:#900;font-weight:bold">Stream</span>(lConn, nRconn)
</span></span><span style="display:flex;"><span>				}()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>这里可以看到逻辑很简单</p>
<ol>
<li>接收到 <code>Exchange</code> 消息后</li>
<li>创建新的 Server 连接</li>
<li>根据 <code>ProxyType</code> 来创建 <code>Local</code> 连接</li>
<li>调用 <code>proxy.Stream</code> 进行流量 <code>Copy</code></li>
</ol>
<p>Server 端接收到 <code>Exchange</code> 消息就很简单了，从 <code>tcpConnMap</code> 里拿出对应的连接，然后同样的 <code>proxy.Stream</code> 进行流量 <code>Copy</code><br>
<a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L254">server/serve.go#L254</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handleExchange</span>(conn net.Conn, msg <span style="color:#000;font-weight:bold">*</span>proto.MsgExchange) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>		uConn, ok <span style="color:#000;font-weight:bold">:=</span> s.tcpConnMap.<span style="color:#900;font-weight:bold">Get</span>(msg.ConnId)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> !ok {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> s.tcpConnMap.<span style="color:#900;font-weight:bold">Del</span>(msg.ConnId)
</span></span><span style="display:flex;"><span>		proxy.<span style="color:#900;font-weight:bold">Stream</span>(conn, uConn)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="conclusion">Conclusion</h3>
<p>到此，<code>Pipe</code> 的实现已经差不多，基本上列出了完整的流程，接下来会写下 <code>Pipe</code> 所实现的 <code>Feature</code></p>
<h2 id="feat">Feat</h2>
<h3 id="auto-subdomain-https">Auto subdomain https</h3>
<p>目标是实现一个自动 <code>Subdomain</code> 分配并且支持 <code>Https</code><br>
也就是加入 Server 运行在 <code>example.com</code> 机器，Client 开启转发 <code>Local 3000</code> 到 <code>Server 9000</code> 端口<br>
Server 会生成 <code>xxx.example.com</code> 的 <code>Subdomain</code>，可以通过 <code>https://xxx.example.com</code> 来访问 Client <code>Local 3000</code><br>
因为不太想过于麻烦的实现 <code>Https</code>，所以借助 <code>Caddy</code> 来做 <code>Https</code> 的部分<br>
代码在 <a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/caddy_service.go#L22">server/caddy_service.go#L22</a><br>
借助 <code>Caddy</code> 的 <code>API</code> 添加 <code>https</code> 的 <code>route</code></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">addCaddyRouter</span>(host <span style="color:#458;font-weight:bold">string</span>, port <span style="color:#458;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>	tunnelId <span style="color:#000;font-weight:bold">:=</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%s.%d&#34;</span>, host, port)
</span></span><span style="display:flex;"><span>	resp, err <span style="color:#000;font-weight:bold">:=</span> http.<span style="color:#900;font-weight:bold">Post</span>(caddyAddRouteUrl, <span style="color:#d14">&#34;application/json&#34;</span>, bytes.<span style="color:#900;font-weight:bold">NewBuffer</span>([]<span style="color:#0086b3">byte</span>(fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(caddyAddRouteF, tunnelId, host, port))))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Tunnel creation failed, err: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> resp.Body.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	resp, err = http.<span style="color:#900;font-weight:bold">Post</span>(caddyAddTlsSubjectsUrl, <span style="color:#d14">&#34;application/json&#34;</span>, bytes.<span style="color:#900;font-weight:bold">NewBuffer</span>([]<span style="color:#0086b3">byte</span>(fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;\&#34;%s\&#34;&#34;</span>, host))))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Tunnel creation failed, err: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> resp.Body.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>	logger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Tunnel created successfully, id: %s, host: %s&#34;</span>, tunnelId, cr.<span style="color:#900;font-weight:bold">PWhiteUnderline</span>(host))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>前置准备：</p>
<ol>
<li>要先设置好域名 <code>DNS</code> 解析，要设置两条记录 <code>A *.example.com &lt;your server ip&gt;</code> 和 <code>A example.com &lt;your server ip&gt;</code></li>
<li>运行 <code>Caddy</code>（如果是 <code>Cloudflare DNS</code> 还需要自己编译支持 <code>Cloudflare DNS plugin</code> 的 <code>Caddy</code> 版本，以及配置里填写 <code>Cloudflare KEY</code>，具体流程如有需要网上找下应该可以找到）</li>
<li>Server 端带上支持 <code>Subdomain</code> 的参数，可以看项目 <code>README.md</code></li>
</ol>
<h3 id="deploy-at-flyio">Deploy at <code>fly.io</code></h3>
<p><strong>这里很重要的一点是，只能部署 1 个 Service</strong></p>
<blockquote>
<p>部署多个不行吗？<br>
不行，因为部署多个，<code>fly</code> 会做 <code>Load Balancing</code>，导致有的用户请求，因为没在 <code>tcpConnMap</code> 里，就没法 <code>Copy</code> 成功（<code>yamux</code> 或许可以解决这个问题）</p>
</blockquote>
<p>因为 <code>fly.io</code> 支持 <code>Dockerfile</code>，所以只用简单的写个 <code>Dockerfile</code> 即可<br>
关键是 <code>fly.toml</code></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>app = <span style="color:#d14">&#34;pipefly&#34;</span>
</span></span><span style="display:flex;"><span>primary_region = <span style="color:#d14">&#34;hkg&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[build]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Control</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">8910</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">8910</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Admin</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">8911</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;tls&#34;</span>, <span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">443</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Forward TCP</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">9000</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;tls&#34;</span>, <span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">9000</span>
</span></span></code></pre><p><code>Control</code> 和 <code>Admin</code> 因为都是 <code>TCP</code>，所以 <code>protocol</code> 是 <code>tcp</code>，然后 <code>Admin</code> 希望直接从 <a href="https://pipefly.fly.dev/">https://pipefly.fly.dev/</a> 访问，就需要加上 <code>handlers = [&quot;http&quot;]</code> 以及 <code>https</code> 的 <code>handlers = [&quot;tls&quot;, &quot;http&quot;]</code></p>
<p>然后这里需要在配置里指定出 <code>Forward</code> 的端口，这样运行 Server 和 Client 后<br>
访问 <a href="https://pipefly.fly.dev:9000">https://pipefly.fly.dev:9000</a> 就会访问到 Client <code>Local 3000</code> 了</p>
<blockquote>
<p>ps. <code>UDP</code> 的配置，<code>fly.io</code> 也是支持的，可以看 <code>fly</code> 的文档，或者可以看这个例子 <a href="https://github.com/AnimMouse/frp-flyapp">AnimMouse/frp-flyapp</a></p>
</blockquote>
<h3 id="udp"><code>UDP</code></h3>
<p><code>UDP</code> 的支持，因为 <code>UDP</code> 没有连接的概念，只有 <code>Packet</code> 概念，所以我们可以「封装」<code>UDP</code> 流量为 <code>MsgUDPDatagram</code>，然后做流量的 <code>Copy</code></p>
<p><a href="https://github.com/abcdlsj/pipe/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proxy/udp.go#L1-L77">proxy/udp.go#L1-L77</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;github.com/abcdlsj/pipe/logger&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;github.com/abcdlsj/pipe/proto&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">UDPClientStream</span>(token <span style="color:#458;font-weight:bold">string</span>, tcp, udp io.ReadWriteCloser) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> proto.MsgUDPDatagram{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(tcp, <span style="color:#000;font-weight:bold">&amp;</span>msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			n, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">Write</span>(msg.Payload)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> n <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">len</span>(msg.Payload) {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		buf <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">4096</span>)
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(tcp, proto.<span style="color:#900;font-weight:bold">NewMsgUDPDatagram</span>(<span style="color:#000;font-weight:bold">nil</span>, buf[:n])); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">UDPDatagram</span>(token <span style="color:#458;font-weight:bold">string</span>, tcp io.ReadWriteCloser, udp <span style="color:#000;font-weight:bold">*</span>net.UDPConn) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		buf <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">4096</span>)
</span></span><span style="display:flex;"><span>		n, addr, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">ReadFromUDP</span>(buf)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(tcp, proto.<span style="color:#900;font-weight:bold">NewMsgUDPDatagram</span>(addr, buf[:n])); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> proto.MsgUDPDatagram{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(tcp, <span style="color:#000;font-weight:bold">&amp;</span>msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			_, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">WriteTo</span>(msg.Payload, addr)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>相当于 <code>TCP</code> 转发里的 <code>proxy.Stream</code> 替代</p>
<h3 id="speed-limit">Speed limit</h3>
<p>得益于 <code>io.Reader</code> 和 <code>io.Writer</code> 接口，以及 <code>rate</code> 包，实现限速其实也很简单</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> LimitStream <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	rw       io.ReadWriteCloser
</span></span><span style="display:flex;"><span>	ctx      context.Context
</span></span><span style="display:flex;"><span>	wlimiter <span style="color:#000;font-weight:bold">*</span>rate.Limiter
</span></span><span style="display:flex;"><span>	rlimiter <span style="color:#000;font-weight:bold">*</span>rate.Limiter
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">NewLimitStream</span>(rw io.ReadWriteCloser, limit <span style="color:#458;font-weight:bold">int</span>) <span style="color:#000;font-weight:bold">*</span>LimitStream {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">&amp;</span>LimitStream{
</span></span><span style="display:flex;"><span>		rw:       rw,
</span></span><span style="display:flex;"><span>		ctx:      context.<span style="color:#900;font-weight:bold">Background</span>(),
</span></span><span style="display:flex;"><span>		wlimiter: rate.<span style="color:#900;font-weight:bold">NewLimiter</span>(rate.<span style="color:#900;font-weight:bold">Limit</span>(limit), limit), <span style="color:#998;font-style:italic">// set burst = limit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		rlimiter: rate.<span style="color:#900;font-weight:bold">NewLimiter</span>(rate.<span style="color:#900;font-weight:bold">Limit</span>(limit), limit), <span style="color:#998;font-style:italic">// set burst = limit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>LimitStream) <span style="color:#900;font-weight:bold">Read</span>(p []<span style="color:#458;font-weight:bold">byte</span>) (<span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> s.rlimiter <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> s.rw.<span style="color:#900;font-weight:bold">Read</span>(p)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	do <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">func</span>(r <span style="color:#000;font-weight:bold">*</span>LimitStream, p []<span style="color:#458;font-weight:bold">byte</span>) (<span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> r.rw.<span style="color:#900;font-weight:bold">Read</span>(p)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> n, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> r.rlimiter.<span style="color:#900;font-weight:bold">WaitN</span>(r.ctx, n); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> n, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> n, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(p) &lt; s.rlimiter.<span style="color:#900;font-weight:bold">Burst</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">do</span>(s, p)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	burst <span style="color:#000;font-weight:bold">:=</span> s.rlimiter.<span style="color:#900;font-weight:bold">Burst</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> read <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#099">0</span>; i &lt; <span style="color:#0086b3">len</span>(p); i <span style="color:#000;font-weight:bold">+=</span> burst {
</span></span><span style="display:flex;"><span>		end <span style="color:#000;font-weight:bold">:=</span> i <span style="color:#000;font-weight:bold">+</span> burst
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> end &gt; <span style="color:#0086b3">len</span>(p) {
</span></span><span style="display:flex;"><span>			end = <span style="color:#0086b3">len</span>(p)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">do</span>(s, p[i:end])
</span></span><span style="display:flex;"><span>		read <span style="color:#000;font-weight:bold">+=</span> n
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> read, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> read, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>原理就是，假如说我们想要限速到 <code>10k/s</code>，那么就初始化 <code>burst=10k</code> 的 <code>rate.Limiter</code><br>
<code>Read</code> 的时候，调用 <code>WaitN</code>，因为容量为 <code>10k</code>，所以 <code>WaitN</code> 每读取 <code>10k byte</code> 就会等待 <code>1s</code><br>
这样就实现了 <code>10k/s</code> 的限速，而且使用上非常简单，初始化一个 <code>LimitStream</code> 就可以了</p>
<h2 id="done">Done</h2>
<p>写了下如何实现一个内网转发的小工具，代码本身还有很多可以优化的地方，比如</p>
<ol>
<li>完善「错误处理」「重试」，对于哪些错误需要重试，哪些错误直接退出</li>
<li>支持更多转发协议，例如 <code>HTTP/Quic/WebSocket</code>，<code>Control</code> 协议也可以支持更多，目前是 <code>TCP</code>，可以支持 <code>UDP/KCP</code> 等</li>
<li>完善监控采集，这部分可以用 <code>Prometheus</code>，但是对于小项目来说太麻烦了</li>
<li><code>Load Balancing</code> 这部分一直在思考如何做，从上边 <code>fly.io</code> 的部署就能知道，<code>Server</code> 端访问只能是单机的</li>
</ol>
<p>写这个小项目后感觉到，项目是很难「维护」的，而且因为个人的局限性，代码一开始很难做出合理的「抽象」，导致后续有代码改动的时候会变很困难。之前写一些几百行的小项目还不觉得，现在这个项目代码量变多后，感觉代码「结构」、「接口」还是不够「清晰」。</p>
<p>感谢阅读！</p>
<h2 id="refs">refs</h2>
<p><a href="https://pandaychen.github.io/2020/01/01/MAGIC-GO-IO-PACKAGE/">https://pandaychen.github.io/2020/01/01/MAGIC-GO-IO-PACKAGE/</a><br>
<a href="https://github.com/ekzhang/bore">https://github.com/ekzhang/bore</a><br>
<a href="https://github.com/rapiz1/rathole">https://github.com/rapiz1/rathole</a><br>
<a href="https://github.com/AnimMouse/frp-flyapp">https://github.com/AnimMouse/frp-flyapp</a></p>
</article>
    </main>
    <hr class="divider" />
    
<footer class="footer">
  <p class="footer-author">
    Author <a href="https://github.com/abcdlsj">abcdlsj</a>
  </p>
  <p class="footer-proj">
    Source
    <a href="https://github.com/abcdlsj/abcdlsj.github.io">abcdlsj.github.io</a>
  </p>
</footer>

  </body>
</html>

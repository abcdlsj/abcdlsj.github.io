
<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8" />
<title>abcdlsj</title>
<meta name="description" content="Enjoy Focus!" />
<meta name="author" content="Author" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="stylesheet" href="/static/style.css" />

    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body class="container">
    <div class="navbar">
<nav class="navbar">
  
  <ul>
    <li>
      <a href="/" class="menu">#Home</a>
    </li>
  </ul>
  
  <ul>
    <li>
      <a href="/about" class="menu">#About</a>
    </li>
  </ul>
  
</nav>
</div>
    <hr class="divider" />
    <h1 class="post-title">Tally - Build a tool like tokei/scc</h1>
    <div class="post-meta">
      <div class="post-date">Date: 2023-08-16T18:47:37+08:00</div>
      <nav class="post-tags">
        
        <a href="/tags/explore.html" class="tag">#explore</a>
        
      </nav>
    </div>
    <hr class="divider" />
    <main class="post-content">
      <article><h1>Table of Contents</h1>
<ul>
<li>
<ul>
<li>
<a href="#first">First</a></li>
<li>
<a href="#explain">Explain</a><ul>
<li>
<a href="#walk-directory-tree">Walk directory tree</a></li>
<li>
<a href="#read-file-and-count-lines">Read file and Count lines</a></li>
<li>
<a href="#output-result">Output result</a></li>
</ul>
</li>
<li>
<a href="#benchmark">Benchmark</a><ul>
<li>
<a href="#tokei">Tokei</a></li>
<li>
<a href="#tally">Tally</a></li>
</ul>
</li>
<li>
<a href="#optimize1---parallel">Optimize1 - Parallel</a></li>
<li>
<a href="#optimize2---bufio-scanner-countline">Optimize2 - Bufio scanner countline</a></li>
<li>
<a href="#optimize3---faster-filepath-walking">Optimize3 - Faster filepath walking</a></li>
<li>
<a href="#end">End</a></li>
<li>
<a href="#ref">Ref</a></li>
</ul>
</li>
</ul>
<h2 id="first">First</h2>
<p>I want to build a tool like <code>scc</code>, <code>tokei</code>, just for learning. It was very easy to write a simple version: <a href="https://github.com/abcdlsj/share/blob/7ac6cbbf36a9d72b09603b160569db5f5a27fa81/go/tally/main.go">tally - first commit</a>.<br>
I will to optimize it at the second half of this post.</p>
<p>At first, Let me to explain it for you.</p>
<h2 id="explain">Explain</h2>
<p>The counting-line machine worked similar to the <code>Putting elephants in the freezer</code>, so the steps are:</p>
<ol>
<li>Walk directory tree.</li>
<li>Read file and Count lines.</li>
<li>Output result.</li>
</ol>
<h3 id="walk-directory-tree">Walk directory tree</h3>
<p>Use <code>filepath.Walk</code> to walk directory tree, it's very easy to use.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>	filepath.<span style="color:#900;font-weight:bold">Walk</span>(os.Args[<span style="color:#099">1</span>], <span style="color:#000;font-weight:bold">func</span>(path <span style="color:#458;font-weight:bold">string</span>, info os.FileInfo, err <span style="color:#458;font-weight:bold">error</span>) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#0086b3">panic</span>(err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> info.<span style="color:#900;font-weight:bold">IsDir</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">countLine</span>(path)
</span></span><span style="display:flex;"><span>	})
</span></span></code></pre><h3 id="read-file-and-count-lines">Read file and Count lines</h3>
<p>Count line we need to know what is a line. A line is a string end with <code>\n</code> or <code>\r\n</code>. So we can just split the file content with <code>\n</code> or <code>\r\n</code> to get the lines.</p>
<p>Because we need to count the code lines, so we need to ignore the comment lines. I just use a simple way to ignore the comment lines, just ignore the line start with a rule string(<strong>by the way: the first version I just conside the single line comment.</strong>).</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> Counter <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	idx     <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	lang    <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	comment <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	exts    []<span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">var</span> (
</span></span><span style="display:flex;"><span>	Go       = Counter{<span style="color:#099">1</span>, <span style="color:#d14">&#34;Go&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.go&#34;</span>)}
</span></span><span style="display:flex;"><span>	Rust     = Counter{<span style="color:#099">2</span>, <span style="color:#d14">&#34;Rust&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.rs&#34;</span>)}
</span></span><span style="display:flex;"><span>	Java     = Counter{<span style="color:#099">3</span>, <span style="color:#d14">&#34;Java&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.java&#34;</span>)}
</span></span><span style="display:flex;"><span>	Python   = Counter{<span style="color:#099">4</span>, <span style="color:#d14">&#34;Python&#34;</span>, <span style="color:#d14">&#34;#&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.py&#34;</span>)}
</span></span><span style="display:flex;"><span>	C        = Counter{<span style="color:#099">5</span>, <span style="color:#d14">&#34;C&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.c&#34;</span>, <span style="color:#d14">&#34;.h&#34;</span>)}
</span></span><span style="display:flex;"><span>	Cpp      = Counter{<span style="color:#099">6</span>, <span style="color:#d14">&#34;C++&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.cpp&#34;</span>, <span style="color:#d14">&#34;.hpp&#34;</span>)}
</span></span><span style="display:flex;"><span>	Js       = Counter{<span style="color:#099">7</span>, <span style="color:#d14">&#34;Javascript&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.js&#34;</span>)}
</span></span><span style="display:flex;"><span>	Ts       = Counter{<span style="color:#099">8</span>, <span style="color:#d14">&#34;Typescript&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.ts&#34;</span>)}
</span></span><span style="display:flex;"><span>	HTML     = Counter{<span style="color:#099">9</span>, <span style="color:#d14">&#34;HTML&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.html&#34;</span>, <span style="color:#d14">&#34;.htm&#34;</span>)}
</span></span><span style="display:flex;"><span>	JSON     = Counter{<span style="color:#099">10</span>, <span style="color:#d14">&#34;JSON&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.json&#34;</span>)}
</span></span><span style="display:flex;"><span>	Protobuf = Counter{<span style="color:#099">11</span>, <span style="color:#d14">&#34;Protobuf&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.proto&#34;</span>)}
</span></span><span style="display:flex;"><span>	Markdown = Counter{<span style="color:#099">12</span>, <span style="color:#d14">&#34;Markdown&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.md&#34;</span>)}
</span></span><span style="display:flex;"><span>	Shell    = Counter{<span style="color:#099">13</span>, <span style="color:#d14">&#34;Shell&#34;</span>, <span style="color:#d14">&#34;#&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.sh&#34;</span>)}
</span></span><span style="display:flex;"><span>	YAML     = Counter{<span style="color:#099">14</span>, <span style="color:#d14">&#34;YAML&#34;</span>, <span style="color:#d14">&#34;#&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.yaml&#34;</span>, <span style="color:#d14">&#34;.yml&#34;</span>)}
</span></span><span style="display:flex;"><span>)
</span></span></code></pre><p><strong>vec is a function to create a slice. (Nostalgia for <code>Rust vec!</code>  :smile:)</strong></p>
<p>Count line logic:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">countLine</span>(path <span style="color:#458;font-weight:bold">string</span>) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	data, err <span style="color:#000;font-weight:bold">:=</span> os.<span style="color:#900;font-weight:bold">ReadFile</span>(path)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">guessLang</span>(path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> c.lang <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	lines <span style="color:#000;font-weight:bold">:=</span> bytes.<span style="color:#900;font-weight:bold">Split</span>(data, []<span style="color:#0086b3">byte</span>(<span style="color:#d14">&#34;\n&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	item <span style="color:#000;font-weight:bold">:=</span> Item{
</span></span><span style="display:flex;"><span>		lang:  c.lang,
</span></span><span style="display:flex;"><span>		lines: <span style="color:#0086b3">len</span>(lines),
</span></span><span style="display:flex;"><span>		files: <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> _, line <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">range</span> lines {
</span></span><span style="display:flex;"><span>		line <span style="color:#000;font-weight:bold">:=</span> bytes.<span style="color:#900;font-weight:bold">TrimSpace</span>(line)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(line) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			item.blank<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> c.<span style="color:#900;font-weight:bold">isComment</span>(line) {
</span></span><span style="display:flex;"><span>			item.comment<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		item.code<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	result.<span style="color:#900;font-weight:bold">Add</span>(c, item)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="output-result">Output result</h3>
<p>Actually, this is the most hard part. you need to output the result intuitively. thanks to <code>tokei</code> and <code>scc</code>, I just copy the output format from them :smile:.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (r <span style="color:#000;font-weight:bold">*</span>Result) <span style="color:#900;font-weight:bold">String</span>() {
</span></span><span style="display:flex;"><span>	itemF <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">&#34;%-10s %10d %10d %10d %10d %10d\n&#34;</span>
</span></span><span style="display:flex;"><span>	headerF <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">&#34;%-10s %10s %10s %10s %10s %10s\n&#34;</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(headerF, <span style="color:#d14">&#34;Language&#34;</span>, <span style="color:#d14">&#34;Files&#34;</span>, <span style="color:#d14">&#34;Lines&#34;</span>, <span style="color:#d14">&#34;Code&#34;</span>, <span style="color:#d14">&#34;Comments&#34;</span>, <span style="color:#d14">&#34;Blanks&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> total Item
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sort.<span style="color:#900;font-weight:bold">Slice</span>(r.data, <span style="color:#000;font-weight:bold">func</span>(i, j <span style="color:#458;font-weight:bold">int</span>) <span style="color:#458;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> r.data[i].lines &gt; r.data[j].lines
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> _, item <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">range</span> r.data {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> item.files <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		total = <span style="color:#900;font-weight:bold">mergeItem</span>(total, item)
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#900;font-weight:bold">Printf</span>(itemF, item.lang, item.files, item.lines, item.code, item.comment, item.blank)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(itemF, <span style="color:#d14">&#34;Total&#34;</span>, total.files, total.lines, total.code, total.comment, total.blank)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Test it.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>go install
</span></span><span style="display:flex;"><span>tally .
</span></span></code></pre><pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span><span style="display:flex;"><span>Language        Files      Lines       Code   Comments     Blanks
</span></span><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span><span style="display:flex;"><span>Go                  1        242        199          0         43
</span></span><span style="display:flex;"><span>Markdown            1          3          2          0          1
</span></span><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span><span style="display:flex;"><span>Total               2        245        201          0         44
</span></span><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span></code></pre><p>All done! let's benchmark it.</p>
<h2 id="benchmark">Benchmark</h2>
<p>use <code>time</code>  for benchmarks is not accurate enough. <a href="https://stackoverflow.com/questions/9006596/is-the-unix-time-command-accurate-enough-for-benchmarks">stackoverflow - Is the UNIX <code>time</code> command accurate enough for benchmarks? [closed]</a><br>
so use <code>perf stat</code> for benchmarks at my <code>Intel(R) N100</code> machine.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>perf stat -r <span style="color:#099">10</span> -d <span style="color:#000;font-weight:bold">{</span>xxx<span style="color:#000;font-weight:bold">}</span> .
</span></span></code></pre><p>Test repo: <a href="https://github.com/firecracker-microvm/firecracker">https://github.com/firecracker-microvm/firecracker</a></p>
<h3 id="tokei">Tokei</h3>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;tokei .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             69.13 msec task-clock                <span style="color:#998;font-style:italic">#    2.481 CPUs utilized            ( +- 11.54% )</span>
</span></span><span style="display:flex;"><span>                <span style="color:#099">51</span>      context-switches          <span style="color:#998;font-style:italic">#  553.733 /sec                     ( +-  6.59% )</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#099">3</span>      cpu-migrations            <span style="color:#998;font-style:italic">#   32.573 /sec                     ( +- 12.62% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">684</span>      page-faults               <span style="color:#998;font-style:italic">#    7.427 K/sec                    ( +-  1.02% )</span>
</span></span><span style="display:flex;"><span>       188,619,115      cycles                    <span style="color:#998;font-style:italic">#    2.048 GHz                      ( +-  0.12% )</span>
</span></span><span style="display:flex;"><span>       436,763,869      instructions              <span style="color:#998;font-style:italic">#    2.31  insn per cycle           ( +-  0.02% )</span>
</span></span><span style="display:flex;"><span>       107,324,341      branches                  <span style="color:#998;font-style:italic">#    1.165 G/sec                    ( +-  0.02% )</span>
</span></span><span style="display:flex;"><span>           827,429      branch-misses             <span style="color:#998;font-style:italic">#    0.77% of all branches          ( +-  0.25% )</span>
</span></span><span style="display:flex;"><span>       117,783,424      L1-dcache-loads           <span style="color:#998;font-style:italic">#    1.279 G/sec                    ( +-  0.02% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>            69,479      LLC-loads                 <span style="color:#998;font-style:italic">#  754.369 K/sec                    ( +-  0.72% )</span>
</span></span><span style="display:flex;"><span>            16,783      LLC-load-misses           <span style="color:#998;font-style:italic">#   23.79% of all LL-cache accesses  ( +-  3.05% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           0.02786 +- 0.00227 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +-  8.13% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><h3 id="tally">Tally</h3>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             41.15 msec task-clock                <span style="color:#998;font-style:italic">#    1.050 CPUs utilized            ( +-  1.02% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">199</span>      context-switches          <span style="color:#998;font-style:italic">#    4.812 K/sec                    ( +-  3.37% )</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#099">7</span>      cpu-migrations            <span style="color:#998;font-style:italic">#  169.267 /sec                     ( +- 13.47% )</span>
</span></span><span style="display:flex;"><span>             6,710      page-faults               <span style="color:#998;font-style:italic">#  162.254 K/sec                    ( +-  1.52% )</span>
</span></span><span style="display:flex;"><span>       133,015,106      cycles                    <span style="color:#998;font-style:italic">#    3.216 GHz                      ( +-  0.40% )</span>
</span></span><span style="display:flex;"><span>       147,895,882      instructions              <span style="color:#998;font-style:italic">#    1.12  insn per cycle           ( +-  0.26% )</span>
</span></span><span style="display:flex;"><span>        30,824,314      branches                  <span style="color:#998;font-style:italic">#  745.361 M/sec                    ( +-  0.22% )</span>
</span></span><span style="display:flex;"><span>           268,672      branch-misses             <span style="color:#998;font-style:italic">#    0.86% of all branches          ( +-  0.27% )</span>
</span></span><span style="display:flex;"><span>        38,861,478      L1-dcache-loads           <span style="color:#998;font-style:italic">#  939.707 M/sec                    ( +-  0.26% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>           633,051      LLC-loads                 <span style="color:#998;font-style:italic">#   15.308 M/sec                    ( +-  0.41% )</span>
</span></span><span style="display:flex;"><span>           322,198      LLC-load-misses           <span style="color:#998;font-style:italic">#   51.64% of all LL-cache accesses  ( +-  0.65% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          0.039192 +- 0.000357 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +-  0.91% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><p><strong>Result</strong>: we can see, the origin version is faster enough even faster then <code>tokei</code>, because <code>tokei</code> have more complex features and the count of files is small.</p>
<h2 id="optimize1---parallel">Optimize1 - Parallel</h2>
<p>Walking file paralleling. I searched out a post about this, <a href="https://stackoverflow.com/questions/44255814/concurrent-filesystem-scanning">stackoverflow - Concurrent filesystem scanning</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> func main() {
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-	if len(os.Args) &lt; 2 {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+	if len(os.Args) != 2 {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 		fmt.Println(&#34;Usage: ./main &lt;path&gt;&#34;)
</span></span><span style="display:flex;"><span> 		os.Exit(1)
</span></span><span style="display:flex;"><span> 	}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-	filepath.Walk(os.Args[1], func(path string, info os.FileInfo, err error) error {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+	var wgCalc sync.WaitGroup
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	paths := make(chan string, 100)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	defer close(paths)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	wgCalc.Add(1)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	go func() {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		defer wgCalc.Done()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		for path := range paths {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			if path == &#34;__end_flag_tally&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+				return
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			wgCalc.Add(1)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			go func(path string) {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+				defer wgCalc.Done()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+				calculate(path)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			}(path)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	}()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	var wgWalk sync.WaitGroup
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	wgWalk.Add(1)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	go func() {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		defer wgWalk.Done()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		WalkParallel(&amp;wgWalk, os.Args[1], paths)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	}()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	wgWalk.Wait()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	paths &lt;- &#34;__end_flag_tally&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	wgCalc.Wait()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	result.String()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+func WalkParallel(wg *sync.WaitGroup, dir string, paths chan&lt;- string) {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	filepath.Walk(dir, func(path string, info os.FileInfo, err error) error {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 		if err != nil {
</span></span><span style="display:flex;"><span> 			panic(err)
</span></span><span style="display:flex;"><span> 		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-		if info.IsDir() {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-			return nil
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+		if info.IsDir() &amp;&amp; path != dir {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			wg.Add(1)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			go func() {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+				defer wg.Done()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+				WalkParallel(wg, path, paths)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			}()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			return filepath.SkipDir
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-		return calculate(path)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+		paths &lt;- path
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		return nil
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	})
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-
</span></span></span></code></pre><p>with <code>paths chan capacity=10</code></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally_walk10 .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            105.76 msec task-clock                <span style="color:#998;font-style:italic">#    2.573 CPUs utilized            ( +-  5.49% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">392</span>      context-switches          <span style="color:#998;font-style:italic">#    3.432 K/sec                    ( +- 15.47% )</span>
</span></span><span style="display:flex;"><span>                <span style="color:#099">41</span>      cpu-migrations            <span style="color:#998;font-style:italic">#  358.962 /sec                     ( +- 10.96% )</span>
</span></span><span style="display:flex;"><span>             7,335      page-faults               <span style="color:#998;font-style:italic">#   64.219 K/sec                    ( +-  3.52% )</span>
</span></span><span style="display:flex;"><span>       181,829,636      cycles                    <span style="color:#998;font-style:italic">#    1.592 GHz                      ( +-  1.05% )</span>
</span></span><span style="display:flex;"><span>       188,274,662      instructions              <span style="color:#998;font-style:italic">#    0.99  insn per cycle           ( +-  0.65% )</span>
</span></span><span style="display:flex;"><span>        38,091,153      branches                  <span style="color:#998;font-style:italic">#  333.495 M/sec                    ( +-  0.57% )</span>
</span></span><span style="display:flex;"><span>           392,566      branch-misses             <span style="color:#998;font-style:italic">#    1.00% of all branches          ( +-  1.98% )</span>
</span></span><span style="display:flex;"><span>        48,955,270      L1-dcache-loads           <span style="color:#998;font-style:italic">#  428.612 M/sec                    ( +-  0.63% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>           713,386      LLC-loads                 <span style="color:#998;font-style:italic">#    6.246 M/sec                    ( +-  1.48% )</span>
</span></span><span style="display:flex;"><span>           186,519      LLC-load-misses           <span style="color:#998;font-style:italic">#   25.09% of all LL-cache accesses  ( +-  6.00% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           0.04110 +- 0.00219 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +-  5.33% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><p>But the result shows it's not <code>expected</code>.<br>
Why?</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally_walk100 .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            149.63 msec task-clock                <span style="color:#998;font-style:italic">#    2.970 CPUs utilized            ( +-  3.94% )</span>
</span></span><span style="display:flex;"><span>             1,250      context-switches          <span style="color:#998;font-style:italic">#    9.855 K/sec                    ( +- 10.07% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">229</span>      cpu-migrations            <span style="color:#998;font-style:italic">#    1.805 K/sec                    ( +- 11.05% )</span>
</span></span><span style="display:flex;"><span>             8,715      page-faults               <span style="color:#998;font-style:italic">#   68.707 K/sec                    ( +-  3.08% )</span>
</span></span><span style="display:flex;"><span>       246,295,457      cycles                    <span style="color:#998;font-style:italic">#    1.942 GHz                      ( +-  2.79% )</span>
</span></span><span style="display:flex;"><span>       239,901,377      instructions              <span style="color:#998;font-style:italic">#    1.18  insn per cycle           ( +-  2.46% )</span>
</span></span><span style="display:flex;"><span>        47,265,335      branches                  <span style="color:#998;font-style:italic">#  372.630 M/sec                    ( +-  2.35% )</span>
</span></span><span style="display:flex;"><span>           498,222      branch-misses             <span style="color:#998;font-style:italic">#    1.20% of all branches          ( +-  2.47% )</span>
</span></span><span style="display:flex;"><span>        61,741,968      L1-dcache-loads           <span style="color:#998;font-style:italic">#  486.761 M/sec                    ( +-  2.39% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>           770,443      LLC-loads                 <span style="color:#998;font-style:italic">#    6.074 M/sec                    ( +-  1.42% )</span>
</span></span><span style="display:flex;"><span>           167,332      LLC-load-misses           <span style="color:#998;font-style:italic">#   21.61% of all LL-cache accesses  ( +-  9.58% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           0.05037 +- 0.00534 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +- 10.59% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally_walk1000 .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            126.02 msec task-clock                <span style="color:#998;font-style:italic">#    2.401 CPUs utilized            ( +-  7.14% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">534</span>      context-switches          <span style="color:#998;font-style:italic">#    4.190 K/sec                    ( +- 31.54% )</span>
</span></span><span style="display:flex;"><span>                <span style="color:#099">43</span>      cpu-migrations            <span style="color:#998;font-style:italic">#  337.390 /sec                     ( +- 82.12% )</span>
</span></span><span style="display:flex;"><span>             8,730      page-faults               <span style="color:#998;font-style:italic">#   68.498 K/sec                    ( +-  3.02% )</span>
</span></span><span style="display:flex;"><span>       200,521,361      cycles                    <span style="color:#998;font-style:italic">#    1.573 GHz                      ( +-  3.37% )</span>
</span></span><span style="display:flex;"><span>       201,667,306      instructions              <span style="color:#998;font-style:italic">#    0.95  insn per cycle           ( +-  3.08% )</span>
</span></span><span style="display:flex;"><span>        40,664,133      branches                  <span style="color:#998;font-style:italic">#  319.063 M/sec                    ( +-  2.75% )</span>
</span></span><span style="display:flex;"><span>           411,992      branch-misses             <span style="color:#998;font-style:italic">#    0.95% of all branches          ( +-  3.61% )</span>
</span></span><span style="display:flex;"><span>        52,419,468      L1-dcache-loads           <span style="color:#998;font-style:italic">#  411.298 M/sec                    ( +-  2.91% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>           699,381      LLC-loads                 <span style="color:#998;font-style:italic">#    5.488 M/sec                    ( +-  2.91% )</span>
</span></span><span style="display:flex;"><span>           209,549      LLC-load-misses           <span style="color:#998;font-style:italic">#   26.89% of all LL-cache accesses  ( +-  6.15% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           0.05249 +- 0.00584 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +- 11.12% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally_walk10000 .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            165.04 msec task-clock                <span style="color:#998;font-style:italic">#    3.075 CPUs utilized            ( +-  5.71% )</span>
</span></span><span style="display:flex;"><span>             1,986      context-switches          <span style="color:#998;font-style:italic">#   15.979 K/sec                    ( +- 10.74% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">440</span>      cpu-migrations            <span style="color:#998;font-style:italic">#    3.540 K/sec                    ( +- 10.92% )</span>
</span></span><span style="display:flex;"><span>            11,124      page-faults               <span style="color:#998;font-style:italic">#   89.502 K/sec                    ( +-  3.41% )</span>
</span></span><span style="display:flex;"><span>       254,677,268      cycles                    <span style="color:#998;font-style:italic">#    2.049 GHz                      ( +-  4.05% )</span>
</span></span><span style="display:flex;"><span>       263,349,968      instructions              <span style="color:#998;font-style:italic">#    1.25  insn per cycle           ( +-  3.98% )</span>
</span></span><span style="display:flex;"><span>        51,394,364      branches                  <span style="color:#998;font-style:italic">#  413.512 M/sec                    ( +-  3.66% )</span>
</span></span><span style="display:flex;"><span>           505,212      branch-misses             <span style="color:#998;font-style:italic">#    1.16% of all branches          ( +-  3.36% )</span>
</span></span><span style="display:flex;"><span>        67,546,889      L1-dcache-loads           <span style="color:#998;font-style:italic">#  543.473 M/sec                    ( +-  3.77% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>           837,174      LLC-loads                 <span style="color:#998;font-style:italic">#    6.736 M/sec                    ( +-  2.54% )</span>
</span></span><span style="display:flex;"><span>           211,730      LLC-load-misses           <span style="color:#998;font-style:italic">#   27.27% of all LL-cache accesses  ( +-  7.50% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           0.05367 +- 0.00622 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +- 11.59% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><p>dir with <code>3800+</code> files.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>root@beelink100 /h/u/workspace# perf stat -r <span style="color:#099">10</span> -d /home/ubtu/.go/bin/tally_walk10000 . &gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally_walk10000 .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          2,121.55 msec task-clock                <span style="color:#998;font-style:italic">#    2.028 CPUs utilized            ( +-  5.87% )</span>
</span></span><span style="display:flex;"><span>            12,183      context-switches          <span style="color:#998;font-style:italic">#    5.139 K/sec                    ( +-  3.39% )</span>
</span></span><span style="display:flex;"><span>             1,167      cpu-migrations            <span style="color:#998;font-style:italic">#  492.255 /sec                     ( +-  5.36% )</span>
</span></span><span style="display:flex;"><span>           203,339      page-faults               <span style="color:#998;font-style:italic">#   85.771 K/sec                    ( +- 17.22% )</span>
</span></span><span style="display:flex;"><span>     5,990,351,339      cycles                    <span style="color:#998;font-style:italic">#    2.527 GHz                      ( +-  6.79% )</span>
</span></span><span style="display:flex;"><span>     2,930,469,142      instructions              <span style="color:#998;font-style:italic">#    0.43  insn per cycle           ( +- 24.59% )</span>
</span></span><span style="display:flex;"><span>       542,443,958      branches                  <span style="color:#998;font-style:italic">#  228.809 M/sec                    ( +- 24.28% )</span>
</span></span><span style="display:flex;"><span>         2,905,949      branch-misses             <span style="color:#998;font-style:italic">#    0.41% of all branches          ( +- 13.97% )</span>
</span></span><span style="display:flex;"><span>       914,997,532      L1-dcache-loads           <span style="color:#998;font-style:italic">#  385.957 M/sec                    ( +- 19.22% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>        31,492,061      LLC-loads                 <span style="color:#998;font-style:italic">#   13.284 M/sec                    ( +-  2.38% )</span>
</span></span><span style="display:flex;"><span>        11,437,469      LLC-load-misses           <span style="color:#998;font-style:italic">#   33.55% of all LL-cache accesses  ( +-  3.87% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             1.046 +- 0.127 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +- 12.13% <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@beelink100 /h/u/workspace# perf stat -r <span style="color:#099">10</span> -d tokei . &gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;tokei .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            299.67 msec task-clock                <span style="color:#998;font-style:italic">#    3.368 CPUs utilized            ( +-  2.28% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">201</span>      context-switches          <span style="color:#998;font-style:italic">#  655.026 /sec                     ( +-  4.36% )</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#099">1</span>      cpu-migrations            <span style="color:#998;font-style:italic">#    3.259 /sec                     ( +- 30.73% )</span>
</span></span><span style="display:flex;"><span>             2,381      page-faults               <span style="color:#998;font-style:italic">#    7.759 K/sec                    ( +-  0.36% )</span>
</span></span><span style="display:flex;"><span>       872,948,453      cycles                    <span style="color:#998;font-style:italic">#    2.845 GHz                      ( +-  0.22% )</span>
</span></span><span style="display:flex;"><span>     2,063,804,765      instructions              <span style="color:#998;font-style:italic">#    2.36  insn per cycle           ( +-  0.06% )</span>
</span></span><span style="display:flex;"><span>       483,436,637      branches                  <span style="color:#998;font-style:italic">#    1.575 G/sec                    ( +-  0.04% )</span>
</span></span><span style="display:flex;"><span>         3,572,630      branch-misses             <span style="color:#998;font-style:italic">#    0.74% of all branches          ( +-  0.35% )</span>
</span></span><span style="display:flex;"><span>       568,333,584      L1-dcache-loads           <span style="color:#998;font-style:italic">#    1.852 G/sec                    ( +-  0.06% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>           371,106      LLC-loads                 <span style="color:#998;font-style:italic">#    1.209 M/sec                    ( +-  0.82% )</span>
</span></span><span style="display:flex;"><span>            76,251      LLC-load-misses           <span style="color:#998;font-style:italic">#   20.26% of all LL-cache accesses  ( +-  2.06% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           0.08897 +- 0.00211 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +-  2.38% <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@beelink100 /h/u/workspace# perf stat -r <span style="color:#099">10</span> -d /home/ubtu/.go/bin/tally . &gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          1,207.93 msec task-clock                <span style="color:#998;font-style:italic">#    1.029 CPUs utilized            ( +-  0.17% )</span>
</span></span><span style="display:flex;"><span>             1,793      context-switches          <span style="color:#998;font-style:italic">#    1.481 K/sec                    ( +-  3.76% )</span>
</span></span><span style="display:flex;"><span>                <span style="color:#099">28</span>      cpu-migrations            <span style="color:#998;font-style:italic">#   23.127 /sec                     ( +- 13.70% )</span>
</span></span><span style="display:flex;"><span>           177,609      page-faults               <span style="color:#998;font-style:italic">#  146.698 K/sec                    ( +-  0.57% )</span>
</span></span><span style="display:flex;"><span>     4,008,330,188      cycles                    <span style="color:#998;font-style:italic">#    3.311 GHz                      ( +-  0.06% )</span>
</span></span><span style="display:flex;"><span>     2,280,290,491      instructions              <span style="color:#998;font-style:italic">#    0.57  insn per cycle           ( +-  0.23% )</span>
</span></span><span style="display:flex;"><span>       428,399,527      branches                  <span style="color:#998;font-style:italic">#  353.841 M/sec                    ( +-  0.21% )</span>
</span></span><span style="display:flex;"><span>         1,902,235      branch-misses             <span style="color:#998;font-style:italic">#    0.44% of all branches          ( +-  0.22% )</span>
</span></span><span style="display:flex;"><span>       750,980,580      L1-dcache-loads           <span style="color:#998;font-style:italic">#  620.280 M/sec                    ( +-  0.18% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>        28,800,720      LLC-loads                 <span style="color:#998;font-style:italic">#   23.788 M/sec                    ( +-  0.08% )</span>
</span></span><span style="display:flex;"><span>        16,184,744      LLC-load-misses           <span style="color:#998;font-style:italic">#   56.33% of all LL-cache accesses  ( +-  0.13% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           1.17430 +- 0.00151 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +-  0.13% <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@beelink100 /h/u/workspace# perf stat -r <span style="color:#099">10</span> -d /home/ubtu/.go/bin/tally_walk10 . &gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally_walk10 .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          2,094.44 msec task-clock                <span style="color:#998;font-style:italic">#    2.632 CPUs utilized            ( +-  0.78% )</span>
</span></span><span style="display:flex;"><span>            13,318      context-switches          <span style="color:#998;font-style:italic">#    6.068 K/sec                    ( +-  4.65% )</span>
</span></span><span style="display:flex;"><span>             1,022      cpu-migrations            <span style="color:#998;font-style:italic">#  465.636 /sec                     ( +-  7.66% )</span>
</span></span><span style="display:flex;"><span>           191,164      page-faults               <span style="color:#998;font-style:italic">#   87.097 K/sec                    ( +-  1.66% )</span>
</span></span><span style="display:flex;"><span>     6,180,096,296      cycles                    <span style="color:#998;font-style:italic">#    2.816 GHz                      ( +-  0.58% )</span>
</span></span><span style="display:flex;"><span>     2,814,759,285      instructions              <span style="color:#998;font-style:italic">#    0.44  insn per cycle           ( +-  0.55% )</span>
</span></span><span style="display:flex;"><span>       522,446,609      branches                  <span style="color:#998;font-style:italic">#  238.033 M/sec                    ( +-  0.53% )</span>
</span></span><span style="display:flex;"><span>         3,255,157      branch-misses             <span style="color:#998;font-style:italic">#    0.63% of all branches          ( +-  1.01% )</span>
</span></span><span style="display:flex;"><span>       886,619,049      L1-dcache-loads           <span style="color:#998;font-style:italic">#  403.955 M/sec                    ( +-  0.44% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>        33,985,463      LLC-loads                 <span style="color:#998;font-style:italic">#   15.484 M/sec                    ( +-  1.09% )</span>
</span></span><span style="display:flex;"><span>         9,946,393      LLC-load-misses           <span style="color:#998;font-style:italic">#   29.66% of all LL-cache accesses  ( +-  3.42% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            0.7958 +- 0.0206 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +-  2.58% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><p>Seems the most time killer is not the <code>line counter</code><br>
It's <code>filepath walker</code></p>
<h2 id="optimize2---bufio-scanner-countline">Optimize2 - Bufio scanner countline</h2>
<p><a href="https://github.com/abcdlsj/share/blob/fd5bb216a651246352a25d27ddc189396cdec13a/go/tally/main.go#L145-L182">tally - main.go#L145-L182</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span> Performance counter stats <span style="color:#000;font-weight:bold">for</span> <span style="color:#d14">&#39;/home/ubtu/.go/bin/tally .&#39;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#099">10</span> runs<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             22.23 msec task-clock                <span style="color:#998;font-style:italic">#    0.967 CPUs utilized            ( +-  1.89% )</span>
</span></span><span style="display:flex;"><span>                <span style="color:#099">67</span>      context-switches          <span style="color:#998;font-style:italic">#    2.905 K/sec                    ( +-  8.96% )</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#099">4</span>      cpu-migrations            <span style="color:#998;font-style:italic">#  173.427 /sec                     ( +- 11.33% )</span>
</span></span><span style="display:flex;"><span>               <span style="color:#099">875</span>      page-faults               <span style="color:#998;font-style:italic">#   37.937 K/sec                    ( +-  0.33% )</span>
</span></span><span style="display:flex;"><span>        71,646,295      cycles                    <span style="color:#998;font-style:italic">#    3.106 GHz                      ( +-  0.59% )</span>
</span></span><span style="display:flex;"><span>       165,519,597      instructions              <span style="color:#998;font-style:italic">#    2.26  insn per cycle           ( +-  0.04% )</span>
</span></span><span style="display:flex;"><span>        44,646,031      branches                  <span style="color:#998;font-style:italic">#    1.936 G/sec                    ( +-  0.03% )</span>
</span></span><span style="display:flex;"><span>           364,548      branch-misses             <span style="color:#998;font-style:italic">#    0.82% of all branches          ( +-  0.25% )</span>
</span></span><span style="display:flex;"><span>        30,861,725      L1-dcache-loads           <span style="color:#998;font-style:italic">#    1.338 G/sec                    ( +-  0.06% )</span>
</span></span><span style="display:flex;"><span>   &lt;not supported&gt;      L1-dcache-load-misses
</span></span><span style="display:flex;"><span>            75,727      LLC-loads                 <span style="color:#998;font-style:italic">#    3.283 M/sec                    ( +-  0.37% )</span>
</span></span><span style="display:flex;"><span>            32,681      LLC-load-misses           <span style="color:#998;font-style:italic">#   42.57% of all LL-cache accesses  ( +-  0.81% )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          0.023000 +- 0.000407 seconds <span style="color:#0086b3">time</span> elapsed  <span style="color:#000;font-weight:bold">(</span> +-  1.77% <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre><p>it's so <code>fast</code> than <a href="###Tally">origin <code>counter</code> tally</a></p>
<h2 id="optimize3---faster-filepath-walking">Optimize3 - Faster filepath walking</h2>
<p>Based on this post <a href="https://engineering.kablamo.com.au/posts/2021/quick-comparison-between-go-file-walk-implementations/">You Don't Need a Library for File Walking in Go</a>, the result shows the <code>offical filepath walk</code> are faster enough. And I want to build <code>tally</code> without any <code>third-party dependencies</code>, so I won't use other faster <code>walkdir</code> library...<br>
Currently, I use the <code>filepath.Walk</code> to <code>walking</code> dir, I will modify to <code>filepth.Walkdir</code>, It's faster a little.</p>
<p>I bench it at my <code>MacbookPro 16</code> using <a href="https://github.com/sharkdp/hyperfine">hyperfine</a>(I just found it at these days...)</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>$ hyperfine <span style="color:#d14">&#39;tally_walk .&#39;</span> <span style="color:#d14">&#39;tally_walkdir .&#39;</span> --warmup <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>Benchmark 1: tally_walk .
</span></span><span style="display:flex;"><span>  Time <span style="color:#000;font-weight:bold">(</span>mean ± σ<span style="color:#000;font-weight:bold">)</span>:      3.035 s ±  0.519 s    <span style="color:#000;font-weight:bold">[</span>User: 0.594 s, System: 2.382 s<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  Range <span style="color:#000;font-weight:bold">(</span>min … max<span style="color:#000;font-weight:bold">)</span>:    2.419 s …  4.233 s    <span style="color:#099">10</span> runs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Benchmark 2: tally_walkdir .
</span></span><span style="display:flex;"><span>  Time <span style="color:#000;font-weight:bold">(</span>mean ± σ<span style="color:#000;font-weight:bold">)</span>:      2.475 s ±  0.500 s    <span style="color:#000;font-weight:bold">[</span>User: 0.510 s, System: 1.924 s<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  Range <span style="color:#000;font-weight:bold">(</span>min … max<span style="color:#000;font-weight:bold">)</span>:    2.100 s …  3.780 s    <span style="color:#099">10</span> runs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Summary
</span></span><span style="display:flex;"><span>  tally_walkdir . ran
</span></span><span style="display:flex;"><span>    1.23 ± 0.32 <span style="color:#0086b3">times</span> faster than tally_walk .
</span></span></code></pre><h2 id="end">End</h2>
<p><strong>Not the end</strong><br>
The post is just a learning progress, you can find source code at <a href="https://github.com/abcdlsj/share/tree/master/go/tally">github - abcdlsj/tally</a></p>
<h2 id="ref">Ref</h2>
<p><a href="https://github.com/boyter/scc/">https://github.com/boyter/scc/</a><br>
<a href="https://boyter.org/posts/sloc-cloc-code/">https://boyter.org/posts/sloc-cloc-code/</a><br>
<a href="https://blog.burntsushi.net/ripgrep/">https://blog.burntsushi.net/ripgrep/</a><br>
<a href="https://engineering.kablamo.com.au/posts/2021/quick-comparison-between-go-file-walk-implementations/">https://engineering.kablamo.com.au/posts/2021/quick-comparison-between-go-file-walk-implementations/</a></p>
</article>
    </main>
    <hr class="divider" />
    
<footer class="footer">
  <p class="footer-author">
    Author <a href="https://github.com/abcdlsj">abcdlsj</a>
  </p>
  <p class="footer-proj">
    Source
    <a href="https://github.com/abcdlsj/abcdlsj.github.io">abcdlsj.github.io</a>
  </p>
</footer>

  </body>
</html>


<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8" />
<title>abcdlsj</title>
<meta name="description" content="Enjoy Focus!" />
<meta name="author" content="Author" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="stylesheet" href="/static/style.css" />

  </head>
  <body class="container">
    <main>
      <div class="navbar">
<nav class="navbar">
  
  <ul>
    <li>
      <a href="/" class="menu">#Home</a>
    </li>
  </ul>
  
  <ul>
    <li>
      <a href="/about" class="menu">#About</a>
    </li>
  </ul>
  
</nav>
</div>
      <hr class="divider" />
      <h1 class="post-single-title">Pasty - Beautiful pastebin website with Go, Turnstile, OAuth</h1>
      <hr class="divider" />
      <div class="post-meta">
        <div class="post-date">Date: 2023-12-08T22:47:37+08:00</div>
        <nav class="post-tags">
          
          <a href="/tags/oauth.html" class="tag">#OAuth</a>
          
          <a href="/tags/turnstile.html" class="tag">#Turnstile</a>
          
          <a href="/tags/template.html" class="tag">#Template</a>
          
        </nav>
        
        <hr class="divider" />
        <div class="post-toc"><ul>
<li>
TOC<ul>
<li>
<a href="#background">Background</a></li>
<li>
<a href="#let-us-build-pasty">Let us build Pasty</a><ul>
<li>
<a href="#endpoint-design">Endpoint design</a></li>
<li>
<a href="#orm-or-raw-sql">ORM or Raw-SQL</a></li>
<li>
<a href="#templates">templates</a></li>
<li>
<a href="#run-it">Run it!</a></li>
</ul>
</li>
<li>
<a href="#turnstile">Turnstile</a><ul>
<li>
<a href="#html-script">HTML script</a></li>
<li>
<a href="#server-handler">server handler</a></li>
<li>
<a href="#look-the-site">Look the site</a></li>
</ul>
</li>
<li>
<a href="#github-oauth">GitHub OAuth</a><ul>
<li>
<a href="#oauth">OAuth</a></li>
<li>
<a href="#api">API</a></li>
</ul>
</li>
<li>
<a href="#handler">Handler</a><ul>
<li>
<a href="#encryption-and-decryption">Encryption and Decryption</a></li>
<li>
<a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li>
<a href="#done">Done</a></li>
</ul>
</li>
</ul>
</div>
        
      </div>
      <hr class="divider" />
      <div class="post-content">
        <article><h2 id="background">Background</h2>
<p>I had try to build many of <code>Go</code> simple site, Like <code>Golink</code>, <code>GProbe</code> and so on.<br>
But it's not secure enough, and very easy to be attacked.<br>
At these days, I want to build a <code>Pastebin</code> website and its need with powerful <strong>Security</strong>.</p>
<h2 id="let-us-build-pasty">Let us build Pasty</h2>
<p>Its all old way like I posted before.</p>
<ul>
<li><code>Go</code> serve HTTP endpoints.</li>
<li>template to render HTML.</li>
<li>SQLite3 to store and query data.</li>
</ul>
<h3 id="endpoint-design">Endpoint design</h3>
<p>For simply, I just make 2 endpoints for <code>Pasty</code>:</p>
<ol>
<li><code>/</code>: to get index page(<code>GET</code>) and create a new paste(<code>POST</code>)</li>
<li><code>/paste/</code>: to get paste page(<code>GET</code>) and delete it(<code>DELETE</code>)</li>
</ol>
<p>This is the whole APIs I need to write.</p>
<p>Let's start:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>http.<span style="color:#900;font-weight:bold">HandleFunc</span>(<span style="color:#d14">&#34;/&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> r.Method <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;GET&#34;</span> {
</span></span><span style="display:flex;"><span>		pastes <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getAllPastes</span>(db)
</span></span><span style="display:flex;"><span>		tmpl.<span style="color:#900;font-weight:bold">ExecuteTemplate</span>(w, <span style="color:#d14">&#34;index.html&#34;</span>, pastes)
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		r.<span style="color:#900;font-weight:bold">ParseForm</span>()
</span></span><span style="display:flex;"><span>		content <span style="color:#000;font-weight:bold">:=</span> r.Form.<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#d14">&#34;content&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">insertPaste</span>(db, <span style="color:#900;font-weight:bold">escapeContent</span>(content))
</span></span><span style="display:flex;"><span>		http.<span style="color:#900;font-weight:bold">Redirect</span>(w, r, <span style="color:#d14">&#34;/&#34;</span>, http.StatusSeeOther)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http.<span style="color:#900;font-weight:bold">HandleFunc</span>(<span style="color:#d14">&#34;/paste/&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span>	uid <span style="color:#000;font-weight:bold">:=</span> r.URL.Path[<span style="color:#0086b3">len</span>(<span style="color:#d14">&#34;/paste/&#34;</span>):]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> r.Method <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;GET&#34;</span> {
</span></span><span style="display:flex;"><span>		paste <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getPasteWithID</span>(db, uid)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> paste.<span style="color:#900;font-weight:bold">isNil</span>() {
</span></span><span style="display:flex;"><span>			http.<span style="color:#900;font-weight:bold">NotFound</span>(w, r)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		tmpl.<span style="color:#900;font-weight:bold">ExecuteTemplate</span>(w, <span style="color:#d14">&#34;paste.html&#34;</span>, paste)
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">deletePaste</span>(db, uid)
</span></span><span style="display:flex;"><span>		http.<span style="color:#900;font-weight:bold">Redirect</span>(w, r, <span style="color:#d14">&#34;/&#34;</span>, http.StatusSeeOther)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>})
</span></span></code></pre><p>Then we need to write <code>tmpl</code> and implement <code>CRUD</code>(<code>getAllPastes</code>, <code>getPasteWithID</code>, <code>insertPaste</code>, <code>deletePaste</code>)</p>
<h3 id="orm-or-raw-sql">ORM or Raw-SQL</h3>
<p>Actually, I'm a original-thinker, I don't like to use third-party packages.<br>
But <code>ORM</code> will make program easier.</p>
<p>I use <code>SQLite3</code> and <code>Gorm</code> to store and query data.<br>
<code>Gorm</code> is easy to use, it provide a lot of functionality.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> Paste <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	ID        <span style="color:#458;font-weight:bold">int</span>       <span style="color:#d14">`gorm:&#34;column:id&#34;`</span>
</span></span><span style="display:flex;"><span>	UID       <span style="color:#458;font-weight:bold">string</span>    <span style="color:#d14">`gorm:&#34;column:uid&#34;`</span>
</span></span><span style="display:flex;"><span>	Content   <span style="color:#458;font-weight:bold">string</span>    <span style="color:#d14">`gorm:&#34;column:content&#34;`</span>
</span></span><span style="display:flex;"><span>	CreatedAt time.Time <span style="color:#d14">`gorm:&#34;column:created_at&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">getAllPastes</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB) []Paste {
</span></span><span style="display:flex;"><span>	pastes <span style="color:#000;font-weight:bold">:=</span> []Paste{}
</span></span><span style="display:flex;"><span>	db.<span style="color:#900;font-weight:bold">Find</span>(<span style="color:#000;font-weight:bold">&amp;</span>pastes)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> pastes
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">getPasteWithID</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB, uid <span style="color:#458;font-weight:bold">string</span>) Paste {
</span></span><span style="display:flex;"><span>	paste <span style="color:#000;font-weight:bold">:=</span> Paste{}
</span></span><span style="display:flex;"><span>	db.<span style="color:#900;font-weight:bold">First</span>(<span style="color:#000;font-weight:bold">&amp;</span>paste, <span style="color:#d14">&#34;uid = ?&#34;</span>, uid)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> paste
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">insertPaste</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB, content <span style="color:#458;font-weight:bold">string</span>) {
</span></span><span style="display:flex;"><span>	paste <span style="color:#000;font-weight:bold">:=</span> Paste{UID: uuid.<span style="color:#900;font-weight:bold">New</span>().<span style="color:#900;font-weight:bold">String</span>(), Content: content, CreatedAt: time.<span style="color:#900;font-weight:bold">Now</span>()}
</span></span><span style="display:flex;"><span>	db.<span style="color:#900;font-weight:bold">Create</span>(<span style="color:#000;font-weight:bold">&amp;</span>paste)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">deletePaste</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB, uid <span style="color:#458;font-weight:bold">string</span>) {
</span></span><span style="display:flex;"><span>	db.<span style="color:#900;font-weight:bold">Delete</span>(<span style="color:#000;font-weight:bold">&amp;</span>Paste{}, <span style="color:#d14">&#34;uid = ?&#34;</span>, uid)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>There are all we need!</p>
<p>Oh.. maybe we need to init a database?<br>
Right, It's also very easy to init databse, <code>Gorm</code> will help you.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">initDB</span>(filepath <span style="color:#458;font-weight:bold">string</span>) <span style="color:#000;font-weight:bold">*</span>gorm.DB {
</span></span><span style="display:flex;"><span>	db, err <span style="color:#000;font-weight:bold">:=</span> gorm.<span style="color:#900;font-weight:bold">Open</span>(sqlite.<span style="color:#900;font-weight:bold">Open</span>(filepath), <span style="color:#000;font-weight:bold">&amp;</span>gorm.Config{
</span></span><span style="display:flex;"><span>		DisableAutomaticPing: <span style="color:#000;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#900;font-weight:bold">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err = db.<span style="color:#900;font-weight:bold">AutoMigrate</span>(<span style="color:#000;font-weight:bold">&amp;</span>Paste{})
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#900;font-weight:bold">Fatal</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> db
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>We just need to open the database and migrate the table. If table not exist, it will create it. and if exist, it will do nothing.</p>
<h3 id="templates">templates</h3>
<p>I thought <code>Template</code> is very powerful when build simple website.<br>
We just need to create 2 pages: <code>index.html</code> and <code>paste.html</code>.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">title</span>&gt;Pasty&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">h1</span>&gt;Pasty&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">p</span>&gt;Input your paste&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">form</span> <span style="color:#008080">method</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;POST&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">textarea</span> <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;content&#34;</span> <span style="color:#008080">required</span> <span style="color:#008080">rows</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;30&#34;</span>&gt;&lt;/<span style="color:#000080">textarea</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">br</span>/&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">input</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;submit&#34;</span> <span style="color:#008080">value</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Submit&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">form</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">hr</span>/&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">h2</span>&gt;Pasted&lt;/<span style="color:#000080">h2</span>&gt;
</span></span><span style="display:flex;"><span>    {{range .}}
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">a</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;/paste/{{.UID}}&#34;</span>&gt;{{.UID}}&lt;/<span style="color:#000080">a</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">p</span>&gt;&lt;<span style="color:#000080">pre</span>&gt;&lt;<span style="color:#000080">code</span>&gt;{{truncate .Content 200}}&lt;/<span style="color:#000080">code</span>&gt;&lt;/<span style="color:#000080">pre</span>&gt;&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>    {{end}}
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre><pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">title</span>&gt;Paste&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">h1</span>&gt;Paste&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">a</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;/&#34;</span>&gt;Home&lt;/<span style="color:#000080">a</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">h2</span>&gt;{{.UID}}&lt;/<span style="color:#000080">h2</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">pre</span>&gt;&lt;<span style="color:#000080">code</span>&gt;{{.Content}}&lt;/<span style="color:#000080">code</span>&gt;&lt;/<span style="color:#000080">pre</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">p</span>&gt;{{.CreatedAt}}&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">form</span> <span style="color:#008080">method</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;POST&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">input</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;submit&#34;</span> <span style="color:#008080">value</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Delete&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#000080">form</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre><p><code>CSS</code> is the hardest part I thoguht when I write any website. So I use <code>water.css</code> for styling.</p>
<blockquote>
<p><code>Water.css</code> is a drop-in collection of CSS styles to make simple websites like this just a little bit nicer.<a href="https://watercss.kognise.dev/">https://watercss.kognise.dev/</a></p>
</blockquote>
<p>You just need to import <code>water.css</code> to <code>html</code> file, and you will got a pretty website with auto dark mode.<br>
Add this to <code>head</code> element.</p>
<pre><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/water.css@2/out/water.css&quot;&gt;
</code></pre>
<h3 id="run-it">Run it!</h3>
<img src="/static/img/pasty-1.png" width="800">
<p>Looks pretty good!</p>
<blockquote>
<p>It's use <code>gg font</code> as <code>font-family</code>.</p>
</blockquote>
<p>You also can add a <code>favicon</code> and add a copy button at <code>paste</code> page.<br>
Using <code>Javascript</code> to <code>copy</code> the content.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">title</span>&gt;Pasty&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">link</span>
</span></span><span style="display:flex;"><span>      <span style="color:#008080">rel</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;stylesheet&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;https://cdn.jsdelivr.net/npm/water.css@2/out/water.css&#34;</span>
</span></span><span style="display:flex;"><span>    /&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">link</span> <span style="color:#008080">rel</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;shortcut icon&#34;</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;image/x-icon&#34;</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;favicon.ico&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">style</span>&gt;
</span></span><span style="display:flex;"><span>      .<span style="color:#458;font-weight:bold">code-container</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">position</span>: <span style="color:#000;font-weight:bold">relative</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      .<span style="color:#458;font-weight:bold">code-container</span> .<span style="color:#458;font-weight:bold">copy-button</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">position</span>: <span style="color:#000;font-weight:bold">absolute</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">top</span>: <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">right</span>: <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">padding</span>: <span style="color:#099">5</span><span style="color:#458;font-weight:bold">px</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">border</span>: <span style="color:#000;font-weight:bold">none</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">cursor</span>: <span style="color:#000;font-weight:bold">pointer</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">style</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">script</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">function</span> copyCode(block, button) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">let</span> code <span style="color:#000;font-weight:bold">=</span> block.querySelector(<span style="color:#d14">&#34;code&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">let</span> text <span style="color:#000;font-weight:bold">=</span> code.innerText;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">await</span> navigator.clipboard.writeText(text);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// visual feedback that task is completed
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        button.innerText <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;Code Copied&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setTimeout(() =&gt; {
</span></span><span style="display:flex;"><span>          button.innerText <span style="color:#000;font-weight:bold">=</span> copyButtonLabel;
</span></span><span style="display:flex;"><span>        }, <span style="color:#099">700</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">a</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;/&#34;</span>&gt;Home&lt;/<span style="color:#000080">a</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">div</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;code-container&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">h2</span>&gt;{{.UID}}&lt;/<span style="color:#000080">h2</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">button</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;copy-button&#34;</span> <span style="color:#008080">onclick</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;copyCode(this.parentElement, this)&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        Copy
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#000080">button</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">pre</span>&gt;&lt;<span style="color:#000080">code</span>&gt;{{.Content}}&lt;/<span style="color:#000080">code</span>&gt;&lt;/<span style="color:#000080">pre</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">p</span>&gt;{{.CreatedAt}}&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#000080">form</span> <span style="color:#008080">method</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;POST&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">input</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;submit&#34;</span> <span style="color:#008080">value</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Delete&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#000080">form</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre><p>This will have a copy button at <code>paste</code> content right top.<br>
<img src="/static/img/pasty-3.png" width="800"><br>
It's looks also pretty good!</p>
<p>At the last step, we will to add <code>Turnstile</code>.</p>
<h2 id="turnstile">Turnstile</h2>
<blockquote>
<p>Turnstile is Cloudflare’s smart CAPTCHA alternative. It can be embedded into any website without sending traffic through Cloudflare and works without showing visitors a CAPTCHA. <a href="https://developers.cloudflare.com/turnstile/get-started">Cloudflare</a></p>
</blockquote>
<p>For my wrote tools, it's always have not security views. We can use <code>CAPTCHA</code> to protect our forms.</p>
<h3 id="html-script">HTML script</h3>
<p>Add <code>Turnstile</code> also very easy, at first, you need to add <code>Turnstile</code> script to your website.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>&lt;<span style="color:#000080">script</span> <span style="color:#008080">src</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;https://challenges.cloudflare.com/turnstile/v0/api.js&#34;</span> <span style="color:#008080">async</span> <span style="color:#008080">defer</span>&gt;&lt;/<span style="color:#000080">script</span>&gt;
</span></span></code></pre><p>Then you can add <code>cf-turnstile</code> to form.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>&lt;<span style="color:#000080">div</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;cf-turnstile&#34;</span> <span style="color:#008080">data-sitekey</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;YOUR_TURNSTILE_SITE_KEY&#34;</span>&gt;&lt;/<span style="color:#000080">div</span>&gt;
</span></span></code></pre><p>I just add <code>Turnstile</code> to <code>index.html</code> page <code>submit</code> form.<br>
This is the result</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">title</span>&gt;Pasty&lt;/<span style="color:#000080">title</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">link</span> <span style="color:#008080">rel</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;stylesheet&#34;</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;https://cdn.jsdelivr.net/npm/water.css@2/out/water.css&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">script</span> <span style="color:#008080">src</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;https://challenges.cloudflare.com/turnstile/v0/api.js&#34;</span> <span style="color:#008080">async</span> <span style="color:#008080">defer</span>&gt;&lt;/<span style="color:#000080">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">h1</span>&gt;Pasty&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">p</span>&gt;Input your paste&lt;/<span style="color:#000080">p</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">form</span> <span style="color:#008080">method</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;POST&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">textarea</span> <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;content&#34;</span> <span style="color:#008080">required</span> <span style="color:#008080">rows</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;30&#34;</span>&gt;&lt;/<span style="color:#000080">textarea</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">br</span>/&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">input</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;submit&#34;</span> <span style="color:#008080">value</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Submit&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">div</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;cf-turnstile&#34;</span> <span style="color:#008080">data-sitekey</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;{{.CFTurnstileSiteKey}}&#34;</span> <span style="color:#008080">data-callback</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;turnstileCompleted&#34;</span>&gt;&lt;/<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#000080">form</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">hr</span>/&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#000080">h2</span>&gt;Pasted&lt;/<span style="color:#000080">h2</span>&gt;
</span></span><span style="display:flex;"><span>    {{range .Pastes}}
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">a</span> <span style="color:#008080">href</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;/paste/{{.UID}}&#34;</span>&gt;{{.UID}}&lt;/<span style="color:#000080">a</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#000080">pre</span>&gt;&lt;<span style="color:#000080">code</span>&gt;{{truncate .Content 200}}&lt;/<span style="color:#000080">code</span>&gt;&lt;/<span style="color:#000080">pre</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>    {{end}}
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">html</span>&gt;
</span></span></code></pre><p>You also need do something configuration for <code>Turnstile</code>.</p>
<ul>
<li>Add site</li>
<li>Copy site key, secret key<br>
You can find this at cloudflare's <a href="https://developers.cloudflare.com/turnstile/get-started">documentation</a>.</li>
</ul>
<h3 id="server-handler">server handler</h3>
<p>The new form which we add <code>Turnstile</code> will send <code>cf-turnstile-response</code>, you can use this to validate the user.<br>
This is the sample code.</p>
<blockquote>
<p>The validation request param <code>CF-Connecting-IP</code> is optional. if you are using Cloudflare DNS, you can add this param.<br>
<code>CF-Connecting-IP provides the client IP address connecting to Cloudflare to the origin web server. This header will only be sent on the traffic from Cloudflare’s edge to your origin web server.</code><br>
<a href="https://developers.cloudflare.com/fundamentals/reference/http-request-headers/">Cloudflare - HTTP request headers</a></p>
</blockquote>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">cfValidate</span>(r <span style="color:#000;font-weight:bold">*</span>http.Request) <span style="color:#458;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	token <span style="color:#000;font-weight:bold">:=</span> r.Form.<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#d14">&#34;cf-turnstile-response&#34;</span>)
</span></span><span style="display:flex;"><span>	ip <span style="color:#000;font-weight:bold">:=</span> r.Header.<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#d14">&#34;CF-Connecting-IP&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> token <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> <span style="color:#000;font-weight:bold">||</span> ip <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	form <span style="color:#000;font-weight:bold">:=</span> url.Values{}
</span></span><span style="display:flex;"><span>	form.<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;secret&#34;</span>, CFTurnstileSecret)
</span></span><span style="display:flex;"><span>	form.<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;response&#34;</span>, token)
</span></span><span style="display:flex;"><span>	form.<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;remoteip&#34;</span>, ip)
</span></span><span style="display:flex;"><span>	idempotencyKey <span style="color:#000;font-weight:bold">:=</span> uuid.<span style="color:#900;font-weight:bold">New</span>().<span style="color:#900;font-weight:bold">String</span>()
</span></span><span style="display:flex;"><span>	form.<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;idempotency_key&#34;</span>, idempotencyKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	resp, err <span style="color:#000;font-weight:bold">:=</span> http.<span style="color:#900;font-weight:bold">PostForm</span>(CFTurnstileURL, form)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">type</span> CFTurnstileResponse <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>		Success <span style="color:#458;font-weight:bold">bool</span> <span style="color:#d14">`json:&#34;success&#34;`</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	cfresp <span style="color:#000;font-weight:bold">:=</span> CFTurnstileResponse{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err = json.<span style="color:#900;font-weight:bold">NewDecoder</span>(resp.Body).<span style="color:#900;font-weight:bold">Decode</span>(<span style="color:#000;font-weight:bold">&amp;</span>cfresp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">||</span> cfresp.Success
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The result will contain <code>success</code>, can judge it by self.</p>
<h3 id="look-the-site">Look the site</h3>
<p>After add <code>Turnstile</code>, there will have a <code>Turnstile</code> validation at the <code>submit</code> button bottom.</p>
<img src="/static/img/pasty-2.png" width="800">
<p>Ok, now we have protect our <code>form</code> with <code>Turnstile</code>.</p>
<h2 id="github-oauth">GitHub OAuth</h2>
<p>After add <code>Turnstile</code>, I thought the site also too <code>open</code>, anyone can view it.<br>
So we can add some <code>Authentication</code> feature, example to use <code>OAuth</code>.</p>
<h3 id="oauth">OAuth</h3>
<p>OAuth had many <code>client</code>, <code>Google</code>, <code>GitHub</code>, etc.<br>
I'm use <code>GitHub</code> there.</p>
<p>These is the <code>GitHub OAuth</code> flow</p>
<ol>
<li>Request <code>GitHub</code> Identity API</li>
<li>User accept request, redirect to <code>Callback</code> URL with <code>Code</code>.</li>
<li>At <code>Callback</code> logic, request <code>GitHub</code> Access Token API with <code>Code</code>.</li>
<li>Use <code>Access Token</code> to request <code>GitHub</code> User API.</li>
</ol>
<p>You first need to get <code>Client ID</code> and <code>Client Secret</code>. you can create a application at <code>https://github.com/settings/applications/new</code></p>
<h3 id="api">API</h3>
<p>Base on the <code>OAuth</code> flow, let's design the APIs.<br>
At first, we don't want user goto login flow at every time. So we need to store the <code>Login Status</code>. at where? at the <code>Cookie</code>.<br>
So we will store <code>Login Status</code> in <code>Cookie</code>. then once the user view we will check the <code>Login Status</code>. if it's not <code>Login</code>, we will redirect he goto login flow.<br>
So we have a API to trigger login flow, we also need a <code>Callback</code> API to get <code>Access Token</code> and <code>User</code>.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">var</span> GHRedirectURL =  fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;https://github.com/login/oauth/authorize?client_id=%s&amp;redirect_uri=%s&#34;</span>, GHClientID, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%s/login/callback&#34;</span>, SiteURL))
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>http.<span style="color:#900;font-weight:bold">HandleFunc</span>(<span style="color:#d14">&#34;/login&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span>	http.<span style="color:#900;font-weight:bold">Redirect</span>(w, r, GHRedirectURL, http.StatusSeeOther)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http.<span style="color:#900;font-weight:bold">HandleFunc</span>(<span style="color:#d14">&#34;/login/callback&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span>	code <span style="color:#000;font-weight:bold">:=</span> r.URL.<span style="color:#900;font-weight:bold">Query</span>().<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#d14">&#34;code&#34;</span>)
</span></span><span style="display:flex;"><span>	ak, sk, expiresIn <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getGithubAccessToken</span>(code, <span style="color:#d14">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> ak <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#900;font-weight:bold">Sprintln</span>(w, <span style="color:#d14">&#34;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Failed to login&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">setCookieSession</span>(w, <span style="color:#d14">&#34;s&#34;</span>, ak, sk, expiresIn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	http.<span style="color:#900;font-weight:bold">Redirect</span>(w, r, <span style="color:#d14">&#34;/&#34;</span>, http.StatusSeeOther)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre><h2 id="handler">Handler</h2>
<p><code>GitHub OAuth</code> can use <code>refresh token</code> to refresh <code>Access Token</code>, so we can use <code>refresh token</code> to get new <code>Access Token</code> when <code>Access Token</code> expired.<br>
All these information will be stored in <code>Cookie</code>.</p>
<blockquote>
<p>Cookie value should be encrypted, need to implement encryption and decryption.</p>
</blockquote>
<p>This is my all implementation<br>
<code>Session</code> struct.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> Session <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	AK     <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;ak&#34;`</span>
</span></span><span style="display:flex;"><span>	RK     <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;rk&#34;`</span>
</span></span><span style="display:flex;"><span>	Expire <span style="color:#458;font-weight:bold">int</span>    <span style="color:#d14">`json:&#34;ak_expire&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Use <code>Code</code> or <code>Refresh Token</code> to get <code>Access Token</code>, <code>Refresh Token</code>, <code>Expires In</code>.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">getGithubAccessToken</span>(code, rk <span style="color:#458;font-weight:bold">string</span>) (<span style="color:#458;font-weight:bold">string</span>, <span style="color:#458;font-weight:bold">string</span>, <span style="color:#458;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>	params <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">map</span>[<span style="color:#458;font-weight:bold">string</span>]<span style="color:#458;font-weight:bold">string</span>{<span style="color:#d14">&#34;client_id&#34;</span>: GHClientID, <span style="color:#d14">&#34;client_secret&#34;</span>: GHSecret}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> rk <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		params[<span style="color:#d14">&#34;refresh_token&#34;</span>] = rk
</span></span><span style="display:flex;"><span>		params[<span style="color:#d14">&#34;grant_type&#34;</span>] = <span style="color:#d14">&#34;refresh_token&#34;</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		params[<span style="color:#d14">&#34;code&#34;</span>] = code
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	rbody, _ <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Marshal</span>(params)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	req, err <span style="color:#000;font-weight:bold">:=</span> http.<span style="color:#900;font-weight:bold">NewRequest</span>(<span style="color:#d14">&#34;POST&#34;</span>, <span style="color:#d14">&#34;https://github.com/login/oauth/access_token&#34;</span>, bytes.<span style="color:#900;font-weight:bold">NewBuffer</span>(rbody))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#d14">&#34;Error: %s\n&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	req.Header.<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;Content-Type&#34;</span>, <span style="color:#d14">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>	req.Header.<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;Accept&#34;</span>, <span style="color:#d14">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	resp, resperr <span style="color:#000;font-weight:bold">:=</span> http.DefaultClient.<span style="color:#900;font-weight:bold">Do</span>(req)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> resperr <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#d14">&#34;Error: %s\n&#34;</span>, resperr)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">type</span> githubAKResp <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>		AccessToken  <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;access_token&#34;`</span>
</span></span><span style="display:flex;"><span>		ExpiresIn    <span style="color:#458;font-weight:bold">int</span>    <span style="color:#d14">`json:&#34;expires_in&#34;`</span>
</span></span><span style="display:flex;"><span>		RefreshToken <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;refresh_token&#34;`</span>
</span></span><span style="display:flex;"><span>		Scope        <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;scope&#34;`</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> ghresp githubAKResp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err = json.<span style="color:#900;font-weight:bold">NewDecoder</span>(resp.Body).<span style="color:#900;font-weight:bold">Decode</span>(<span style="color:#000;font-weight:bold">&amp;</span>ghresp)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#d14">&#34;Error: %s\n&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#d14">&#34;Github: %+v&#34;</span>, ghresp)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> ghresp.AccessToken, ghresp.RefreshToken, ghresp.ExpiresIn
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><code>checkRefreshGHStatus</code> will check <code>Login Status</code>, if there not have <code>Session</code>, return <code>false</code>, goto login flow.<br>
if the <code>Access Token</code> expired, will use <code>Refresh Token</code> to get new <code>Access Token</code>.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">checkRefreshGHStatus</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) <span style="color:#458;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	session <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getCookieSession</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> session <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#d14">&#34;session is nil&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#d14">&#34;session: %+v&#34;</span>, session)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> time.<span style="color:#900;font-weight:bold">Now</span>().<span style="color:#900;font-weight:bold">Unix</span>() &gt; <span style="color:#0086b3">int64</span>(session.Expire) {
</span></span><span style="display:flex;"><span>		log.<span style="color:#900;font-weight:bold">Printf</span>(<span style="color:#d14">&#34;now: %d, expire: %d&#34;</span>, time.<span style="color:#900;font-weight:bold">Now</span>().<span style="color:#900;font-weight:bold">Unix</span>(), session.Expire)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> session.RK <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		ak, sk, expiresIn <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getGithubAccessToken</span>(<span style="color:#d14">&#34;&#34;</span>, session.RK)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> ak <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">setCookieSession</span>(w, <span style="color:#d14">&#34;s&#34;</span>, ak, sk, expiresIn)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">getGithubData</span>(session.AK) <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="encryption-and-decryption">Encryption and Decryption</h3>
<p>Be honest, I'm not have much expensive knowledge with encryption and decryption.<br>
So I just post code here.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">encryptData</span>(data []<span style="color:#458;font-weight:bold">byte</span>) (<span style="color:#458;font-weight:bold">string</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	block, err <span style="color:#000;font-weight:bold">:=</span> aes.<span style="color:#900;font-weight:bold">NewCipher</span>(CipherKey)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;could not create new cipher: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	cipherText <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, aes.BlockSize<span style="color:#000;font-weight:bold">+</span><span style="color:#0086b3">len</span>(data))
</span></span><span style="display:flex;"><span>	iv <span style="color:#000;font-weight:bold">:=</span> cipherText[:aes.BlockSize]
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> _, err = io.<span style="color:#900;font-weight:bold">ReadFull</span>(rand.Reader, iv); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;could not encrypt: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	stream <span style="color:#000;font-weight:bold">:=</span> cipher.<span style="color:#900;font-weight:bold">NewCFBEncrypter</span>(block, iv)
</span></span><span style="display:flex;"><span>	stream.<span style="color:#900;font-weight:bold">XORKeyStream</span>(cipherText[aes.BlockSize:], data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> base64.StdEncoding.<span style="color:#900;font-weight:bold">EncodeToString</span>(cipherText), <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">decryptStr</span>(str <span style="color:#458;font-weight:bold">string</span>) ([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	cipherText, err <span style="color:#000;font-weight:bold">:=</span> base64.StdEncoding.<span style="color:#900;font-weight:bold">DecodeString</span>(str)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, fmt.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;could not base64 decode: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	block, err <span style="color:#000;font-weight:bold">:=</span> aes.<span style="color:#900;font-weight:bold">NewCipher</span>(CipherKey)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, fmt.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;could not create new cipher: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(cipherText) &lt; aes.BlockSize {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, fmt.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;invalid ciphertext block size&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	iv <span style="color:#000;font-weight:bold">:=</span> cipherText[:aes.BlockSize]
</span></span><span style="display:flex;"><span>	cipherText = cipherText[aes.BlockSize:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	stream <span style="color:#000;font-weight:bold">:=</span> cipher.<span style="color:#900;font-weight:bold">NewCFBDecrypter</span>(block, iv)
</span></span><span style="display:flex;"><span>	stream.<span style="color:#900;font-weight:bold">XORKeyStream</span>(cipherText, cipherText)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> cipherText, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="conclusion">Conclusion</h3>
<blockquote>
<p>When a user concept exists,it may be necessary to add <code>User</code> functionality. Add the <code>User</code> field to the <code>Paste</code> structure and form and perform a <code>CRUD</code> with the logged in user.</p>
</blockquote>
<p>After setting GitHub application, you can see this page when first view index page.</p>
<img src="/static/img/pasty-4.png" width="800">
<h2 id="done">Done</h2>
<p>The all work is done, you can find the code at <a href="https://github.com/abcdlsj/pasty">github.com/abcdlsj/pasty</a>.</p>
<p>Thanks for reading.</p>
</article>
      </div>
      <hr class="divider" />
      <!-- 
<footer class="footer">
  <p class="footer-author">
    Author <a href="https://github.com/abcdlsj">abcdlsj</a>
  </p>
  <p class="footer-proj">
    Source
    <a href="https://github.com/abcdlsj/abcdlsj.github.io">abcdlsj.github.io</a>
  </p>
</footer>
 -->
    </main>
  </body>
</html>

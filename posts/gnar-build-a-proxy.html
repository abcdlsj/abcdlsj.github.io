
<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8" />
<title>Build a tunnel tool like Frp/Ngrok</title>
<meta name="description" content="Enjoy Focus!" />
<meta name="author" content="Author" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="stylesheet" href="/static/style.css" />
<script
  defer
  src="https://us.umami.is/script.js"
  data-website-id="5af61252-79b1-48a0-a452-fdeefbf6a3ee"
></script>

  </head>
  <body class="container">
    <main>
      <div class="navbar">
<nav class="navbar">
  
  <ul class="menu">
    <li>
      <a href="/"  class="home">Home</a>
    </li>
  </ul>
  
  <ul class="menu">
    <li>
      <a href="/about"  class="about">About</a>
    </li>
  </ul>
  
  <ul class="menu">
    <li>
      <a href="/hosts"  class="hosts">Hosts</a>
    </li>
  </ul>
  
</nav>
</div>
      <hr class="divider" />
      <h1 class="post-single-title">Build a tunnel tool like Frp/Ngrok</h1>
      <hr class="divider" />
      <div class="post-meta">
        <div class="post-date">Date: 2023-11-04T22:47:37+08:00</div>
        <nav class="post-tags">
          
          <a href="/tags/network.html" class="tag">#Network</a>
          
          <a href="/tags/tunnel.html" class="tag">#Tunnel</a>
          
        </nav>
         
        <script>
          var tocContent = document.getElementById("toc-content");
        
          // 监听页面滚动事件
          window.addEventListener("scroll", function () {
            var scrollPosition = window.scrollY || window.pageYOffset;
        
            // 保持TocContent在侧边栏顶部
            tocContent.style.top = scrollPosition + "px";
          });
        
          // 监听目录链接点击事件
          tocContent.addEventListener("click", function (event) {
            if (event.target.tagName === "A") {
              event.preventDefault();
              var targetId = event.target.getAttribute("href").substring(1); // 获取目标位置ID
              var targetElement = document.getElementById(targetId);
              if (targetElement) {
                targetElement.scrollIntoView({ behavior: "smooth" }); // 平滑滚动到目标位置
              }
            }
          });
        </script>
        <div class="sidebar">
          <div class="post-toc"><ul>
<li>
TOC<ul>
<li>
<a href="#background">Background</a></li>
<li>
<a href="#how-to-implement">How to implement</a></li>
<li>
<a href="#codes">Codes</a><ul>
<li>
<a href="#structure">Structure</a></li>
<li>
<a href="#auth">Auth</a></li>
<li>
<a href="#message">Message</a><ul>
<li>
<a href="#format">format</a></li>
<li>
<a href="#packunpack">pack/unpack</a></li>
<li>
<a href="#sendrecv">send/recv</a></li>
</ul>
</li>
<li>
<a href="#forward">Forward</a></li>
<li>
<a href="#exchange">Exchange</a></li>
<li>
<a href="#proxystream">proxy.Stream</a></li>
<li>
<a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li>
<a href="#feature">Feature</a><ul>
<li>
<a href="#auto-https">Auto-Https</a></li>
<li>
<a href="#deploy-at-flyio">Deploy at fly.io</a></li>
<li>
<a href="#udp">UDP</a></li>
<li>
<a href="#speed-limit">Speed limit</a></li>
</ul>
</li>
<li>
<a href="#conclusion-1">Conclusion</a></li>
<li>
<a href="#refs">refs</a></li>
</ul>
</li>
</ul>
</div>
        </div>
         
      </div>
      <hr class="divider" />
      <div class="post-content">
        <article><blockquote>
<p>Changelog:<br>
2023-11-11: 更新了代码结构和接口<br>
2023-11-06: 添加了 <code>yamux</code> 支持</p>
</blockquote>
<h2 id="background">Background</h2>
<p><strong>实现简单的转发工具</strong></p>
<p>公司内部的服务框架 Service 之间通信是通过连接每台机器的 <code>Agent</code> 监听的 <code>UNIX domain</code> 实现的，在公司容器集群环境，都是会启动 <code>Agent</code>。<br>
但是作为本地环境，没有 <code>Agent</code> 的条件，所以本地启动服务都是使用 <code>socat</code> 将本地 <code>UNIX domain</code> 流量转发到远程搭建的 <code>TCP agent</code> 来启动服务的（远程的 <code>TCP agent</code> 也没有什么特殊的，流量也是转发到搭建 <code>TCP agent</code> 机器的本地 <code>Agent</code> 上）<br>
在公司内部，我们一般是使用 <code>socat -d -d -d UNIX-LISTEN:/tmp/xxx.sock,reuseaddr,fork TCP:agent-tcp.xxxx.io:9299</code> 来做转发的。</p>
<blockquote>
<p><code>socat</code> 是一个瑞士军刀类的工具，非常强大</p>
</blockquote>
<p>有次想到既然原理这么简单，那么实现一个类似功能的转发工具应该也很简单，借助 <code>io.Copy()</code> 以及 <code>net</code> 包，一小会就实现了代码，总代码量不超过 50 行，但是却非常实用，启动速度很快（实测竟然比 <code>socat</code> 要稍快）</p>
<p><strong>远程端口转发</strong></p>
<p>再后来想到可以实现一个类似 <code>frp</code> 和 <code>ngrok</code> 的工具，实现的过程中没有借鉴太多其它项目的代码，很多地方都是遇到问题再去查，所以写一篇博客记录下是很值得的，一直没想法去写，这里记录一下思路以及核心代码。<br>
代码是年初 or 去年末写了第一个版本，后边改了一些，现在和最初的版本相比要复杂一些。</p>
<blockquote>
<p>开始的版本只实现 <code>TCP</code> 转发，含有 <code>Caddy</code> 来做 <code>Auto Subdomain https</code>，代码不到 <code>1000</code> 行。后边优化了下，现在支持 <code>TCP/UDP</code> 协议，所以本文只涉及 <code>TCP/UDP</code> 实现（不过其它协议也大都类似<br>
顺带一提，<code>GitHub</code> 有非常多类似的实现，比如 <a href="https://github.com/ekzhang/bore">ekzhang/bore</a> 和 <a href="https://github.com/rapiz1/rathole/">rapiz1/rathole</a>（<code>Tokio</code> 的功能太强大了，忍不住想用 <code>Rust</code> 重写 :P）</p>
</blockquote>
<p>所有的代码都在 <a href="https://github.com/abcdlsj/gnar/tree/484084da8b9edb99fb39e5d7561cc94d16d7031c">abcdlsj/gnar</a> 里（本文纂写时的版本）</p>
<h2 id="how-to-implement">How to implement</h2>
<p>假设有一个服务器（Server）和一个客户端（Client）。其中，服务器的 IP 可以直接从公网访问，而客户端的 IP 则不行，并且客户端可以访问服务器。</p>
<p>我们希望有一种方法来建立服务器端口和客户端端口之间的关联，将对服务器端口的访问转发到客户端的对应端口，通过公网访问服务器的端口就相当于访问客户端的端口。</p>
<p>假设我们 Server 通信端口是 8910，要将 Client 的 3000 端口穿透到 Server 的 9000 端口。<br>
首先 Server 端应该和 Client 端进行通信（8910 端口），对于 Server 端的目标端口（9000）的用户请求，将用户请求和 Client 连接进行流量「代理」，Client 则对本地端口（3000）和通信接口连接进行流量「代理」）。<br>
这样流量路径就是：用户请求 -&gt; Server 「代理」的通信连接（也是 Client 端「代理」的通信连接） -&gt; Client 端本地链接</p>
<p>最后结构差不多就是这样：</p>
<div class="d2"><?xml version="1.0" encoding="utf-8"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" d2Version="v0.5.0-HEAD" preserveAspectRatio="xMinYMin meet" viewBox="0 0 1032 941"><svg id="d2-svg" class="d2-1221737758" width="1032" height="941" viewBox="-101 -100 1032 941"><rect x="-101.000000" y="-100.000000" width="1032.000000" height="941.000000" rx="0.000000" class=" fill-N7" stroke-width="0" /><style type="text/css"><![CDATA[
.d2-1221737758 .text {
	font-family: "d2-1221737758-font-regular";
}
@font-face {
	font-family: d2-1221737758-font-regular;
	src: url("data:application/font-woff;base64,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");
}
.d2-1221737758 .text-bold {
	font-family: "d2-1221737758-font-bold";
}
@font-face {
	font-family: d2-1221737758-font-bold;
	src: url("data:application/font-woff;base64,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");
}
.d2-1221737758 .text-italic {
	font-family: "d2-1221737758-font-italic";
}
@font-face {
	font-family: d2-1221737758-font-italic;
	src: url("data:application/font-woff;base64,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");
}]]></style><style type="text/css"><![CDATA[.shape {
  shape-rendering: geometricPrecision;
  stroke-linejoin: round;
}
.connection {
  stroke-linecap: round;
  stroke-linejoin: round;
}
.blend {
  mix-blend-mode: multiply;
  opacity: 0.5;
}

		.d2-1221737758 .fill-N1{fill:#0A0F25;}
		.d2-1221737758 .fill-N2{fill:#676C7E;}
		.d2-1221737758 .fill-N3{fill:#9499AB;}
		.d2-1221737758 .fill-N4{fill:#CFD2DD;}
		.d2-1221737758 .fill-N5{fill:#DEE1EB;}
		.d2-1221737758 .fill-N6{fill:#EEF1F8;}
		.d2-1221737758 .fill-N7{fill:#FFFFFF;}
		.d2-1221737758 .fill-B1{fill:#0D32B2;}
		.d2-1221737758 .fill-B2{fill:#0D32B2;}
		.d2-1221737758 .fill-B3{fill:#E3E9FD;}
		.d2-1221737758 .fill-B4{fill:#E3E9FD;}
		.d2-1221737758 .fill-B5{fill:#EDF0FD;}
		.d2-1221737758 .fill-B6{fill:#F7F8FE;}
		.d2-1221737758 .fill-AA2{fill:#4A6FF3;}
		.d2-1221737758 .fill-AA4{fill:#EDF0FD;}
		.d2-1221737758 .fill-AA5{fill:#F7F8FE;}
		.d2-1221737758 .fill-AB4{fill:#EDF0FD;}
		.d2-1221737758 .fill-AB5{fill:#F7F8FE;}
		.d2-1221737758 .stroke-N1{stroke:#0A0F25;}
		.d2-1221737758 .stroke-N2{stroke:#676C7E;}
		.d2-1221737758 .stroke-N3{stroke:#9499AB;}
		.d2-1221737758 .stroke-N4{stroke:#CFD2DD;}
		.d2-1221737758 .stroke-N5{stroke:#DEE1EB;}
		.d2-1221737758 .stroke-N6{stroke:#EEF1F8;}
		.d2-1221737758 .stroke-N7{stroke:#FFFFFF;}
		.d2-1221737758 .stroke-B1{stroke:#0D32B2;}
		.d2-1221737758 .stroke-B2{stroke:#0D32B2;}
		.d2-1221737758 .stroke-B3{stroke:#E3E9FD;}
		.d2-1221737758 .stroke-B4{stroke:#E3E9FD;}
		.d2-1221737758 .stroke-B5{stroke:#EDF0FD;}
		.d2-1221737758 .stroke-B6{stroke:#F7F8FE;}
		.d2-1221737758 .stroke-AA2{stroke:#4A6FF3;}
		.d2-1221737758 .stroke-AA4{stroke:#EDF0FD;}
		.d2-1221737758 .stroke-AA5{stroke:#F7F8FE;}
		.d2-1221737758 .stroke-AB4{stroke:#EDF0FD;}
		.d2-1221737758 .stroke-AB5{stroke:#F7F8FE;}
		.d2-1221737758 .background-color-N1{background-color:#0A0F25;}
		.d2-1221737758 .background-color-N2{background-color:#676C7E;}
		.d2-1221737758 .background-color-N3{background-color:#9499AB;}
		.d2-1221737758 .background-color-N4{background-color:#CFD2DD;}
		.d2-1221737758 .background-color-N5{background-color:#DEE1EB;}
		.d2-1221737758 .background-color-N6{background-color:#EEF1F8;}
		.d2-1221737758 .background-color-N7{background-color:#FFFFFF;}
		.d2-1221737758 .background-color-B1{background-color:#0D32B2;}
		.d2-1221737758 .background-color-B2{background-color:#0D32B2;}
		.d2-1221737758 .background-color-B3{background-color:#E3E9FD;}
		.d2-1221737758 .background-color-B4{background-color:#E3E9FD;}
		.d2-1221737758 .background-color-B5{background-color:#EDF0FD;}
		.d2-1221737758 .background-color-B6{background-color:#F7F8FE;}
		.d2-1221737758 .background-color-AA2{background-color:#4A6FF3;}
		.d2-1221737758 .background-color-AA4{background-color:#EDF0FD;}
		.d2-1221737758 .background-color-AA5{background-color:#F7F8FE;}
		.d2-1221737758 .background-color-AB4{background-color:#EDF0FD;}
		.d2-1221737758 .background-color-AB5{background-color:#F7F8FE;}
		.d2-1221737758 .color-N1{color:#0A0F25;}
		.d2-1221737758 .color-N2{color:#676C7E;}
		.d2-1221737758 .color-N3{color:#9499AB;}
		.d2-1221737758 .color-N4{color:#CFD2DD;}
		.d2-1221737758 .color-N5{color:#DEE1EB;}
		.d2-1221737758 .color-N6{color:#EEF1F8;}
		.d2-1221737758 .color-N7{color:#FFFFFF;}
		.d2-1221737758 .color-B1{color:#0D32B2;}
		.d2-1221737758 .color-B2{color:#0D32B2;}
		.d2-1221737758 .color-B3{color:#E3E9FD;}
		.d2-1221737758 .color-B4{color:#E3E9FD;}
		.d2-1221737758 .color-B5{color:#EDF0FD;}
		.d2-1221737758 .color-B6{color:#F7F8FE;}
		.d2-1221737758 .color-AA2{color:#4A6FF3;}
		.d2-1221737758 .color-AA4{color:#EDF0FD;}
		.d2-1221737758 .color-AA5{color:#F7F8FE;}
		.d2-1221737758 .color-AB4{color:#EDF0FD;}
		.d2-1221737758 .color-AB5{color:#F7F8FE;}.appendix text.text{fill:#0A0F25}.md{--color-fg-default:#0A0F25;--color-fg-muted:#676C7E;--color-fg-subtle:#9499AB;--color-canvas-default:#FFFFFF;--color-canvas-subtle:#EEF1F8;--color-border-default:#0D32B2;--color-border-muted:#0D32B2;--color-neutral-muted:#EEF1F8;--color-accent-fg:#0D32B2;--color-accent-emphasis:#0D32B2;--color-attention-subtle:#676C7E;--color-danger-fg:red;}.sketch-overlay-B1{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-B2{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-B3{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-B6{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AA2{fill:url(#streaks-dark);mix-blend-mode:overlay}.sketch-overlay-AA4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AA5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AB4{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-AB5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N1{fill:url(#streaks-darker);mix-blend-mode:lighten}.sketch-overlay-N2{fill:url(#streaks-dark);mix-blend-mode:overlay}.sketch-overlay-N3{fill:url(#streaks-normal);mix-blend-mode:color-burn}.sketch-overlay-N4{fill:url(#streaks-normal);mix-blend-mode:color-burn}.sketch-overlay-N5{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N6{fill:url(#streaks-bright);mix-blend-mode:darken}.sketch-overlay-N7{fill:url(#streaks-bright);mix-blend-mode:darken}.light-code{display: block}.dark-code{display: none}]]></style><defs><pattern id="streaks-bright" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.1)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-normal" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.16)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-dark" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(0, 0, 0, 0.32)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern><pattern id="streaks-darker" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
    <path fill="rgba(255, 255, 255, 0.24)" fill-rule="evenodd" clip-rule="evenodd" d="M58.1193 0H58.1703L55.4939 2.67644L58.1193 0ZM45.7725 0H45.811L41.2851 4.61498L42.7191 3.29325L37.0824 8.92997L35.0554 10.9569L32.0719 13.9404L29.6229 16.5017L27.1738 19.0631L25.8089 20.2034L23.2195 22.6244L18.181 27.6068L23.8178 21.97L27.0615 18.9508L33.8666 11.9773L33.1562 12.5194L37.0262 8.87383L40.784 5.11602L38.0299 7.64561L45.7725 0ZM23.1079 0H23.108L21.5814 1.66688L20.3126 2.79534L23.1079 0ZM7.53869 0H7.54254L7.50005 0.035944L7.53869 0ZM2.49995 0H2.52362L0.900245 1.59971L2.49995 0ZM0 3.64398V3.60744L0.278386 3.36559L0 3.64398ZM0 18.6564V18.5398L0.67985 17.8416L3.4459 15.0755L1.15701 17.1333L2.78713 15.6022L6.01437 12.507L8.5168 9.87253L5.15803 13.2313L11.0357 7.25453L10.4926 7.89678L13.6868 4.7686L8.54982 9.90555L7.05177 11.5687L4.68087 13.9396L0.729379 17.8911L3.01827 15.8333L0 18.6564ZM0 69.2431V69.178L1.64651 67.4763L1.46347 67.7796L5.84063 63.4025L4.42167 64.9016L0 69.4007V69.3408L0.247596 68.9955L0 69.2431ZM2.51594 100H2.49238L5.19989 97.2925L7.70071 95.0162L12.8713 89.6772L12.3094 90.0707L15.288 87.3167L18.1542 84.4504L16.0269 86.3532L22.8752 79.6172L18.5364 84.0683L19.6435 83.0734L15.3441 87.3728L13.798 88.9189L11.5224 91.1945L9.66768 93.1615L7.81297 95.1285L6.74529 95.9716L4.75024 97.7983L2.51594 100ZM7.54255 100H7.5387L9.81396 97.884L8.46606 99.2189L7.54255 100ZM45.8189 100H45.7807L46.9912 98.8047L45.8189 100ZM58.1784 100H58.1272L62.2952 95.7511L66.1408 91.9055L63.0037 94.8115L65.2507 92.6635L69.7117 88.3346L73.2165 84.6977L68.5469 89.3673L76.7379 81.0773L75.9634 81.9509L80.3913 77.5889L73.2496 84.7307L71.1346 87.0107L67.8384 90.3069L62.3447 95.8006L65.4818 92.8947L61.2625 96.9159L58.1784 100ZM75.4277 100H75.229L82.1834 92.9039L81.3403 93.5787L86.0063 89.1371L90.5601 84.5833L87.2464 87.6725L98.0937 76.9375L91.1673 83.9761L92.8932 82.3625L86.0625 89.1933L83.6062 91.6496L79.9907 95.265L77.011 98.357L75.4277 100ZM100 18.5398V18.6563L99.9556 18.6979L95.8065 22.847L100 18.5398ZM100 3.60743V3.64398L99.6791 3.9649L99.2094 4.29428L100 3.60743ZM75.4201 0L74.0312 1.4412L72.401 2.84687L69.281 5.79854L63.1812 11.8422L70.0119 5.01151L73.919 1.32893L75.2214 0H75.4201ZM100 69.1858V69.2509L98.059 71.1919L100 69.1858ZM100 69.3486V69.4085L99.8414 69.5698L100 69.3486ZM41.9398 28.8254L53.6223 16.993L52.5215 18.2437L54.7428 16.0575L54.6875 16.0759L54.8008 16.0004L58.842 12.0231L54.9925 15.8726L55.1085 15.7953L54.898 16.0058L54.84 16.0251L48.6523 22.2128L45.6419 25.473L40.9389 30.1759L33.1007 38.0142L37.5866 33.878L31.558 39.6068L23.3278 47.837L33.0257 37.9393L38.5125 32.4525L34.0266 36.5887L37.2369 33.5283L43.6074 27.3576L48.6023 22.1628L41.9398 28.8254ZM41.0977 17.0531L39.718 18.2925L40.312 17.8388L41.0977 17.0531ZM36.875 20.3106L48.1601 7.88137L42.3438 13.7478L36.875 20.3106ZM35.7125 25.8109L34.3328 27.0503L34.9268 26.5966L35.7125 25.8109ZM17.7022 39.7534L19.0819 38.514L18.8092 38.7867L36.7575 21.8045L23.1569 35.3051L13.5771 43.7372L18.1448 39.4154L17.7022 39.7534ZM3.48102 28.9281L1.53562 30.8735L1.22228 31.0465L0.0765686 32.3326L1.60579 30.9437L2.57849 29.971L3.48102 28.9281ZM0.953463 26.2027L19.5702 7.58594L9.31575 18.6078L0.953463 26.2027ZM23.7175 12.11L17.9339 18.0875L21.4622 14.5592L20.8074 15.4725L28.1915 7.95918L30.4791 5.54232L23.4224 12.599L23.7175 12.11ZM43.4641 43.1538L40.7872 46.1552L42.4907 44.4517L42.3285 45.0465L45.8166 41.3421L46.8441 40.0983L43.4371 43.5053L43.4641 43.1538ZM1.32715 48.3271L8.0918 41.5625L4.3657 45.5674L1.32715 48.3271ZM11.1479 31.2556L11.5689 30.975L11.3584 31.1855L11.1479 31.2556ZM11.9898 27.4667L12.2003 27.2562L11.7793 27.5369L11.9898 27.4667ZM11.3585 34.5531L11.148 34.7636L10.9375 34.8338L11.3585 34.5531ZM72.929 28.5457L82.2965 19.0792L81.4043 20.0705L86.4597 15.0811L78.2983 23.2425L75.8697 25.8362L72.1029 29.603L65.8249 35.881L69.3934 32.5437L64.5858 37.1531L57.994 43.745L65.7754 35.8314L70.17 31.4369L66.6015 34.7742L69.1623 32.3125L74.2507 27.3562L78.2653 23.2095L72.929 28.5457ZM82.6674 1.83549L84.3245 0.31872L83.3724 1.27088L82.6674 1.83549ZM64.5872 16.1312L62.9301 17.648L63.6351 17.0834L64.5872 16.1312ZM70.868 9.85044L80.0048 1.1214L74.6221 6.47142L70.868 9.85044ZM90.2409 41.9448L70.7578 61.4279L79.5093 53.4795L90.2409 41.9448ZM91.8088 42.5434L95.3963 38.8357L95.2132 39.139L99.5904 34.7618L98.1714 36.261L93.5912 40.9214L93.9973 40.3549L91.8088 42.5434ZM94.331 12.8233L89.9853 17.1691L89.2853 17.5555L86.7259 20.4284L90.142 17.3258L92.3149 15.1529L94.331 12.8233ZM44.7972 62.3259L76.9824 30.1406L59.2542 49.1955L44.7972 62.3259ZM77.1482 40.321L70.1709 47.5323L70 47.6463L70.0895 47.6164L68.1916 49.5779L70.185 47.5846L70.2105 47.5761L70.421 47.3656L70.37 47.3996L73.6557 44.1139L72.6416 45.5283L84.0768 33.893L87.6194 30.1502L76.6913 41.0783L77.1482 40.321ZM50.5355 34.3137L72.6617 12.1875L60.4955 25.3084L50.5355 34.3137ZM70.2104 44.0681L70.6314 43.7875L70.4209 43.998L70.2104 44.0681ZM71.263 40.0687L70.842 40.3494L71.0525 40.2792L71.263 40.0687ZM55.1084 12.4355L55.3189 12.225L54.8979 12.5056L55.1084 12.4355ZM48.8718 15.5785L60.2075 4.70496L49.4056 15.4006L48.8718 15.5785ZM23.7636 57.4491L29.9099 51.5854L26.1656 55.6123L27.2361 54.8244L23.435 58.6255L22.0681 59.9924L20.0562 62.0042L18.5082 63.8349L16.9601 65.6656L15.8328 66.2277L13.9315 67.7051L10.4821 71.0132L14.2832 67.2121L16.6775 65.383L21.1113 60.5253L20.477 60.7357L23.2937 58.4842L25.8277 55.9502L23.7636 57.4491ZM48.3825 74.1824L44.8832 77.8523L46.9145 75.8211L45.4748 77.4881L43.4493 79.2862L42.4082 80.1568L43.9215 79.0414L42.2487 80.7143L39.3752 83.8151L41.8844 81.3059L43.8473 79.6842L42.334 80.7995L44.7237 78.4098L46.1576 76.976L46.9713 75.8779L50.078 72.7713L48.1093 74.6262L48.3825 74.1824ZM29.2877 62.9906L29.0772 63.2011L28.8667 63.2713L29.2877 62.9906ZM29.7088 59.4823L29.9193 59.2719L29.4983 59.5525L29.7088 59.4823ZM29.0772 66.5687L28.8667 66.7792L28.6562 66.8494L29.0772 66.5687ZM22.9729 68.748L23.1834 68.5375L22.7624 68.8181L22.9729 68.748ZM3.8147e-05 91.7593L13.2499 79.1355L6.5001 86.2595L3.8147e-05 91.7593ZM16.0685 87.9974L17.1375 87.0687L16.5382 87.668L16.0685 87.9974ZM21.7869 79.3344L20.7179 80.263L21.1876 79.9337L21.7869 79.3344ZM12.3607 95.0755L13.4298 94.1469L12.8304 94.7462L12.3607 95.0755ZM42.7176 59.3801L43.2789 58.8187L43.0684 59.1696L42.7877 59.4502L42.2966 59.801L42.5772 59.3801H42.7176ZM26.3124 49.3152L24.3599 51.2676L23.996 51.3918L22.8956 52.732L24.4798 51.3875L25.456 50.4113L26.3124 49.3152ZM39.0689 63.3097L38.5777 63.6606L39.56 62.6782L39.0689 63.3097ZM20.3574 55.8032L19.3751 56.7856L19.8662 56.4347L20.3574 55.8032ZM39.9297 64.195L41.5504 62.3779L41.534 62.5907L43.5967 60.528L42.9746 61.2811L40.8628 63.5238L40.961 63.1637L39.9297 64.195ZM22.3921 55.457L21.3998 56.5696L22.0313 55.9381L21.9711 56.1587L23.2642 54.7854L23.6451 54.3243L22.3821 55.5873L22.3921 55.457ZM40.6473 92.4498L45.0485 88.0485L43.0066 90.4079L40.806 92.6085L37.3463 95.7507L39.9384 92.8412L40.6473 92.4498ZM18.5042 48.7973L11.5457 55.7558L10.4249 56.3746L6.32684 60.9746L11.7967 56.0067L15.2759 52.5275L18.5042 48.7973ZM32.7113 78.139L31.1131 79.7372L30.8432 79.8668L29.9145 80.9358L31.1833 79.8074L31.9823 79.0083L32.7113 78.139ZM21.7577 93.9525L31.2855 84.0344L30.8324 84.8777L42.4999 73.2102L38.7408 77.2295L26.5552 89.6753L27.5914 88.1187L21.7577 93.9525ZM98.5132 90.0591L89.9224 97.9224L93.5769 94.9953L98.5132 90.0591ZM97.8456 80.2105L99.5027 78.6937L98.5506 79.6459L97.8456 80.2105ZM88.5656 56.4599L78.9205 65.7009L82.1262 63.3036L78.1413 67.2885L73.7522 70.8692L74.7195 70.5082L67.717 78.117L63.992 81.0336L58.0146 87.011L63.4289 81.7988L66.3887 79.4454L68.1212 78.5213L70.5757 75.6625L73.0302 72.8038L76.194 69.64L78.3434 67.4906L84.3208 61.5132L82.6575 62.7723L88.5656 56.4599ZM85.1893 67.0375L83.7304 68.356L84.3561 67.8707L85.1893 67.0375ZM90.7969 58.2022L99.2725 50.5418L94.4317 55.3826L90.7969 58.2022ZM79.377 76.2172L77.9182 77.5357L78.5438 77.0504L79.377 76.2172ZM59.4922 91.7253L56.4011 94.1231L60.0049 90.8659L63.6087 87.6087L59.4922 91.7253ZM63.8833 75.4153L46 92.3896L49.6884 89.1193L53.3767 85.8491L63.8833 75.4153ZM71.6063 55.0765L69.6609 57.0219L69.3475 57.1949L68.2018 58.481L69.731 57.0921L70.7037 56.1194L71.6063 55.0765ZM55.1405 71.6857L61.4131 65.4131L57.958 69.1267L55.1405 71.6857ZM65.8396 69.4497L61.7138 73.7138L64.2308 71.1968L63.7637 71.8484L69.0313 66.4886L70.6632 64.7645L65.6292 69.7985L65.8396 69.4497ZM53.0034 65.4955L58.2258 59.8914L58.0558 60.4431L64.5517 53.9472L62.5136 56.2398L55.7841 63.2238L56.2513 62.2475L53.0034 65.4955ZM97.0997 71.2032L79.6514 88.6515L86.7697 80.814L97.0997 71.2032ZM35.1848 56.2513L31.93 59.9006L34.0012 57.8294L33.804 58.5527L38.0451 54.0485L39.2945 52.5361L35.1519 56.6787L35.1848 56.2513ZM66.8712 26.2471L78.1907 14.3099L77.7244 15.394L91.6784 1.4399L87.233 6.29715L72.7096 21.2323L73.8482 19.2701L66.8712 26.2471ZM28.0473 68.2068L20.4355 76.375L25.1695 71.641L24.4884 73.0639L34.297 62.8844L37.2675 59.5429L27.7995 69.0109L28.0473 68.2068ZM8.94067 39.5658L14.1631 33.9617L13.993 34.5134L20.4889 28.0175L18.4509 30.3101L11.7213 37.2941L12.1886 36.3178L8.94067 39.5658ZM99.7403 26L88 37.7404L93.2735 32.9508L99.7403 26ZM1.93388 8.08743L4.77765 5.04974L4.67856 5.34275L8.20743 1.81388L7.09578 3.05481L3.4355 6.84437L3.69832 6.32299L1.93388 8.08743ZM54.4485 44.211L48.5985 50.061L47.6563 50.5813L44.211 54.4485L48.8095 50.272L51.7345 47.347L54.4485 44.211Z" />
</pattern></defs><g id="Flow"><g class="shape" ><path d="M-0.640124 -0.231351 L830.418220 0.724412 L830.101479 698.293629 L0.370222 699.612993" transform="translate(0.000000 41.000000)" class="shape stroke-B1 fill-B4" style="stroke-width:2;" /><path d="M0.342905 0.385553 C165.875829 -0.880370, 331.783413 -2.037704, 829.682562 0.156934 M-0.259466 0.105839 C183.897851 -2.541112, 367.478697 -2.768981, 829.767850 0.301126 M830.614681 -0.699773 C827.857613 152.526215, 828.134228 303.411907, 830.556219 698.652258 M830.119071 -0.319709 C831.857139 187.264585, 831.466552 375.228190, 830.162750 699.140897 M830.421120 698.914623 C651.404015 705.491469, 471.310251 705.274059, 0.734582 698.838590 M829.622629 698.942507 C517.957406 699.865536, 206.303481 699.756950, 0.375579 699.016737 M-0.288241 698.887412 C-3.554001 497.908934, -4.246974 298.112572, 0.236720 -0.482432 M0.087182 699.399289 C-3.750618 444.465803, -3.548196 190.094561, 0.176296 0.395212" transform="translate(0.000000 41.000000)" class="shape stroke-B1 fill-B4" style="stroke-width:2;" /><rect width="830.000000" height="699.000000" transform="translate(0.000000 41.000000)" class=" sketch-overlay-B4" /></g><text x="415.000000" y="28.000000" class="text fill-N1" style="text-anchor:middle;font-size:28px">Flow</text></g><g id="Flow.server"><g class="shape" ><path d="M-1.600310 -0.578379 L680.045551 1.811030 L679.253697 128.234072 L0.925556 131.532483" transform="translate(49.000000 293.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.342905 0.385553 C135.675150 -0.635561, 271.382055 -1.792895, 678.682562 0.156934 M-0.259466 0.105839 C150.473715 -2.019600, 300.630426 -2.247469, 678.767850 0.301126 M680.536704 -1.749433 C678.898428 29.505557, 679.589964 54.909808, 680.390547 129.130645 M679.297677 -0.799274 C680.060496 34.031330, 679.084027 69.810208, 679.406876 130.352243 M679.421120 129.914623 C532.970559 135.296444, 385.443339 135.079034, 0.734582 129.838590 M678.622629 129.942507 C423.720206 130.727269, 168.829081 130.618683, 0.375579 130.016737 M-0.720604 129.718532 C-0.626143 91.186407, -2.358576 55.609573, 0.591800 -1.206080 M0.217956 130.998223 C-2.375333 82.056446, -1.869278 34.520280, 0.440740 0.988030" transform="translate(49.000000 293.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="679.000000" height="130.000000" transform="translate(49.000000 293.000000)" class=" sketch-overlay-B5" /></g><text x="388.500000" y="281.000000" class="text fill-N1" style="text-anchor:middle;font-size:24px">server</text></g><g id="Flow.client"><g class="shape" ><path d="M-1.600310 -0.578379 L667.045551 1.811030 L666.253697 128.234072 L0.925556 131.532483" transform="translate(53.000000 580.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.342905 0.385553 C133.075092 -0.614484, 266.181938 -1.771819, 665.682562 0.156934 M-0.259466 0.105839 C147.596140 -1.974701, 294.875276 -2.202570, 665.767850 0.301126 M667.536704 -1.749433 C665.898428 29.505557, 666.589964 54.909808, 667.390547 129.130645 M666.297677 -0.799274 C667.060496 34.031330, 666.084027 69.810208, 666.406876 130.352243 M666.421120 129.914623 C522.774301 135.193561, 378.050823 134.976151, 0.734582 129.838590 M665.622629 129.942507 C415.607070 130.715365, 165.602808 130.606779, 0.375579 130.016737 M-0.720604 129.718532 C-0.626143 91.186407, -2.358576 55.609573, 0.591800 -1.206080 M0.217956 130.998223 C-2.375333 82.056446, -1.869278 34.520280, 0.440740 0.988030" transform="translate(53.000000 580.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="666.000000" height="130.000000" transform="translate(53.000000 580.000000)" class=" sketch-overlay-B5" /></g><text x="386.000000" y="568.000000" class="text fill-N1" style="text-anchor:middle;font-size:24px">client</text></g><g id="Flow.user"><g class="shape" ><path d="M-1.600310 -0.578379 L78.045551 1.811030 L77.253697 64.234072 L0.925556 67.532483" transform="translate(267.000000 70.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><path d="M0.857263 0.963884 C15.080592 0.851080, 30.240568 -2.042255, 76.206405 0.392335 M-0.648665 0.264598 C17.483548 0.148857, 34.174583 -0.420815, 76.419625 0.752815 M78.536704 -1.749433 C77.489431 15.585410, 78.180967 27.069513, 78.390547 65.130645 M77.297677 -0.799274 C77.657560 16.854002, 76.681091 35.455552, 77.406876 66.352243 M78.052801 65.786559 C61.423647 67.330430, 42.102845 66.786905, 1.836456 65.596476 M76.056573 65.856267 C47.966857 66.440085, 19.905385 66.168621, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(267.000000 70.000000)" class="shape stroke-B1 fill-B5" style="stroke-width:2;" /><rect width="77.000000" height="66.000000" transform="translate(267.000000 70.000000)" class=" sketch-overlay-B5" /></g><text x="305.500000" y="108.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">user</text></g><g id="Flow.server.remoteport 9000"><g class="shape" ><path d="M-1.600310 -0.578379 L164.045551 1.811030 L163.253697 64.234072 L0.925556 67.532483" transform="translate(224.000000 325.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><path d="M0.857263 0.963884 C32.280978 0.502511, 64.641341 -2.390824, 162.206405 0.392335 M-0.648665 0.264598 C36.519810 -0.593693, 72.247109 -1.163366, 162.419625 0.752815 M164.536704 -1.749433 C163.489431 15.585410, 164.180967 27.069513, 164.390547 65.130645 M163.297677 -0.799274 C163.657560 16.854002, 162.681091 35.455552, 163.406876 66.352243 M164.052801 65.786559 C128.875814 69.031956, 91.007179 68.488431, 1.836456 65.596476 M162.056573 65.856267 C101.638375 66.636955, 41.248420 66.365491, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(224.000000 325.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><rect width="163.000000" height="66.000000" transform="translate(224.000000 325.000000)" class=" sketch-overlay-B6" /></g><text x="305.500000" y="363.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">remoteport 9000</text></g><g id="Flow.client.localport 3000"><g class="shape" ><path d="M-1.600310 -0.578379 L147.045551 1.811030 L146.253697 64.234072 L0.925556 67.532483" transform="translate(232.000000 612.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><path d="M0.857263 0.963884 C28.880902 0.571414, 57.841189 -2.321921, 145.206405 0.392335 M-0.648665 0.264598 C32.756828 -0.446910, 64.721144 -1.016583, 145.419625 0.752815 M147.536704 -1.749433 C146.489431 15.585410, 147.180967 27.069513, 147.390547 65.130645 M146.297677 -0.799274 C146.657560 16.854002, 145.681091 35.455552, 146.406876 66.352243 M147.052801 65.786559 C115.542246 68.695607, 81.340043 68.152083, 1.836456 65.596476 M145.056573 65.856267 C91.028889 66.598039, 37.029448 66.326575, 0.938949 66.041844 M-0.720604 65.718532 C0.302797 45.542204, -1.429636 28.321166, 0.591800 -1.206080 M0.217956 66.998223 C-1.587850 41.337487, -1.081795 17.082362, 0.440740 0.988030" transform="translate(232.000000 612.000000)" class="shape stroke-B1 fill-B6" style="stroke-width:2;" /><rect width="146.000000" height="66.000000" transform="translate(232.000000 612.000000)" class=" sketch-overlay-B6" /></g><text x="305.000000" y="650.500000" class="text-bold fill-N1" style="text-anchor:middle;font-size:16px">localport 3000</text></g><g id="Flow.(client &lt;-&gt; server)[0]"><marker id="mk-2451250203" markerWidth="10.000000" markerHeight="12.000000" refX="3.000000" refY="6.000000" viewBox="0.000000 0.000000 10.000000 12.000000" orient="auto" markerUnits="userSpaceOnUse"> <polygon points="10.000000,0.000000 0.000000,6.000000 10.000000,12.000000" class="connection fill-B1" stroke-width="2" /> </marker><marker id="mk-3488378134" markerWidth="10.000000" markerHeight="12.000000" refX="7.000000" refY="6.000000" viewBox="0.000000 0.000000 10.000000 12.000000" orient="auto" markerUnits="userSpaceOnUse"> <polygon points="0.000000,0.000000 10.000000,6.000000 0.000000,12.000000" class="connection fill-B1" stroke-width="2" /> </marker><path d="M480.000044 575.670064 M480.000044 575.670064 C481.481942 503.140111, 481.581585 471.519926, 481.202656 427.428631 M479.134962 575.273267 C480.714643 503.839632, 480.189168 472.130736, 481.245209 426.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-1221737758)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(481.000000 576.500000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(481.000000 576.500000) rotate(90.00000250447816)" /> <path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(481.000000 427.000000) rotate(-90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(481.000000 427.000000) rotate(-90.00000250447816)" /><text x="481.000000" y="507.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">1. Port 8910(create control connection, auth, send request forward...)</text></g><g id="Flow.(user -&gt; server)[0]"><path d="M304.250044 137.670064 M304.250044 137.670064 C305.731942 184.740117, 305.831585 216.119932, 305.452656 290.428631 M303.384962 137.273267 C304.964643 185.439638, 304.439168 216.730742, 305.495209 289.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-1221737758)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(305.250000 290.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(305.250000 290.000000) rotate(90.00000250447816)" /><text x="305.000000" y="221.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">2. View remote port 9000</text></g><g id="Flow.(server -&gt; server)[0]"><path d="M387.723834 362.021350 M387.723834 362.021350 C483.497933 347.274113, 513.681561 343.219938, 522.327656 343.928631 M386.858752 361.624553 C482.730634 347.973634, 512.289144 343.830748, 522.370209 342.516898 M522.370209 342.516898 C531.236416 343.744026, 542.602608 350.852821, 552.647460 360.813699 M521.545232 342.055176 C530.056628 344.186815, 543.951894 351.219031, 552.493136 360.960440 M552.493136 360.960440 C560.798293 369.583951, 561.547764 382.509098, 551.387612 393.695273 M552.790814 360.161166 C560.314925 369.934134, 561.741567 383.540310, 552.510548 391.924853 M552.510548 391.924853 C544.172242 403.426394, 482.909270 406.080216, 389.854305 390.731591 M552.414034 391.083056 C542.930780 403.848901, 482.719646 405.708075, 390.237235 391.618247" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-1221737758)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(390.697581 390.470462) rotate(-170.71400766248715)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(390.697581 390.470462) rotate(-170.71400766248715)" /><text x="561.500000" y="381.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">3. Proxy(8910 connection, 9000 connection)</text></g><g id="Flow.(server -&gt; client)[0]"><path d="M128.500044 424.670064 M128.500044 424.670064 C129.981942 471.740117, 130.081585 503.119932, 129.702656 577.428631 M127.634962 424.273267 C129.214643 472.439638, 128.689168 503.730742, 129.745209 576.016898" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-1221737758)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(129.500000 577.000000) rotate(90.00000250447816)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(129.500000 577.000000) rotate(90.00000250447816)" /><text x="129.500000" y="508.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">4. Send start proxy request</text></g><g id="Flow.(client -&gt; client)[0]"><path d="M379.221433 649.850983 M379.221433 649.850983 C474.731942 634.443150, 504.831585 630.219938, 513.452656 630.928631 M378.356351 649.454186 C473.964643 635.142671, 503.439168 630.830748, 513.495209 629.516898 M513.495209 629.516898 C522.336392 630.744026, 533.669625 637.852791, 543.689452 647.813699 M512.670232 629.055176 C521.156604 631.186815, 535.018911 638.219001, 543.535128 647.960440 M543.535128 647.960440 C551.815322 656.583981, 552.564793 669.509068, 542.429604 680.695273 M543.832806 647.161166 C551.331954 656.934164, 552.758596 670.540280, 543.552540 678.924853 M543.552540 678.924853 C535.239259 690.426424, 474.143279 692.911210, 381.349501 676.916320 M543.456026 678.083056 C533.997797 690.848931, 473.953655 692.539069, 381.732431 677.802976" fill="none" class="connection stroke-B1" style="stroke-width:2;" mask="url(#d2-1221737758)" /><path d="M-8.527627 -3.097061 L1.749550 0.558791 L-8.562935 4.521533" stroke="none" class="connection fill-B1" style="stroke-width:0;" transform="translate(382.192777 676.655191) rotate(-170.29687434949614)" /> <path d="M-10.153731 -4.038897 C-7.293657 -2.964754, -5.552453 -3.126871, 0.222305 -0.654474 M-10.160117 -4.253535 C-7.616436 -2.677663, -5.569656 -2.320404, -0.086565 0.272291 M0.578048 -0.807164 C-2.240460 1.133634, -3.845699 1.135504, -9.579367 4.140709 M-0.217907 -0.322328 C-3.660571 0.941126, -7.003142 2.167050, -10.100296 3.840861 M-9.957758 4.629247 C-9.937438 2.794817, -10.508655 0.509238, -9.330834 -3.522818 M-10.354741 4.285014 C-9.712366 0.996453, -9.805329 -1.235319, -9.648840 -4.366524" fill="none" class="connection stroke-B1" style="stroke-width:2;" transform="translate(382.192777 676.655191) rotate(-170.29687434949614)" /><text x="552.000000" y="668.000000" class="text-italic fill-N2" style="text-anchor:middle;font-size:16px">5. Proxy(8910 connection, 3000 connection)</text></g><mask id="d2-1221737758" maskUnits="userSpaceOnUse" x="-101" y="-100" width="1032" height="941">
<rect x="-101" y="-100" width="1032" height="941" fill="white"></rect>
<rect x="387.500000" y="0.000000" width="55" height="36" fill="rgba(0,0,0,0.75)"></rect>
<rect x="357.000000" y="257.000000" width="63" height="31" fill="rgba(0,0,0,0.75)"></rect>
<rect x="358.500000" y="544.000000" width="55" height="31" fill="rgba(0,0,0,0.75)"></rect>
<rect x="289.500000" y="92.500000" width="32" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="246.500000" y="347.500000" width="118" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="254.500000" y="634.500000" width="101" height="21" fill="rgba(0,0,0,0.75)"></rect>
<rect x="257.000000" y="491.000000" width="448" height="21" fill="black"></rect>
<rect x="224.000000" y="205.000000" width="162" height="21" fill="black"></rect>
<rect x="421.000000" y="365.000000" width="281" height="21" fill="black"></rect>
<rect x="42.000000" y="492.000000" width="175" height="21" fill="black"></rect>
<rect x="412.000000" y="652.000000" width="280" height="21" fill="black"></rect>
</mask></svg></svg></div><p>这里省略了一些值得思考的东西，比如：</p>
<ol>
<li>Client 端和 Server 端建立连接 <code>Auth/Handshake</code> 的部分，如何「鉴权」？</li>
<li><code>Control</code> 连接里的消息是否固定长度？如果不固定，怎么处理「边界」问题？</li>
<li>Client 端接收到 <code>Proxy</code> 请求后，进行 <code>io.Copy()</code> 的是哪个连接，Server 端又怎样处理呢？</li>
</ol>
<blockquote>
<p>对于 1 和 2 可以看下面的详细实现<br>
对于 3，如果没有实现过类似的工具可能不太清楚为什么会有这个问题，看了下面详细的流程大概就清楚了（忽略「鉴权」部分</p>
</blockquote>
<ol>
<li>首先启动 Server 端，监听 8910 端口</li>
<li>启动 Client, Client 端和 Server 端建立 <code>Control</code> 连接，然后发送一条 <code>Forward</code> 接口告诉 Server 端将要转发到 9000 端口</li>
<li>Server 端从 <code>Control</code> 连接接收到 <code>Forward</code> 消息，开始对 9000 端口进行监听，准备接收来自用户端的请求</li>
<li>当有新的用户请求到来时，Server 端通过 <code>Control</code> 连接发送 <code>Exchange</code> 消息，告诉 Client 端：有新的用户连接，准备开始对流量进行 <code>Copy</code></li>
</ol>
<blockquote>
<p>此时 Server 是否要 <code>Copy</code> 用户连接和 <code>Control</code> 连接呢？<br>
答案是不应该也不能，因为 <code>Control</code> 连接还会有来自 Server 或者 Client 的「其它」的流量，例如 <code>Close</code>、<code>Heartbeat</code> 消息等，这些流量如果直接 <code>Copy</code> 到用户连接上，那就会产生问题。</p>
</blockquote>
<ol start="5">
<li>Client 端接收到 <code>Exchange</code> 消息，建立连接到 <code>Local 3000</code> 端口，准备 <code>Copy</code> 流量</li>
</ol>
<blockquote>
<p>Client 端也不能直接 <code>Copy</code> <code>Control</code> 连接和 <code>Local 3000</code> 连接，和 4 是一样的情况</p>
</blockquote>
<p>这就是「连接复用」的问题，这个问题在对多端流量进行处理的时候很常见。<br>
解决这个问题有很多方法：</p>
<ol>
<li>可以使用连接复用库，例如 <a href="https://github.com/hashicorp/yamux">hashicorp/yamux</a>，<code>frp</code> 默认使用 <code>yamux</code></li>
<li>对报文在应用层自行区分，同时 <code>Copy</code> 的部分也要做处理（<code>yamux</code> 就是对报文做了处理）</li>
<li>最简单的方法，也是大多数内网转发工具用的方法，就是如果需要 <code>Copy</code> 就新建一个连接，简单有效</li>
</ol>
<blockquote>
<p>方法 3 可能存在的问题是，端口的连接总数是有限的，但是正常都足够的（只要实现上连接有正常 <code>Close</code>，在 Client 不是很多的情况下是没有太大问题的</p>
</blockquote>
<p>方法 1 和 方法 3 是最适合的，这里为了简单，我选择方法 3 来实现（<code>yamux</code> 接入也非常简单，后续会支持；11/6 Update，<a href="https://github.com/abcdlsj/gnar/commit/fb5ca54b60ea9b1b2df3e877ad2978af0beba09f">commit</a> 加上了 <code>yamux</code> 支持）</p>
<p>选择方法 3 后，因为 Server 端并不能新建通信连接，所以需要告诉 Client 新建连接，因为 Client 会 <code>Copy</code> <code>Local 3000</code> 流量到这个新建的连接上，所以对于「主分支」的 Server 来说，它需要判断是 <code>Forward</code> 还是 <code>Exchange</code> 消息，然后如果是 <code>Exchange</code>，需要「拿出」用户连接 <code>Copy</code> 到此 <code>Exchange</code> 消息的连接上。</p>
<p>所以步骤 3，Server 需要保存用户请求，创建对应的 <code>Connection UUID</code>，然后带上发送 <code>Exchange</code> 消息到 Client<br>
步骤 5，Client 需要接收到 <code>Exchange</code> 消息，新建 Server 连接，然后首先发送带上同样 <code>UUID</code> 的 <code>Exchange</code> 消息到 Server，然后 <code>Copy</code> <code>Local 3000</code> 流量到此新建的 Server 连接上<br>
步骤 6. Server 接收到 <code>Exchange</code> 消息，通过 <code>UUID</code> 取出对应的用户连接，然后 <code>Copy</code> 用户连接流量和此连接</p>
<p>至此，用户访问 Server 端 9000 端口的「一个连接」的访问流程已经完成了<br>
流程很简单，那么接下来，我会写一下每个流程的代码实现</p>
<h2 id="codes">Codes</h2>
<h3 id="structure">Structure</h3>
<p>结构大概是这样</p>
<pre><code>.
├── client
│   ├── cfg.toml
│   ├── cmd.go
│   ├── config.go
│   └── serve.go
├── cmd
│   └── cmd.go
├── logger
│   └── log.go
├── main.go
├── pio
│   ├── encrypt.go
│   └── limit.go
├── proto
│   ├── error.go
│   ├── msg.go
│   └── packet.go
├── proxy
│   ├── buf.go
│   ├── proxy.go
│   └── udp.go
└── server
    ├── cfg.toml
    ├── cmd.go
    ├── config.go
    ├── conn
    │   ├── constant.go
    │   ├── tcp.go
    │   └── udp.go
    └── serve.go
</code></pre>
<p>简要描述下：</p>
<ul>
<li>cmd: <code>cmd</code> 入口，<code>cobra</code></li>
<li>proxy：对两个连接进行 <code>Copy</code> 的部分</li>
<li>proto：<code>Control</code> 发送的消息结构体，以及序列化封装</li>
<li>client：Client 处理流程</li>
<li>server：Server 处理流程</li>
<li>pio: <code>io.Reader</code> 和 <code>io.Writer</code> 的封装，实现限速（<code>Speed limit</code>）的功能</li>
</ul>
<h3 id="auth">Auth</h3>
<p>因为打算通过 <code>Message</code> 发送来带出主体代码，所以就不分别写 <code>Client</code> 和 <code>Server</code> 的结构体了</p>
<p><code>Auth</code> 采用简单的 Token 校验，消息里有 <code>Token</code> 以及 <code>Timestamp</code> 字段，收到消息会 <code>md5(Token + Timestamp)</code> 进行校验（最开始我的实现 Client 和 Server 每个收发消息都会带上校验字段，好处是少一次 Auth 的发送时间，后来看到很多实现都只是在建立连接的时候校验，所以也改成连接创建时校验）</p>
<p><code>MsgLogin</code> 结构体<br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/msg.go#L56">proto/msg.go#L56</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> MsgLogin <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	Token     <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;token&#34;`</span>
</span></span><span style="display:flex;"><span>	Version   <span style="color:#458;font-weight:bold">string</span> <span style="color:#d14">`json:&#34;client_version&#34;`</span>
</span></span><span style="display:flex;"><span>	Timestamp <span style="color:#458;font-weight:bold">int64</span>  <span style="color:#d14">`json:&#34;timestamp&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><strong>Client</strong> <code>Dial</code> 创建和 <code>Auth</code> 部分差不多是这样<br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L75">client/serve.go#L75</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(svraddr <span style="color:#458;font-weight:bold">string</span>, token <span style="color:#458;font-weight:bold">string</span>) (net.Conn, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	conn, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Dial</span>(<span style="color:#d14">&#34;tcp&#34;</span>, svraddr)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(conn, proto.<span style="color:#900;font-weight:bold">NewMsgLogin</span>(token)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> conn, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><code>Auth</code> 的部分还有其它更有意思的实现，例如 <code>OpenID Connect (OIDC)</code>，可以实现扫码认证之类的功能</p>
<p><strong>Server 部分</strong><br>
Server 会 <code>Listen</code> 端口 <code>8910</code>，等待 Client 连接到来（默认都用 <code>8910</code>）<br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L38-L62">server/serve.go#L38-L62</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">Run</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  listener, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Listen</span>(<span style="color:#d14">&#34;tcp&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, s.cfg.Port))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Error listening: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> listener.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		conn, err <span style="color:#000;font-weight:bold">:=</span> listener.<span style="color:#900;font-weight:bold">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Error accepting: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> s.<span style="color:#900;font-weight:bold">handle</span>(conn)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Server handle 部分对 <code>MsgLogin</code> 进行校验，校验不通过直接断开连接<br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L64-L79">server/serve.go#L64-L79</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handle</span>(conn net.Conn) {
</span></span><span style="display:flex;"><span>	loginMsg <span style="color:#000;font-weight:bold">:=</span> proto.MsgLogin{}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(conn, <span style="color:#000;font-weight:bold">&amp;</span>loginMsg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading from connection: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		conn.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	hash <span style="color:#000;font-weight:bold">:=</span> md5.<span style="color:#900;font-weight:bold">New</span>()
</span></span><span style="display:flex;"><span>	hash.<span style="color:#900;font-weight:bold">Write</span>([]<span style="color:#0086b3">byte</span>(s.cfg.Token <span style="color:#000;font-weight:bold">+</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%d&#34;</span>, loginMsg.Timestamp)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%x&#34;</span>, hash.<span style="color:#900;font-weight:bold">Sum</span>(<span style="color:#000;font-weight:bold">nil</span>)) <span style="color:#000;font-weight:bold">!=</span> loginMsg.Token {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Invalid token, client addr: %s&#34;</span>, conn.<span style="color:#900;font-weight:bold">RemoteAddr</span>().<span style="color:#900;font-weight:bold">String</span>())
</span></span><span style="display:flex;"><span>		conn.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><blockquote>
<p>这里最开始是想的返回 <code>MsgLoginResp</code> 但是发现其实没有必要，直接断开也是可以的</p>
</blockquote>
<p>这里用到 <code>proto.Send</code>，接下来会介绍 <code>message</code> 的实现</p>
<h3 id="message">Message</h3>
<p><code>TCP</code> 是 <code>Stream</code> 协议，我们并不知道需要读取多少字节，每个消息的长度也都是不固定的，所以需要实现自己的序列化规则</p>
<h4 id="format">format</h4>
<p>规定 <code>Message</code> 的 <code>format</code> 如下：</p>
<pre><code>|&lt;1 byte&gt;|&lt;2 byte&gt;|&lt;length byte&gt;|
|PacketType|Length| Json Message|
</code></pre>
<h4 id="packunpack">pack/unpack</h4>
<p><a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/packet.go#L42">proto/packet.go#L42</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">packet</span>(typ PacketType, msg <span style="color:#000;font-weight:bold">interface</span>{}) ([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	buf, err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Marshal</span>(msg)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">packet0</span>(typ, buf)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">packet0</span>(typ PacketType, buf []<span style="color:#458;font-weight:bold">byte</span>) ([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(buf) &gt; <span style="color:#099">65535</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, ErrMsgLength
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ret <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">3</span><span style="color:#000;font-weight:bold">+</span><span style="color:#0086b3">len</span>(buf))
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">0</span>] = <span style="color:#0086b3">byte</span>(typ)
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">1</span>] = <span style="color:#0086b3">byte</span>(<span style="color:#0086b3">len</span>(buf) <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#099">8</span>)
</span></span><span style="display:flex;"><span>	ret[<span style="color:#099">2</span>] = <span style="color:#0086b3">byte</span>(<span style="color:#0086b3">len</span>(buf))
</span></span><span style="display:flex;"><span>	<span style="color:#0086b3">copy</span>(ret[<span style="color:#099">3</span>:], buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> ret, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">read</span>(r io.Reader) (PacketType, []<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	typ, buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">read0</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> PacketUnknown, <span style="color:#000;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">PacketType</span>(typ), buf, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">read0</span>(r io.Reader) (typ <span style="color:#458;font-weight:bold">byte</span>, buf []<span style="color:#458;font-weight:bold">byte</span>, err <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	_, err = r.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	typ = buf[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>	_, err = r.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		err = ErrMsgRead
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	l <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">int</span>(buf[<span style="color:#099">0</span>])<span style="color:#000;font-weight:bold">&lt;&lt;</span><span style="color:#099">8</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#0086b3">int</span>(buf[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>	buf = <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, l)
</span></span><span style="display:flex;"><span>	n, err <span style="color:#000;font-weight:bold">:=</span> io.<span style="color:#900;font-weight:bold">ReadFull</span>(r, buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> n <span style="color:#000;font-weight:bold">!=</span> l {
</span></span><span style="display:flex;"><span>		err = ErrMsgLength
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h4 id="sendrecv">send/recv</h4>
<p><a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proto/msg.go#L16">proto/msg.go#L16</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Send</span>(w io.Writer, msg Msg) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">packet</span>(msg.<span style="color:#900;font-weight:bold">Type</span>(), msg)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	_, err = w.<span style="color:#900;font-weight:bold">Write</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Recv</span>(r io.Reader, msg Msg) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	p, buf, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">read</span>(r)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> p <span style="color:#000;font-weight:bold">!=</span> msg.<span style="color:#900;font-weight:bold">Type</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> ErrInvalidMsg
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>到这里 <code>Message</code> 的序列化和解析已经完成了，之后使用 <code>Msg</code> 或者添加新的 <code>Msg</code> 都不用关注这部分</p>
<h3 id="forward">Forward</h3>
<p>client 部分就是发送 <code>Forward</code> 消息，接收返回的 <code>ForwardResp</code><br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L88">client/serve.go#L88</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (f <span style="color:#000;font-weight:bold">*</span>Forwarder) <span style="color:#900;font-weight:bold">Run</span>() {
</span></span><span style="display:flex;"><span>	rConn, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(f.svraddr, f.token)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(rConn, proto.<span style="color:#900;font-weight:bold">NewMsgForward</span>(f.proxyName, f.subdomain,
</span></span><span style="display:flex;"><span>		f.proxyType, f.remotePort)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Error send forward msg to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	frdResp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgForwardResp{}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Recv</span>(rConn, frdResp); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatal</span>(<span style="color:#d14">&#34;Error reading forward resp msg from remote, please check your config&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> frdResp.Status <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#34;success&#34;</span> {
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;Forward failed, status: %s, remote port: %d&#34;</span>, frdResp.Status, f.remotePort)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>发送后，如果检验成功，Client 端会在 <code>for</code> 循环里接收来自 Server 端的消息</p>
<p><strong>Server 端处理 <code>Forward</code> 消息</strong><br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L83-L107">server/serve.go#L83-L107</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>pt, buf, err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Read</span>(conn)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>	logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading from connection: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">switch</span> pt {
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">case</span> proto.PacketForwardReq:
</span></span><span style="display:flex;"><span>	failChan <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>(<span style="color:#000;font-weight:bold">chan</span> <span style="color:#000;font-weight:bold">struct</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> <span style="color:#0086b3">close</span>(failChan)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">&lt;-</span>failChan
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Send</span>(conn, proto.<span style="color:#900;font-weight:bold">NewMsgForwardResp</span>(<span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;failed&#34;</span>)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error sending forward failed resp message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	msg <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgForwardReq{}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error unmarshalling message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	s.<span style="color:#900;font-weight:bold">handleForward</span>(conn, msg, failChan)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><code>handleForward</code> 函数<br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L133">server/serve.go#L133</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handleForward</span>(cConn net.Conn, msg <span style="color:#000;font-weight:bold">*</span>proto.MsgForwardReq, failChan <span style="color:#000;font-weight:bold">chan</span> <span style="color:#000;font-weight:bold">struct</span>{}) {
</span></span><span style="display:flex;"><span>	uPort <span style="color:#000;font-weight:bold">:=</span> msg.RemotePort
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !s.<span style="color:#900;font-weight:bold">availablePort</span>(uPort) {
</span></span><span style="display:flex;"><span>		failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	from <span style="color:#000;font-weight:bold">:=</span> cConn.<span style="color:#900;font-weight:bold">RemoteAddr</span>().<span style="color:#900;font-weight:bold">String</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>		uListener, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Listen</span>(<span style="color:#d14">&#34;tcp&#34;</span>, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, uPort))
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> uListener.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(cConn, proto.<span style="color:#900;font-weight:bold">NewMsgForwardResp</span>(domain, <span style="color:#d14">&#34;success&#34;</span>)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			failChan <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			userConn, err <span style="color:#000;font-weight:bold">:=</span> uListener.<span style="color:#900;font-weight:bold">Accept</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>				uid <span style="color:#000;font-weight:bold">:=</span> conn.<span style="color:#900;font-weight:bold">NewUuid</span>()
</span></span><span style="display:flex;"><span>				s.tcpConnMap.<span style="color:#900;font-weight:bold">Add</span>(uid, userConn)
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Send</span>(cConn, proto.<span style="color:#900;font-weight:bold">NewMsgExchange</span>(uid, msg.ProxyType)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error sending exchange message: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>大概流程就是：</p>
<ol>
<li>check port available</li>
<li>发送 <code>ForwardResp</code> 消息</li>
<li>创建 <code>uListener</code> 并且等待用户连接</li>
<li>收到用户连接，创建 <code>uuid</code>，发送 <code>Exchange</code> 消息</li>
</ol>
<h3 id="exchange">Exchange</h3>
<p>Client 端从发送 <code>Forward</code> 消息后的 <code>for</code> 里不断获取消息，然后如果是 <code>Exchange</code> 消息<br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/client/serve.go#L124">client/serve.go#L124</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>	p, buf, err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Read</span>(rConn)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		f.logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error reading msg from remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	nlogger <span style="color:#000;font-weight:bold">:=</span> f.logger.<span style="color:#900;font-weight:bold">CloneAdd</span>(p.<span style="color:#900;font-weight:bold">String</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> p {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">case</span> proto.PacketExchange:
</span></span><span style="display:flex;"><span>		msg <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>proto.MsgExchange{}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(buf, msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">cancelForward</span>(f.token, f.svraddr, f.proxyName, f.localPort, f.remotePort)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>				nRconn, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">authDialSvr</span>(f.svraddr, f.token)
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					nlogger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error connecting to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>					<span style="color:#900;font-weight:bold">cancelForward</span>(f.token, f.svraddr, f.proxyName, f.localPort, f.remotePort)
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(nRconn, proto.<span style="color:#900;font-weight:bold">NewMsgExchange</span>(msg.ConnId, f.proxyType)); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					nlogger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Error sending exchange msg to remote: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				lConn, err <span style="color:#000;font-weight:bold">:=</span> net.<span style="color:#900;font-weight:bold">Dial</span>(msg.ProxyType, fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;:%d&#34;</span>, f.localPort))
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					nlogger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Error connecting to local: %v, will close forward, %s:%d&#34;</span>, err, f.proxyType, f.localPort)
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				proxy.<span style="color:#900;font-weight:bold">Stream</span>(lConn, nRconn)
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>这里可以看到逻辑很简单</p>
<ol>
<li>接收到 <code>Exchange</code> 消息后</li>
<li>创建新的 Server 连接</li>
<li>根据 <code>ProxyType</code> 来创建 <code>Local</code> 连接</li>
<li>调用 <code>proxy.Stream</code> 进行流量 <code>Copy</code></li>
</ol>
<p>Server 端接收到 <code>Exchange</code> 消息就很简单了，从 <code>tcpConnMap</code> 里拿出对应的连接，然后同样的 <code>proxy.Stream</code> 进行流量 <code>Copy</code><br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/serve.go#L254">server/serve.go#L254</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>Server) <span style="color:#900;font-weight:bold">handleExchange</span>(conn net.Conn, msg <span style="color:#000;font-weight:bold">*</span>proto.MsgExchange) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">switch</span> msg.ProxyType {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#34;tcp&#34;</span>:
</span></span><span style="display:flex;"><span>		uConn, ok <span style="color:#000;font-weight:bold">:=</span> s.tcpConnMap.<span style="color:#900;font-weight:bold">Get</span>(msg.ConnId)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> !ok {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> s.tcpConnMap.<span style="color:#900;font-weight:bold">Del</span>(msg.ConnId)
</span></span><span style="display:flex;"><span>		proxy.<span style="color:#900;font-weight:bold">Stream</span>(conn, uConn)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="proxystream"><code>proxy.Stream</code></h3>
<p><code>proxy.Stream</code> 就是封装了 <code>io.Copy</code><br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proxy/proxy.go#L7C1-L28C2">proxy.go#L7C1-L28C2</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Stream</span>(s1, s2 io.ReadWriteCloser) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> s1.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> s2.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	copy <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">func</span>(src io.Reader, dst io.Writer) {
</span></span><span style="display:flex;"><span>		buf <span style="color:#000;font-weight:bold">:=</span> bufPool.<span style="color:#900;font-weight:bold">Get</span>().(<span style="color:#000;font-weight:bold">*</span>Buf)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">defer</span> bufPool.<span style="color:#900;font-weight:bold">Put</span>(buf)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			n, err <span style="color:#000;font-weight:bold">:=</span> io.<span style="color:#900;font-weight:bold">CopyBuffer</span>(dst, src, buf.buf)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">==</span> io.EOF <span style="color:#000;font-weight:bold">||</span> n <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#0086b3">copy</span>(s1, s2)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#0086b3">copy</span>(s2, s1)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="conclusion">Conclusion</h3>
<p>到此，<code>Gnar</code> 的实现已经差不多，基本上列出了完整的流程，接下来会写下 <code>Gnar</code> 所实现的 <code>Feature</code></p>
<h2 id="feature">Feature</h2>
<h3 id="auto-https">Auto-Https</h3>
<blockquote>
<p>目标是实现自动 <code>Subdomain</code> 分配并且支持 <code>Https</code></p>
</blockquote>
<p>也就是假设 Server 运行在 <code>example.com</code> 机器，Client 开启转发 <code>Local 3000</code> 到 <code>Server 9000</code> 端口<br>
Server 会生成 <code>xxx.example.com</code> 的 <code>Subdomain</code>，提供 <code>Auto-Https</code>，用户可以通过 <code>https://xxx.example.com</code> 来访问</p>
<blockquote>
<p>这里可以自己通过 Reverse Proxy 来实现 <code>Auto-Https</code><br>
因为不太想过于麻烦的实现 <code>Https</code>，所以借助 <code>Caddy/Nginx</code> 来做 <code>Https</code> 的部分</p>
</blockquote>
<p>这里我使用的 <code>Caddy</code>，借助 <code>Caddy</code> 的 <code>API</code> 功能来实现</p>
<p>需要先启动 <code>Caddy</code> 创建一个 <code>server</code>，这是配置内容，<code>routes</code> 留空就可以</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#000080">&#34;apps&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#000080">&#34;http&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#000080">&#34;servers&#34;</span>: {
</span></span><span style="display:flex;"><span>				<span style="color:#000080">&#34;gnar&#34;</span>: {
</span></span><span style="display:flex;"><span>					<span style="color:#000080">&#34;listen&#34;</span>: [
</span></span><span style="display:flex;"><span>						<span style="color:#d14">&#34;:443&#34;</span>
</span></span><span style="display:flex;"><span>					],
</span></span><span style="display:flex;"><span>					<span style="color:#000080">&#34;routes&#34;</span>: []
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>这是 <code>Gnar</code> 的 <code>Caddy</code> 部分代码<br>
<a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/server/caddy_service.go#L22">server/caddy_service.go#L22</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">var</span> (
</span></span><span style="display:flex;"><span>	caddyAddRouteF         = <span style="color:#d14">&#34;{\&#34;@id\&#34;:\&#34;%s\&#34;,\&#34;match\&#34;:[{\&#34;host\&#34;:[\&#34;%s\&#34;]}],\&#34;handle\&#34;:[{\&#34;handler\&#34;:\&#34;reverse_proxy\&#34;,\&#34;upstreams\&#34;:[{\&#34;dial\&#34;:\&#34;:%d\&#34;}]}]}&#34;</span>
</span></span><span style="display:flex;"><span>	caddyAddRouteUrl       = <span style="color:#d14">&#34;http://127.0.0.1:2019/config/apps/http/servers/gnar/routes&#34;</span>
</span></span><span style="display:flex;"><span>	caddyAddTlsSubjectsUrl = <span style="color:#d14">&#34;http://127.0.0.1:2019/config/apps/tls/automation/policies/0/subjects&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">addCaddyRouter</span>(host <span style="color:#458;font-weight:bold">string</span>, port <span style="color:#458;font-weight:bold">int</span>) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	tunnelId <span style="color:#000;font-weight:bold">:=</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%s.%d&#34;</span>, host, port)
</span></span><span style="display:flex;"><span>	resp, err <span style="color:#000;font-weight:bold">:=</span> http.<span style="color:#900;font-weight:bold">Post</span>(caddyAddRouteUrl, <span style="color:#d14">&#34;application/json&#34;</span>, bytes.<span style="color:#900;font-weight:bold">NewBuffer</span>([]<span style="color:#0086b3">byte</span>(fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(caddyAddRouteF, tunnelId, host, port))))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Tunnel creation failed, err: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> resp.Body.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	resp, err = http.<span style="color:#900;font-weight:bold">Post</span>(caddyAddTlsSubjectsUrl, <span style="color:#d14">&#34;application/json&#34;</span>, bytes.<span style="color:#900;font-weight:bold">NewBuffer</span>([]<span style="color:#0086b3">byte</span>(fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;\&#34;%s\&#34;&#34;</span>, host))))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		logger.<span style="color:#900;font-weight:bold">Errorf</span>(<span style="color:#d14">&#34;Tunnel creation failed, err: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">defer</span> resp.Body.<span style="color:#900;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>	logger.<span style="color:#900;font-weight:bold">Infof</span>(<span style="color:#d14">&#34;Tunnel created successfully, id: %s, host: %s&#34;</span>, tunnelId, cr.<span style="color:#900;font-weight:bold">PWhiteUnderline</span>(host))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>前置准备：</p>
<ol>
<li>要先设置好域名 <code>DNS</code> 解析，要设置两条记录 <code>A *.example.com &lt;your server ip&gt;</code> 和 <code>A example.com &lt;your server ip&gt;</code></li>
<li>运行 <code>Caddy</code>（如果是 <code>Cloudflare DNS</code> 还需要自己编译支持 <code>Cloudflare DNS plugin</code> 的 <code>Caddy</code> 版本，以及配置里填写 <code>Cloudflare KEY</code>，具体流程如有需要网上找下应该可以找到）</li>
<li>Server 端带上支持 <code>Subdomain</code> 的参数，可以看项目 <code>README.md</code></li>
</ol>
<h3 id="deploy-at-flyio">Deploy at <code>fly.io</code></h3>
<p><strong>这里很重要的一点是，只能部署 1 个 Service</strong></p>
<blockquote>
<p>部署多个不行吗？<br>
不行，因为部署多个，<code>fly</code> 会做 <code>Load Balancing</code>，而 client 只连接到了 1 台机器上，导致部分用户请求，因为没在 <code>tcpConnMap</code> 里，就没法 <code>Copy</code> 成功<br>
如何实现部署多个 <code>Server</code> 呢?<br>
<code>frp issue</code> 里有类似问题，可以看 <a href="https://github.com/fatedier/frp/issues/1482">frp - How to use load balancing</a></p>
</blockquote>
<p>因为 <code>fly.io</code> 支持 <code>Dockerfile</code>，所以只用简单的写个 <code>Dockerfile</code> 即可<br>
关键是 <code>fly.toml</code></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>app = <span style="color:#d14">&#34;xxxx&#34;</span>
</span></span><span style="display:flex;"><span>primary_region = <span style="color:#d14">&#34;hkg&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[build]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Control</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">8910</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">8910</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Admin</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">8911</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;tls&#34;</span>, <span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">443</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Forward TCP</span>
</span></span><span style="display:flex;"><span>[[services]]
</span></span><span style="display:flex;"><span>  internal_port = <span style="color:#099">9000</span>
</span></span><span style="display:flex;"><span>  protocol = <span style="color:#d14">&#34;tcp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  [[services.ports]]
</span></span><span style="display:flex;"><span>    handlers = [<span style="color:#d14">&#34;tls&#34;</span>, <span style="color:#d14">&#34;http&#34;</span>]
</span></span><span style="display:flex;"><span>    port = <span style="color:#099">9000</span>
</span></span></code></pre><p><code>Control</code> 和 <code>Admin</code> 因为都是 <code>TCP</code>，所以 <code>protocol</code> 是 <code>tcp</code>，然后 <code>Admin</code> 希望直接从 <a href="https://xxxx.fly.dev/">https://xxxx.fly.dev/</a> 访问，就需要加上 <code>handlers = [&quot;http&quot;]</code> 以及 <code>https</code> 的 <code>handlers = [&quot;tls&quot;, &quot;http&quot;]</code></p>
<p>然后这里需要在配置里指定出 <code>Forward</code> 的端口，这样运行 Server 和 Client 后<br>
访问 <a href="https://xxxx.fly.dev:9000">https://xxxx.fly.dev:9000</a> 就会访问到 Client <code>Local 3000</code> 了</p>
<blockquote>
<p><code>UDP</code> 的配置，<code>fly.io</code> 也是支持的，可以看 <code>fly</code> 的文档，或者可以看这个例子 <a href="https://github.com/AnimMouse/frp-flyapp">AnimMouse/frp-flyapp</a></p>
</blockquote>
<h3 id="udp"><code>UDP</code></h3>
<p><code>UDP</code> 的支持，因为 <code>UDP</code> 没有连接的概念，只有 <code>Packet</code> 概念，所以我们可以封装 <code>UDP</code> 流量作为一个消息 <code>MsgUDPDatagram</code>，然后做流量的 <code>Copy</code>（实际上就是 <code>Readloop</code> 和 <code>Writeloop</code>），如下</p>
<p><a href="https://github.com/abcdlsj/gnar/blob/484084da8b9edb99fb39e5d7561cc94d16d7031c/proxy/udp.go#L1-L77">proxy/udp.go#L1-L77</a></p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">UDPClientStream</span>(token <span style="color:#458;font-weight:bold">string</span>, tcp, udp io.ReadWriteCloser) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> proto.MsgUDPDatagram{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(tcp, <span style="color:#000;font-weight:bold">&amp;</span>msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			n, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">Write</span>(msg.Payload)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> n <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">len</span>(msg.Payload) {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		buf <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">4096</span>)
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">Read</span>(buf)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(tcp, proto.<span style="color:#900;font-weight:bold">NewMsgUDPDatagram</span>(<span style="color:#000;font-weight:bold">nil</span>, buf[:n])); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">UDPDatagram</span>(token <span style="color:#458;font-weight:bold">string</span>, tcp io.ReadWriteCloser, udp <span style="color:#000;font-weight:bold">*</span>net.UDPConn) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		buf <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#458;font-weight:bold">byte</span>, <span style="color:#099">4096</span>)
</span></span><span style="display:flex;"><span>		n, addr, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">ReadFromUDP</span>(buf)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err = proto.<span style="color:#900;font-weight:bold">Send</span>(tcp, proto.<span style="color:#900;font-weight:bold">NewMsgUDPDatagram</span>(addr, buf[:n])); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">go</span> <span style="color:#000;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			msg <span style="color:#000;font-weight:bold">:=</span> proto.MsgUDPDatagram{}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> proto.<span style="color:#900;font-weight:bold">Recv</span>(tcp, <span style="color:#000;font-weight:bold">&amp;</span>msg); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			_, err <span style="color:#000;font-weight:bold">:=</span> udp.<span style="color:#900;font-weight:bold">WriteTo</span>(msg.Payload, addr)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>相当于 <code>TCP</code> 转发里的 <code>proxy.Stream</code> 替代</p>
<h3 id="speed-limit">Speed limit</h3>
<p>得益于 <code>io.Reader</code> 和 <code>io.Writer</code> 接口，以及 <code>rate</code> 包，实现限速其实也很简单</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> LimitStream <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	rw       io.ReadWriteCloser
</span></span><span style="display:flex;"><span>	ctx      context.Context
</span></span><span style="display:flex;"><span>	wlimiter <span style="color:#000;font-weight:bold">*</span>rate.Limiter
</span></span><span style="display:flex;"><span>	rlimiter <span style="color:#000;font-weight:bold">*</span>rate.Limiter
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">NewLimitStream</span>(rw io.ReadWriteCloser, limit <span style="color:#458;font-weight:bold">int</span>) <span style="color:#000;font-weight:bold">*</span>LimitStream {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">&amp;</span>LimitStream{
</span></span><span style="display:flex;"><span>		rw:       rw,
</span></span><span style="display:flex;"><span>		ctx:      context.<span style="color:#900;font-weight:bold">Background</span>(),
</span></span><span style="display:flex;"><span>		wlimiter: rate.<span style="color:#900;font-weight:bold">NewLimiter</span>(rate.<span style="color:#900;font-weight:bold">Limit</span>(limit), limit), <span style="color:#998;font-style:italic">// set burst = limit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		rlimiter: rate.<span style="color:#900;font-weight:bold">NewLimiter</span>(rate.<span style="color:#900;font-weight:bold">Limit</span>(limit), limit), <span style="color:#998;font-style:italic">// set burst = limit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>LimitStream) <span style="color:#900;font-weight:bold">Read</span>(p []<span style="color:#458;font-weight:bold">byte</span>) (<span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> s.rlimiter <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> s.rw.<span style="color:#900;font-weight:bold">Read</span>(p)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	do <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">func</span>(r <span style="color:#000;font-weight:bold">*</span>LimitStream, p []<span style="color:#458;font-weight:bold">byte</span>) (<span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> r.rw.<span style="color:#900;font-weight:bold">Read</span>(p)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> n, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">:=</span> r.rlimiter.<span style="color:#900;font-weight:bold">WaitN</span>(r.ctx, n); err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> n, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> n, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(p) &lt; s.rlimiter.<span style="color:#900;font-weight:bold">Burst</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">do</span>(s, p)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	burst <span style="color:#000;font-weight:bold">:=</span> s.rlimiter.<span style="color:#900;font-weight:bold">Burst</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> read <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#099">0</span>; i &lt; <span style="color:#0086b3">len</span>(p); i <span style="color:#000;font-weight:bold">+=</span> burst {
</span></span><span style="display:flex;"><span>		end <span style="color:#000;font-weight:bold">:=</span> i <span style="color:#000;font-weight:bold">+</span> burst
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> end &gt; <span style="color:#0086b3">len</span>(p) {
</span></span><span style="display:flex;"><span>			end = <span style="color:#0086b3">len</span>(p)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		n, err <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">do</span>(s, p[i:end])
</span></span><span style="display:flex;"><span>		read <span style="color:#000;font-weight:bold">+=</span> n
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> read, err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> read, <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>原理就是，假如说我们想要限速到 <code>10k/s</code>，那么就初始化 <code>burst=10k</code> 的 <code>rate.Limiter</code><br>
<code>Read</code> 的时候，调用 <code>WaitN</code>，因为容量为 <code>10k</code>，所以 <code>WaitN</code> 每读取 <code>10k byte</code> 就会等待 <code>1s</code><br>
这样就实现了 <code>10k/s</code> 的限速，而且使用上非常简单，初始化一个 <code>LimitStream</code> 就可以了</p>
<h2 id="conclusion-1">Conclusion</h2>
<p>写了下如何实现一个内网转发的小工具，代码本身还有很多可以优化的地方，比如</p>
<ol>
<li>完善「错误处理」「重试」，对于哪些错误需要重试，哪些错误直接退出</li>
<li>支持更多转发协议，例如 <code>HTTP/Quic/WebSocket</code>，<code>Control</code> 协议也可以支持更多，目前是 <code>TCP</code>，可以支持 <code>UDP/KCP</code> 等</li>
<li>完善监控采集，这部分可以用 <code>Prometheus</code>，但是对于小项目来说太麻烦了</li>
<li><code>Serverside Load-Balancing</code> 这部分一直在思考如何做，从上边 <code>fly.io</code> 的部署就能知道，<code>Server</code> 端访问只能是单机的</li>
</ol>
<p>最后，感谢阅读！</p>
<h2 id="refs">refs</h2>
<p><a href="https://pandaychen.github.io/2020/01/01/MAGIC-GO-IO-PACKAGE/">https://pandaychen.github.io/2020/01/01/MAGIC-GO-IO-PACKAGE/</a><br>
<a href="https://github.com/ekzhang/bore">https://github.com/ekzhang/bore</a><br>
<a href="https://github.com/rapiz1/rathole">https://github.com/rapiz1/rathole</a><br>
<a href="https://github.com/AnimMouse/frp-flyapp">https://github.com/AnimMouse/frp-flyapp</a></p>
</article>
      </div>
      <hr class="divider" />
      <!-- 
<footer class="footer">
  <p class="footer-author">
    Author <a href="https://github.com/abcdlsj">abcdlsj</a>
  </p>
  <p class="footer-proj">
    Source
    <a href="https://github.com/abcdlsj/abcdlsj.github.io">abcdlsj.github.io</a>
  </p>
</footer>
 -->
    </main>
  </body>
</html>

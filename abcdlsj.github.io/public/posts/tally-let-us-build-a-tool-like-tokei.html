
<!DOCTYPE html>
<html lang="en">
  <head>
    
<meta charset="UTF-8" />
<title>Tally - Build a tool like tokei/scc</title>
<meta name="description" content="Enjoy Focus!" />

<meta name="keywords" content="Line Counter,Optimization,">
<meta name="author" content="abcdlsj">
<meta property="og:title" content="Tally - Build a tool like tokei/scc">
<meta property="og:description" content="Building a high-performance code statistics tool from scratch: Deep dive into the implementation principles of tokei/scc, sharing the complete development journey of file traversal, line counting, and performance optimization.">
<meta property="og:url" content="https://abcdlsj.github.io/posts/tally-let-us-build-a-tool-like-tokei.html">
<meta property="og:type" content="article">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="stylesheet" href="/static/style.css" />
<script>
  // Theme initialization - runs before page render to prevent flash
  (function() {
    const theme = localStorage.getItem('theme');
    if (theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }
  })();
</script>
<script defer src="https://us.umami.is/script.js" data-website-id="5af61252-79b1-48a0-a452-fdeefbf6a3ee"></script>
<script src="/static/script/search.js"></script>

  </head>
  <body>
    <div class="app">
      
<header class="site-header">
  <div class="site-header__inner">
    <div class="site-header__brand">
      <a href="/" class="site-header__title">Tally - Build a tool like tokei/scc</a>
      <span class="site-header__tagline">Enjoy Focus!</span>
    </div>
    <nav class="site-header__nav">
      <ul class="nav-links">
        
        
        <li>
          <a href="/" class="nav-link">Home</a>
        </li>
        
        
        
        <li>
          <a href="/posts" class="nav-link">Posts</a>
        </li>
        
        
        
        <li>
          <a href="/about" class="nav-link">About</a>
        </li>
        
        
        
        
        
        <li>
          <a href="/rss.xml" class="nav-link">Feed</a>
        </li>
        
        
      </ul>
      <button class="theme-toggle" type="button" aria-label="Toggle theme" onclick="toggleTheme()">
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
    </nav>
  </div>
</header>
<script>
  function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    let newTheme;
    if (currentTheme === 'dark') {
      newTheme = 'light';
    } else if (currentTheme === 'light') {
      newTheme = 'dark';
    } else {
      // No explicit theme set, toggle based on system preference
      newTheme = prefersDark ? 'light' : 'dark';
    }
    
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  }
</script>

      <main class="container">
        <div class="post-layout post-layout--with-toc">
          <article class="post-article">
            <!-- Post Header -->
            <header class="post-header">
              
              <h1 class="post-title">Tally - Build a tool like tokei/scc</h1>
              <div class="post-meta">
                <time class="post-date" datetime="2023-08-16T18:47:37+08:00">2023-08-16</time>
                
                <div class="post-tags">
                  
                  <a href="/tags/line+counter.html" class="tag">#Line Counter</a>
                  
                  <a href="/tags/optimization.html" class="tag">#Optimization</a>
                  
                </div>
                
              </div>
            </header>

            
            <details class="changelog">
              <summary>Changelog</summary>
              <div class="changelog-content">- 2023-08-16: first version<br>- 2024-04-03: bechmark refactor<br></div>
            </details>
            

            <!-- Post Content -->
            <div class="post-body">
              <h2 id="background">Background</h2>
<p>I want to build a tool like <code>scc</code>, <code>tokei</code>, just for learning. It was very easy to write a simple version: <a href="https://github.com/abcdlsj/share/blob/7ac6cbbf36a9d72b09603b160569db5f5a27fa81/go/tally/main.go">tally - first commit</a>.<br>
I will to optimize it at the second half of this post.</p>
<p>First, allow me to explain it to you.</p>
<h2 id="steps">Steps</h2>
<p>The counting-line machine worked similar to the <code>Putting elephants in the freezer</code>, so the steps are:</p>
<ol>
<li>Walk directory tree.</li>
<li>Read file and Count lines.</li>
<li>Output result.</li>
</ol>
<h3 id="walk-directory">Walk directory</h3>
<p>Use <code>filepath.Walk</code> to walk directory tree, it's very easy to use.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>filepath.<span style="color:#900;font-weight:bold">Walk</span>(os.Args[<span style="color:#099">1</span>], <span style="color:#000;font-weight:bold">func</span>(path <span style="color:#458;font-weight:bold">string</span>, info os.FileInfo, err <span style="color:#458;font-weight:bold">error</span>) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#0086b3">panic</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> info.<span style="color:#900;font-weight:bold">IsDir</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#900;font-weight:bold">countLine</span>(path)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre><h3 id="read-and-count"><code>Read</code> and <code>Count</code></h3>
<p>Count line we need to know what is a line. A line is a string end with <code>\n</code> or <code>\r\n</code>. So we can just split the file content with <code>\n</code> or <code>\r\n</code> to get the lines.</p>
<p>Because we need to count the code lines, so we need to ignore the comment lines. I just use a simple way to ignore the comment lines, just ignore the line start with a rule string(<strong>by the way: the first version I just conside the single line comment.</strong>).</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> Counter <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	idx     <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	lang    <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	comment <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	exts    []<span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">var</span> (
</span></span><span style="display:flex;"><span>	Go       = Counter{<span style="color:#099">1</span>, <span style="color:#d14">&#34;Go&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.go&#34;</span>)}
</span></span><span style="display:flex;"><span>	Rust     = Counter{<span style="color:#099">2</span>, <span style="color:#d14">&#34;Rust&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.rs&#34;</span>)}
</span></span><span style="display:flex;"><span>	Java     = Counter{<span style="color:#099">3</span>, <span style="color:#d14">&#34;Java&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.java&#34;</span>)}
</span></span><span style="display:flex;"><span>	Python   = Counter{<span style="color:#099">4</span>, <span style="color:#d14">&#34;Python&#34;</span>, <span style="color:#d14">&#34;#&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.py&#34;</span>)}
</span></span><span style="display:flex;"><span>	C        = Counter{<span style="color:#099">5</span>, <span style="color:#d14">&#34;C&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.c&#34;</span>, <span style="color:#d14">&#34;.h&#34;</span>)}
</span></span><span style="display:flex;"><span>	Cpp      = Counter{<span style="color:#099">6</span>, <span style="color:#d14">&#34;C++&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.cpp&#34;</span>, <span style="color:#d14">&#34;.hpp&#34;</span>)}
</span></span><span style="display:flex;"><span>	Js       = Counter{<span style="color:#099">7</span>, <span style="color:#d14">&#34;Javascript&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.js&#34;</span>)}
</span></span><span style="display:flex;"><span>	Ts       = Counter{<span style="color:#099">8</span>, <span style="color:#d14">&#34;Typescript&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.ts&#34;</span>)}
</span></span><span style="display:flex;"><span>	HTML     = Counter{<span style="color:#099">9</span>, <span style="color:#d14">&#34;HTML&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.html&#34;</span>, <span style="color:#d14">&#34;.htm&#34;</span>)}
</span></span><span style="display:flex;"><span>	JSON     = Counter{<span style="color:#099">10</span>, <span style="color:#d14">&#34;JSON&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.json&#34;</span>)}
</span></span><span style="display:flex;"><span>	Protobuf = Counter{<span style="color:#099">11</span>, <span style="color:#d14">&#34;Protobuf&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.proto&#34;</span>)}
</span></span><span style="display:flex;"><span>	Markdown = Counter{<span style="color:#099">12</span>, <span style="color:#d14">&#34;Markdown&#34;</span>, <span style="color:#d14">&#34;//&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.md&#34;</span>)}
</span></span><span style="display:flex;"><span>	Shell    = Counter{<span style="color:#099">13</span>, <span style="color:#d14">&#34;Shell&#34;</span>, <span style="color:#d14">&#34;#&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.sh&#34;</span>)}
</span></span><span style="display:flex;"><span>	YAML     = Counter{<span style="color:#099">14</span>, <span style="color:#d14">&#34;YAML&#34;</span>, <span style="color:#d14">&#34;#&#34;</span>, <span style="color:#900;font-weight:bold">vec</span>(<span style="color:#d14">&#34;.yaml&#34;</span>, <span style="color:#d14">&#34;.yml&#34;</span>)}
</span></span><span style="display:flex;"><span>)
</span></span></code></pre><blockquote>
<p>vec is a function to create a slice. (Nostalgia for <code>Rust</code> <code>vec!</code> :p)</p>
</blockquote>
<p>Count line logic:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">countLine</span>(path <span style="color:#458;font-weight:bold">string</span>) <span style="color:#458;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	data, err <span style="color:#000;font-weight:bold">:=</span> os.<span style="color:#900;font-weight:bold">ReadFile</span>(path)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">guessLang</span>(path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> c.lang <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	lines <span style="color:#000;font-weight:bold">:=</span> bytes.<span style="color:#900;font-weight:bold">Split</span>(data, []<span style="color:#0086b3">byte</span>(<span style="color:#d14">&#34;\n&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	item <span style="color:#000;font-weight:bold">:=</span> Item{
</span></span><span style="display:flex;"><span>		lang:  c.lang,
</span></span><span style="display:flex;"><span>		lines: <span style="color:#0086b3">len</span>(lines),
</span></span><span style="display:flex;"><span>		files: <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> _, line <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">range</span> lines {
</span></span><span style="display:flex;"><span>		line <span style="color:#000;font-weight:bold">:=</span> bytes.<span style="color:#900;font-weight:bold">TrimSpace</span>(line)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(line) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			item.blank<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> c.<span style="color:#900;font-weight:bold">isComment</span>(line) {
</span></span><span style="display:flex;"><span>			item.comment<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		item.code<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	result.<span style="color:#900;font-weight:bold">Add</span>(c, item)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="output-style">Output style</h3>
<p>Actually, this is the most hard part. you need to output the result intuitively. thanks to <code>tokei</code> and <code>scc</code>, I just need to do a <code>copy</code> the output format from them :smile:.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (r <span style="color:#000;font-weight:bold">*</span>Result) <span style="color:#900;font-weight:bold">String</span>() {
</span></span><span style="display:flex;"><span>	itemF <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">&#34;%-10s %10d %10d %10d %10d %10d\n&#34;</span>
</span></span><span style="display:flex;"><span>	headerF <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">&#34;%-10s %10s %10s %10s %10s %10s\n&#34;</span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(headerF, <span style="color:#d14">&#34;Language&#34;</span>, <span style="color:#d14">&#34;Files&#34;</span>, <span style="color:#d14">&#34;Lines&#34;</span>, <span style="color:#d14">&#34;Code&#34;</span>, <span style="color:#d14">&#34;Comments&#34;</span>, <span style="color:#d14">&#34;Blanks&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> total Item
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sort.<span style="color:#900;font-weight:bold">Slice</span>(r.data, <span style="color:#000;font-weight:bold">func</span>(i, j <span style="color:#458;font-weight:bold">int</span>) <span style="color:#458;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> r.data[i].lines &gt; r.data[j].lines
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> _, item <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">range</span> r.data {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> item.files <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		total = <span style="color:#900;font-weight:bold">mergeItem</span>(total, item)
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#900;font-weight:bold">Printf</span>(itemF, item.lang, item.files, item.lines, item.code, item.comment, item.blank)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(itemF, <span style="color:#d14">&#34;Total&#34;</span>, total.files, total.lines, total.code, total.comment, total.blank)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#900;font-weight:bold">Printf</span>(strings.<span style="color:#900;font-weight:bold">Repeat</span>(<span style="color:#d14">&#34;━&#34;</span>, <span style="color:#099">65</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Let's Test it.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>tally .
</span></span></code></pre><pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span><span style="display:flex;"><span>Language        Files      Lines       Code   Comments     Blanks
</span></span><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span><span style="display:flex;"><span>Go                  1        242        199          0         43
</span></span><span style="display:flex;"><span>Markdown            1          3          2          0          1
</span></span><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span><span style="display:flex;"><span>Total               2        245        201          0         44
</span></span><span style="display:flex;"><span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></span></code></pre><p>It's looks very good :)</p>
<p>At next, I will benchmark and optimize it.</p>
<h2 id="benchmark">Benchmark</h2>
<p>use <code>time</code> for benchmarks is not accurate enough.</p>
<blockquote>
<p><a href="https://stackoverflow.com/questions/9006596/is-the-unix-time-command-accurate-enough-for-benchmarks">stackoverflow - Is the UNIX <code>time</code> command accurate enough for benchmarks? [closed]</a></p>
</blockquote>
<blockquote>
<p>TLDR: Can use <code>perf stat</code> to benchmarks<br>
<code>perf stat -r 10 -d &lt;CMD&gt;</code></p>
</blockquote>
<p>There are also many of powerful tools for benchmarks.</p>
<p>I use <code>hyperfine</code> for benchmarks at my <code>MacBook Pro 16 (2019)</code> machine.</p>
<blockquote>
<p><a href="https://github.com/sharkdp/hyperfine">hyperfine - Command-line benchmarking tool</a></p>
</blockquote>
<p><code>hyperfine</code> support warmup file system to reduce noise, and it can compare multiple commands and export to markdown. (very nice! :smile:)</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>hyperfine <span style="color:#d14">&#39;tokei .&#39;</span> <span style="color:#d14">&#39;scc .&#39;</span> <span style="color:#d14">&#39;tally .&#39;</span> --warmup <span style="color:#099">3</span> --export-markdown bench.md
</span></span></code></pre><h3 id="small-repo">Small repo</h3>
<p>I use the repo <a href="https://github.com/firecracker-microvm/firecracker">https://github.com/firecracker-microvm/firecracker</a> to do the benchmarks</p>
<p>Results:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:right">Mean [ms]</th>
<th style="text-align:right">Min [ms]</th>
<th style="text-align:right">Max [ms]</th>
<th style="text-align:right">Relative</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>tokei .</code></td>
<td style="text-align:right">36.2 ± 6.3</td>
<td style="text-align:right">25.0</td>
<td style="text-align:right">56.5</td>
<td style="text-align:right">1.00</td>
</tr>
<tr>
<td style="text-align:left"><code>scc .</code></td>
<td style="text-align:right">41.0 ± 7.7</td>
<td style="text-align:right">28.0</td>
<td style="text-align:right">58.9</td>
<td style="text-align:right">1.13 ± 0.29</td>
</tr>
<tr>
<td style="text-align:left"><code>tally .</code></td>
<td style="text-align:right">114.4 ± 4.8</td>
<td style="text-align:right">108.5</td>
<td style="text-align:right">123.6</td>
<td style="text-align:right">3.16 ± 0.57</td>
</tr>
</tbody>
</table>
<p>We can see, the origin version is not fast enough. but I thought it's already usable.</p>
<p>Let's see large repo.</p>
<h3 id="large-repo">Large repo</h3>
<p>Use <a href="https://github.com/moby/moby">https://github.com/moby/moby</a></p>
<p>Results:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:right">Mean [ms]</th>
<th style="text-align:right">Min [ms]</th>
<th style="text-align:right">Max [ms]</th>
<th style="text-align:right">Relative</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>tokei .</code></td>
<td style="text-align:right">447.5 ± 60.5</td>
<td style="text-align:right">385.4</td>
<td style="text-align:right">541.4</td>
<td style="text-align:right">1.30 ± 0.21</td>
</tr>
<tr>
<td style="text-align:left"><code>scc .</code></td>
<td style="text-align:right">343.7 ± 29.4</td>
<td style="text-align:right">296.0</td>
<td style="text-align:right">399.3</td>
<td style="text-align:right">1.00</td>
</tr>
<tr>
<td style="text-align:left"><code>tally .</code></td>
<td style="text-align:right">1038.1 ± 77.2</td>
<td style="text-align:right">947.3</td>
<td style="text-align:right">1173.8</td>
<td style="text-align:right">3.02 ± 0.34</td>
</tr>
</tbody>
</table>
<p>Okay, seems there had a relatively large gap between <code>tokei/scc</code> and <code>tally</code>.</p>
<h2 id="optimize1---improve-the-code">Optimize1 - Improve the code</h2>
<p>My first version is very simple and it's just support inline comments, and use <code>split</code> to count lines.</p>
<p>There have two optimal point:</p>
<ol>
<li>Use <code>Bufio.Scanner</code> to readline</li>
<li>Support multiple comments</li>
</ol>
<p>For these two, can see the commits <a href="https://github.com/abcdlsj/share/commits/master/go/tally">https://github.com/abcdlsj/share/commits/master/go/tally</a></p>
<p>There's nothing to say here.</p>
<h3 id="compare">Compare</h3>
<ul>
<li>Small repo</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:right">Mean [ms]</th>
<th style="text-align:right">Min [ms]</th>
<th style="text-align:right">Max [ms]</th>
<th style="text-align:right">Relative</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>tally .</code></td>
<td style="text-align:right">70.2 ± 5.9</td>
<td style="text-align:right">56.4</td>
<td style="text-align:right">86.1</td>
<td style="text-align:right">1.00</td>
</tr>
<tr>
<td style="text-align:left"><code>tally1 .</code></td>
<td style="text-align:right">119.9 ± 11.3</td>
<td style="text-align:right">108.5</td>
<td style="text-align:right">151.2</td>
<td style="text-align:right">1.71 ± 0.22</td>
</tr>
</tbody>
</table>
<ul>
<li>Large repo</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:right">Mean [s]</th>
<th style="text-align:right">Min [s]</th>
<th style="text-align:right">Max [s]</th>
<th style="text-align:right">Relative</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>tally .</code></td>
<td style="text-align:right">1.073 ± 0.129</td>
<td style="text-align:right">0.892</td>
<td style="text-align:right">1.295</td>
<td style="text-align:right">1.00</td>
</tr>
<tr>
<td style="text-align:left"><code>tally1 .</code></td>
<td style="text-align:right">1.113 ± 0.139</td>
<td style="text-align:right">0.928</td>
<td style="text-align:right">1.277</td>
<td style="text-align:right">1.04 ± 0.18</td>
</tr>
</tbody>
</table>
<p>We can see, for the small repo the gap is smaller. use <code>bufio.Scanner</code> is very effective. but for large repo, it seems not very effective.</p>
<h2 id="optimize2---faster-filepath-walking">Optimize2 - Faster filepath walking</h2>
<p>Based on this post <a href="https://engineering.kablamo.com.au/posts/2021/quick-comparison-between-go-file-walk-implementations/">You Don't Need a Library for File Walking in Go</a>, the result shows the <code>offical filepath walk</code> are faster enough. And I want to build <code>tally</code> without any <code>third-party dependencies</code>, so I won't use other faster <code>walkdir</code> library.</p>
<p>Currently, I use the <code>filepath.Walk</code> to <code>walking</code> dir, use <code>filepth.Walkdir</code> will be faster a little.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>&gt; hyperfine <span style="color:#d14">&#39;tally .&#39;</span> <span style="color:#d14">&#39;tally_walkdir .&#39;</span> --warmup <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>Benchmark 1: tally .
</span></span><span style="display:flex;"><span>  Time <span style="color:#000;font-weight:bold">(</span>mean ± σ<span style="color:#000;font-weight:bold">)</span>:      66.4 ms ±   6.6 ms    <span style="color:#000;font-weight:bold">[</span>User: 21.8 ms, System: 43.0 ms<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  Range <span style="color:#000;font-weight:bold">(</span>min … max<span style="color:#000;font-weight:bold">)</span>:    58.0 ms …  82.8 ms    <span style="color:#099">37</span> runs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Benchmark 2: tally_walkdir .
</span></span><span style="display:flex;"><span>  Time <span style="color:#000;font-weight:bold">(</span>mean ± σ<span style="color:#000;font-weight:bold">)</span>:      62.8 ms ±   8.1 ms    <span style="color:#000;font-weight:bold">[</span>User: 21.5 ms, System: 39.1 ms<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  Range <span style="color:#000;font-weight:bold">(</span>min … max<span style="color:#000;font-weight:bold">)</span>:    51.8 ms …  89.9 ms    <span style="color:#099">43</span> runs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Summary
</span></span><span style="display:flex;"><span>  tally_walkdir . ran
</span></span><span style="display:flex;"><span>    1.06 ± 0.17 <span style="color:#0086b3">times</span> faster than tally .
</span></span></code></pre><p>(Just a small improvement, So I won't commit the change.)</p>
<h2 id="optimize3---parallelism">Optimize3 - Parallelism</h2>
<h3 id="fanout">Fanout</h3>
<p><code>Go</code> supports concurrency perfectly, we can use the parttern named <code>Fanout</code> to <code>allocate</code> file to <code>worker</code>.</p>
<p>We follow there steps:</p>
<ol>
<li>Passing variables via <code>channel</code></li>
<li><code>Walk</code> dir will send files firstly to <code>channel</code></li>
<li>Use multiple <code>worker</code> to <code>read</code> files from <code>channel</code></li>
<li>Use <code>sync.WaitGroup</code> to <code>wait</code> for <code>worker</code> done</li>
<li>Use <code>mutex</code> to <code>lock</code> the <code>result</code> data</li>
</ol>
<p>These are changes:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999">diff --git a/go/tally/main.go b/go/tally/main.go
</span></span></span><span style="display:flex;"><span><span style="color:#999">index f184b31..23f5fae 100644
</span></span></span><span style="display:flex;"><span><span style="color:#999"></span><span style="color:#000;background-color:#fdd">--- a/go/tally/main.go
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+++ b/go/tally/main.go
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span><span style="color:#aaa">@@ -6,8 +6,10 @@ import (
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span> 	&#34;fmt&#34;
</span></span><span style="display:flex;"><span> 	&#34;os&#34;
</span></span><span style="display:flex;"><span> 	&#34;path/filepath&#34;
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	&#34;runtime&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	&#34;sort&#34;
</span></span><span style="display:flex;"><span> 	&#34;strings&#34;
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	&#34;sync&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> )
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> type Counter struct {
</span></span><span style="display:flex;"><span><span style="color:#aaa">@@ -48,18 +50,29 @@ func init() {
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span> 		}
</span></span><span style="display:flex;"><span> 	}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-	result = NewResult()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+	result = &amp;Result{
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		data: make([]Item, registedNum),
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> var result *Result
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-func main() {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-	if len(os.Args) &lt; 2 {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-		fmt.Println(&#34;Usage: tally &lt;path&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-		os.Exit(1)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+var fileChan = make(chan string, 100)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+func process(dir string) {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	var wg sync.WaitGroup
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	wg.Add(runtime.NumCPU() * 2)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	for i := 0; i &lt; runtime.NumCPU()*2; i++ {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		go func() {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			defer wg.Done()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			for file := range fileChan {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+				countLine(file)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+			}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		}()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-	filepath.Walk(os.Args[1], func(path string, info os.FileInfo, err error) error {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+	filepath.Walk(dir, func(path string, info os.FileInfo, err error) error {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 		if err != nil {
</span></span><span style="display:flex;"><span> 			panic(err)
</span></span><span style="display:flex;"><span> 		}
</span></span><span style="display:flex;"><span><span style="color:#aaa">@@ -68,9 +81,24 @@ func main() {
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span> 			return nil
</span></span><span style="display:flex;"><span> 		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-		return countLine(path)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+		fileChan &lt;- path
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		return nil
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	})
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	close(fileChan)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	wg.Wait()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+func main() {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	if len(os.Args) &lt; 2 {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		fmt.Println(&#34;Usage: tally &lt;path&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+		os.Exit(1)
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	process(os.Args[1])
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	result.String()
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#aaa">@@ -95,16 +123,13 @@ func mergeItem(a, b Item) Item {
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> type Result struct {
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	mu   sync.Mutex
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	data []Item
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-func NewResult() *Result {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-	return &amp;Result{
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-		data: make([]Item, registedNum),
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-	}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-}
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span> func (r *Result) Add(c Counter, item Item) {
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	r.mu.Lock()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+	defer r.mu.Unlock()
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	r.data[c.idx-1] = mergeItem(r.data[c.idx-1], item)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#aaa">@@ -174,6 +199,7 @@ func guessLang(file string) Counter {
</span></span></span><span style="display:flex;"><span><span style="color:#aaa"></span> func countLine(path string) error {
</span></span><span style="display:flex;"><span> 	f, err := os.Open(path)
</span></span><span style="display:flex;"><span> 	scanner := bufio.NewScanner(f)
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span> 	if err != nil {
</span></span><span style="display:flex;"><span> 		return err
</span></span><span style="display:flex;"><span> 	}
</span></span></code></pre><p>The <code>fileChan</code> size is 100, the worker number is 2 * <code>CPU number</code>. I don't do much test here.</p>
<p>According common knowledge:</p>
<ul>
<li>CPU-bound task, the number of workers should not exceed the number of logical CPU cores available, as having more workers than cores will not improve performance and may even degrade it due to context switching</li>
<li>I/O-bound tasks, more workers than CPU cores is probably a good idea, because I/O operations often block, allowing other workers to proceed with their tasks</li>
</ul>
<h3 id="result">Result</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:right">Mean [ms]</th>
<th style="text-align:right">Min [ms]</th>
<th style="text-align:right">Max [ms]</th>
<th style="text-align:right">Relative</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>tally .</code></td>
<td style="text-align:right">65.6 ± 6.1</td>
<td style="text-align:right">56.8</td>
<td style="text-align:right">85.1</td>
<td style="text-align:right">1.89 ± 0.33</td>
</tr>
<tr>
<td style="text-align:left"><code>tally_fanout .</code></td>
<td style="text-align:right">34.8 ± 5.2</td>
<td style="text-align:right">26.9</td>
<td style="text-align:right">53.2</td>
<td style="text-align:right">1.00</td>
</tr>
</tbody>
</table>
<p>Use <code>Fanout</code> pattern will speed up a lot.</p>
<h2 id="optimize4---use-pprof">Optimize4 - Use Pprof</h2>
<p>TODO...</p>
<h2 id="end">End</h2>
<p>The post is just a learning progress, you can find source code at <a href="https://github.com/abcdlsj/share/tree/master/go/tally">github - abcdlsj/tally</a></p>
<p>I'll do more test and optimize at the future.</p>
<h2 id="ref">Ref</h2>
<p><a href="https://github.com/boyter/scc/">https://github.com/boyter/scc/</a><br>
<a href="https://boyter.org/posts/sloc-cloc-code/">https://boyter.org/posts/sloc-cloc-code/</a><br>
<a href="https://blog.burntsushi.net/ripgrep/">https://blog.burntsushi.net/ripgrep/</a><br>
<a href="https://engineering.kablamo.com.au/posts/2021/quick-comparison-between-go-file-walk-implementations/">https://engineering.kablamo.com.au/posts/2021/quick-comparison-between-go-file-walk-implementations/</a></p>

            </div>
          </article>

          
          <!-- Table of Contents -->
          <aside class="toc-panel">
            <p class="toc-title">On this page</p>
            <nav class="toc-nav">
<li>
<ul>
<li>
<a href="#background">Background</a></li>
<li>
<a href="#steps">Steps</a><ul>
<li>
<a href="#walk-directory">Walk directory</a></li>
<li>
<a href="#read-and-count">Read and Count</a></li>
<li>
<a href="#output-style">Output style</a></li>
</ul>
</li>
<li>
<a href="#benchmark">Benchmark</a><ul>
<li>
<a href="#small-repo">Small repo</a></li>
<li>
<a href="#large-repo">Large repo</a></li>
</ul>
</li>
<li>
<a href="#optimize1---improve-the-code">Optimize1 - Improve the code</a><ul>
<li>
<a href="#compare">Compare</a></li>
</ul>
</li>
<li>
<a href="#optimize2---faster-filepath-walking">Optimize2 - Faster filepath walking</a></li>
<li>
<a href="#optimize3---parallelism">Optimize3 - Parallelism</a><ul>
<li>
<a href="#fanout">Fanout</a></li>
<li>
<a href="#result">Result</a></li>
</ul>
</li>
<li>
<a href="#optimize4---use-pprof">Optimize4 - Use Pprof</a></li>
<li>
<a href="#end">End</a></li>
<li>
<a href="#ref">Ref</a></li>
</ul>
</li>
</ul>
</nav>
          </aside>
          
        </div>

        <!-- Comments -->
        <section class="comments-section">
          <div id="disqus_thread"></div>
        </section>
      </main>
      
<footer class="footer">
  <div class="footer__inner">
    <p>© 2024 <a href="https://github.com/abcdlsj">abcdlsj</a></p>
    <p><a href="https://github.com/abcdlsj/abcdlsj.github.io">Source</a></p>
  </div>
</footer>

    </div>

    <button class="back-to-top" type="button" aria-label="Back to top" onclick="scrollToTop()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    </button>

    <script>
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      const backToTop = document.querySelector(".back-to-top");
      const toggleButton = () => {
        if (!backToTop) return;
        backToTop.classList.toggle("back-to-top--visible", window.scrollY > 400);
      };
      window.addEventListener("scroll", toggleButton);

      // Smooth scroll for TOC links
      document.addEventListener('DOMContentLoaded', function() {
        const tocLinks = document.querySelectorAll('.toc-nav a');
        tocLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth' });
            }
          });
        });

        // TOC scroll tracking
        const tocNav = document.querySelector('.toc-nav');
        if (tocNav) {
          const headings = document.querySelectorAll('.post-body h2, .post-body h3');
          const tocLinks = Array.from(tocNav.querySelectorAll('a'));
          
          function updateActiveHeading() {
            let activeId = '';
            
            // Find the heading currently in view
            for (let i = 0; i < headings.length; i++) {
              const rect = headings[i].getBoundingClientRect();
              if (rect.top <= 150) {  // 150px from top
                activeId = headings[i].id;
              }
            }
            
            // Update TOC active state
            tocLinks.forEach(link => {
              link.classList.remove('active');
              if (link.getAttribute('href') === '#' + activeId) {
                link.classList.add('active');
              }
            });
          }
          
          // Throttle scroll events for performance
          let ticking = false;
          window.addEventListener('scroll', function() {
            if (!ticking) {
              requestAnimationFrame(function() {
                updateActiveHeading();
                ticking = false;
              });
              ticking = true;
            }
          });
          
          // Initial call
          updateActiveHeading();
        }
      });

      // Disqus
      (function() {
        var d = document, s = d.createElement("script");
        s.src = "https://abcdlsj.disqus.com/embed.js";
        s.setAttribute("data-timestamp", +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </body>
</html>
